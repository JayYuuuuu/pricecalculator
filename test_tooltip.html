<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浮窗功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .metric-cell {
            display: inline-block;
            padding: 10px 15px;
            margin: 5px;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            cursor: help;
            color: #1976d2;
            font-weight: bold;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>浮窗功能测试页面</h1>
        
        <div class="test-section">
            <div class="test-title">测试1: 平均加价率</div>
            <div class="metric-cell" 
                 data-metric="markup" 
                 data-scope="overall" 
                 data-overview='{"count": 25, "avgMarkupRate": 2.15}'>
                2.15倍
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试2: 平均毛利率</div>
            <div class="metric-cell" 
                 data-metric="gross" 
                 data-scope="淘宝" 
                 data-overview='{"count": 15, "avgGrossMargin": 0.5349}'>
                53.49%
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试3: 平均退货率</div>
            <div class="metric-cell" 
                 data-metric="return" 
                 data-scope="天猫" 
                 data-overview='{"count": 10, "avgReturnRate": 0.1234}'>
                12.34%
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试4: 平均保本ROI</div>
            <div class="metric-cell" 
                 data-metric="roi" 
                 data-scope="抖音" 
                 data-overview='{"count": 8, "avgBreakevenROI": 4.67}'>
                4.67
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试5: 平均保本广告占比</div>
            <div class="metric-cell" 
                 data-metric="adrate" 
                 data-scope="overall" 
                 data-overview='{"count": 25, "avgBreakevenAdRate": 0.1875, "riskProductCount": 3}'>
                18.75%
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">使用说明</div>
            <p>将鼠标悬停在任意指标数值上，应该会显示详细的计算过程说明浮窗。</p>
            <p>如果浮窗没有显示，请检查浏览器控制台是否有错误信息。</p>
        </div>
    </div>

    <script>
        // 格式化函数
        function formatMarkupRate(rate) {
            if (!isFinite(rate) || rate <= 0) return '-';
            return rate.toFixed(2) + '倍';
        }
        
        function formatPercentage(rate) {
            if (!isFinite(rate)) return '-';
            return (rate * 100).toFixed(2) + '%';
        }
        
        function formatROI(roi) {
            if (!isFinite(roi) || roi <= 0) return '-';
            if (roi === Infinity) return '∞';
            return roi.toFixed(2);
        }
        
        // 显示指标计算过程浮窗
        function showMetricTooltipFromData(event) {
            const target = event.currentTarget;
            const metricType = target.getAttribute('data-metric');
            const scope = target.getAttribute('data-scope');
            const overviewData = target.getAttribute('data-overview');
            
            if (!metricType || !scope || !overviewData) {
                console.error('缺少必要的data属性:', { metricType, scope, overviewData });
                return;
            }
            
            // 移除已存在的浮窗
            hideMetricTooltip();
            
            // 解析数据
            let parsedData;
            try {
                parsedData = JSON.parse(overviewData);
            } catch (error) {
                console.error('解析指标数据失败:', error);
                return;
            }
            
            // 根据指标类型生成不同的计算过程说明
            let tooltipContent = '';
            let tooltipTitle = '';
            
            if (metricType === 'markup') {
                tooltipTitle = '平均加价率计算过程';
                tooltipContent = `平均加价率 = 所有商品加价率的总和 ÷ 有效商品数量

计算逻辑：
• 加价率 = 售价 ÷ 进货价
• 优先使用多档售价的第一档，否则使用单一售价
• 优先使用多档进货价的第一档，否则使用单一进货价
• 过滤掉售价或进货价无效的商品

当前数据：
• 有效商品数量：${parsedData.count || '未知'}
• 平均加价率：${formatMarkupRate(parsedData.avgMarkupRate)}
• 计算范围：${scope === 'overall' ? '整体' : scope}`;
            } else if (metricType === 'gross') {
                tooltipTitle = '平均毛利率计算过程';
                tooltipContent = `平均毛利率 = 所有商品毛利率的总和 ÷ 有效商品数量

计算逻辑：
• 毛利率 = (售价 - 进货价) ÷ 售价 × 100%
• 优先使用多档售价的第一档，否则使用单一售价
• 优先使用多档进货价的第一档，否则使用单一进货价
• 过滤掉售价或进货价无效的商品

当前数据：
• 有效商品数量：${parsedData.count || '未知'}
• 平均毛利率：${formatPercentage(parsedData.avgGrossMargin)}
• 计算范围：${scope === 'overall' ? '整体' : scope}`;
            } else if (metricType === 'return') {
                tooltipTitle = '平均退货率计算过程';
                tooltipContent = `平均退货率 = 所有商品退货率的总和 ÷ 有效商品数量

计算逻辑：
• 退货率支持多种格式：百分比字符串（如"12%"）、小数（如0.12）、数值（如12）
• 系统自动统一转换为小数格式进行计算
• 过滤掉退货率无效的商品

当前数据：
• 有效商品数量：${parsedData.count || '未知'}
• 平均退货率：${formatPercentage(parsedData.avgReturnRate)}
• 计算范围：${scope === 'overall' ? '整体' : scope}`;
            } else if (metricType === 'roi') {
                tooltipTitle = '平均保本ROI计算过程';
                tooltipContent = `平均保本ROI = 所有商品保本ROI的总和 ÷ 有效商品数量

计算逻辑：
• 使用系统现有的保本ROI计算函数
• 默认参数：开票成本6%、进项税率13%、销项税率13%
• 物流成本2.8元/单、运费险1.5元/单、其他成本2.5元/单
• 平台佣金率根据平台名称自动获取
• 过滤掉计算结果无效的商品

当前数据：
• 有效商品数量：${parsedData.count || '未知'}
• 平均保本ROI：${formatROI(parsedData.avgBreakevenROI)}
• 计算范围：${scope === 'overall' ? '整体' : scope}`;
            } else if (metricType === 'adrate') {
                tooltipTitle = '平均保本广告占比计算过程';
                tooltipContent = `平均保本广告占比 = 所有商品保本广告占比的总和 ÷ 有效商品数量

计算逻辑：
• 使用系统现有的保本ROI计算逻辑
• 默认参数：开票成本6%、进项税率13%、销项税率13%
• 物流成本2.8元/单、运费险1.5元/单、其他成本2.5元/单
• 平台佣金率根据平台名称自动获取
• 过滤掉计算结果无效的商品
• 风险识别：保本广告占比 < 21% 的商品标记为风险商品

当前数据：
• 有效商品数量：${parsedData.count || '未知'}
• 平均保本广告占比：${formatPercentage(parsedData.avgBreakevenAdRate)}
• 风险商品数量：${parsedData.riskProductCount || 0}
• 计算范围：${scope === 'overall' ? '整体' : scope}`;
            }
            
            // 创建浮窗元素
            const tooltip = document.createElement('div');
            tooltip.id = 'metric-tooltip';
            
            // 设置浮窗样式
            Object.assign(tooltip.style, {
                position: 'fixed',
                zIndex: '10002',
                padding: '12px 16px',
                borderRadius: '8px',
                background: 'rgba(17,24,39,0.95)',
                color: '#fff',
                fontSize: '13px',
                lineHeight: '1.5',
                boxShadow: '0 8px 25px rgba(0,0,0,0.3)',
                pointerEvents: 'none',
                whiteSpace: 'pre-line',
                transition: 'opacity .15s ease',
                opacity: '0',
                maxWidth: '450px',
                border: '1px solid rgba(255,255,255,0.1)'
            });
            
            // 设置浮窗内容
            tooltip.innerHTML = `${tooltipTitle}

${tooltipContent}`;
            
            // 添加到页面
            document.body.appendChild(tooltip);
            
            // 显示浮窗并设置位置
            displayMetricTooltip(event, tooltip);
            
            // 为当前元素添加鼠标移动事件，实现跟随鼠标移动
            const currentElement = event.currentTarget;
            
            // 鼠标移动事件（更新浮层位置）
            const mousemoveHandler = (e) => {
                updateMetricTooltipPosition(e, tooltip);
            };
            
            // 鼠标离开事件
            const mouseleaveHandler = () => {
                hideMetricTooltip();
                // 清理事件监听器
                currentElement.removeEventListener('mousemove', mousemoveHandler);
                currentElement.removeEventListener('mouseleave', mouseleaveHandler);
            };
            
            // 添加事件监听器
            currentElement.addEventListener('mousemove', mousemoveHandler);
            currentElement.addEventListener('mouseleave', mouseleaveHandler);
        }
        
        // 隐藏指标计算过程浮窗
        function hideMetricTooltip() {
            const tooltip = document.getElementById('metric-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }
        
        // 显示指标浮窗并设置初始位置
        function displayMetricTooltip(event, tooltip) {
            // 设置初始位置
            updateMetricTooltipPosition(event, tooltip);
            
            // 显示浮窗
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 10);
        }
        
        // 更新指标浮窗位置
        function updateMetricTooltipPosition(event, tooltip) {
            const rect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // 计算最佳位置（避免超出视口）
            let left = event.clientX + 15;
            let top = event.clientY - rect.height - 10;
            
            // 如果上方空间不足，显示在下方
            if (top < 10) {
                top = event.clientY + 15;
            }
            
            // 如果右侧空间不足，显示在左侧
            if (left + rect.width > viewportWidth - 20) {
                left = event.clientX - rect.width - 15;
            }
            
            // 确保不超出左边界
            if (left < 10) {
                left = 10;
            }
            
            // 确保不超出下边界
            if (top + rect.height > viewportHeight - 20) {
                top = viewportHeight - rect.height - 20;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
        
        // 页面加载完成后绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            const metricCells = document.querySelectorAll('[data-metric]');
            metricCells.forEach(cell => {
                cell.addEventListener('mouseenter', showMetricTooltipFromData);
                cell.addEventListener('mouseleave', hideMetricTooltip);
            });
            
            console.log('浮窗功能已初始化，找到', metricCells.length, '个指标单元格');
        });
    </script>
</body>
</html>
