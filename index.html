<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>电商合理售价计算器（税务合规版）</title>
    <style>
        /* Tab切换样式 */
        .tab-container {
            margin-bottom: 2rem;
        }
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #d2d2d7;
            padding-bottom: 0.5rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: none;
            border: none;
            color: #666;
        }
        .tab:hover {
            background: #f5f5f7;
            color: #1d1d1f;
        }
        .tab.active {
            background: #0066cc;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* 现代化的UI样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f5f5f7;
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 
                       0 8px 24px rgba(0, 0, 0, 0.04);
        }
        h2 {
            color: #1d1d1f;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 500;
        }
        .section {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .section h3 {
            color: #1d1d1f;
            font-size: 1.1rem;
            margin: 0 0 1.5rem 0;
            font-weight: 500;
        }
        .input-groups-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        .input-group {
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        label {
            display: block;
            margin-bottom: 0.35rem;
            color: #1d1d1f;
            font-weight: 400;
            font-size: 0.9rem;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: #fafafa;
            margin-right: 8px;
        }
        input:focus {
            border-color: #0066cc;
            outline: none;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
        }
        .field-hint {
            font-size: 0.8rem;
            color: #86868b;
            margin-top: 0.25rem;
            line-height: 1.2;
        }
        button {
            width: auto;
            padding: 0.75rem 1.5rem;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 1.5rem auto;
            display: block;
        }
        button:hover {
            background-color: #0077ed;
        }
        .result {
            margin-top: 2rem;
            font-size: 1rem;
        }
        .final-price {
            text-align: center;
            background: #f5f5f7;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .final-price .price-label {
            font-size: 1.2rem;
            color: #1d1d1f;
            margin-bottom: 1rem;
        }
        .final-price .price-value {
            font-size: 2.5rem;
            font-weight: 600;
            color: #0066cc;
        }
        .calculation-process {
            margin-top: 2rem;
            background: #ffffff;
        }
        .result .section {
            margin-bottom: 1.5rem;
        }
        .result .section h3 {
            color: #1d1d1f;
            font-size: 1rem;
            margin: 0 0 1rem 0;
            font-weight: 500;
        }
        .result ul {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
            list-style-type: none;
        }
        .result ul li {
            margin: 0.4rem 0;
            position: relative;
        }
        .result ul li:before {
            content: "•";
            color: #86868b;
            position: absolute;
            left: -1rem;
        }
        .result ul ul {
            margin: 0.35rem 0 0.35rem 0.5rem;
            color: #515154;
        }
        .result ul ul li:before {
            content: "◦";
        }
        .error {
            color: #ff3b30;
            padding: 1rem;
            background-color: #fff2f2;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.95rem;
        }
        .description {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #86868b;
            padding: 1rem;
            background-color: #f5f5f7;
            border-radius: 6px;
        }
        .step-description {
            margin-bottom: 1.5rem;
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .cost-category {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #e6e6e6;
        }
        .category-title {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .summary-title {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .field-hint {
            color: #666;
            line-height: 1.4;
        }
        .price-hint {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        /* 价格构成分析样式 */
        .price-composition {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }
        .price-composition .composition-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        /* 利润构成分析样式 */
        .profit-composition {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }
        .profit-composition .composition-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .profit-composition .composition-item.revenue {
            grid-column: span 3;
        }
        .profit-composition .composition-item.cost {
            grid-column: span 3;
        }
        .profit-composition .composition-item.expenses {
            grid-column: span 3;
        }
        .profit-composition .composition-item.tax {
            grid-column: span 3;
        }
        .composition-item.profit {
            background: #e8f5e9;
        }
        .item-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .item-value {
            font-size: 1.2rem;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 0.25rem;
        }
        .item-percent {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .tax-detail {
            border-top: 1px dashed #e0e0e0;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        .tax-item {
            color: #666;
            margin: 0.2rem 0;
            display: flex;
            justify-content: space-between;
        }
        .tax-item:last-child {
            color: #2ea44f;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        .cost-detail {
            border-top: 1px dashed #e0e0e0;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        .cost-item {
            color: #666;
            margin: 0.2rem 0;
            display: flex;
            justify-content: space-between;
        }
        .price-note {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #fff3e0;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #e65100;
        }
        .calculation-note {
            font-size: 0.85rem;
            color: #515154;
            margin-top: 1rem;
            border-top: 1px solid #d2d2d7;
            padding-top: 1rem;
        }
        /* 计算步骤样式 */
        .calculation-steps {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .step-header {
            font-size: 1rem;
            color: #1d1d1f;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .step-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .step-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e6e6e6;
        }
        .cost-table {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .table-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 1rem;
        }
        .section-note {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #fff3e0;
            border-radius: 4px;
        }
        .cost-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .cost-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .cost-table td:last-child {
            text-align: right;
        }
        .cost-table .formula {
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }
        .cost-table .amount {
            font-weight: 500;
            color: #1d1d1f;
        }
        .cost-table .total {
            background: #f8f9fa;
            font-weight: 500;
        }
        .total-amount {
            font-size: 1.2rem;
            font-weight: 500;
            color: #2ea44f;
            text-align: right;
        }
        .note {
            font-size: 0.8rem;
            color: #666;
            font-weight: normal;
        }
        .formula-box {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .formula-title {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 1rem;
        }
        .formula-content {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #1d1d1f;
        }
        .formula-note {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #666;
        }
        .calculation-details table {
            width: 100%;
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .calculation-details td {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }
        .detail-items {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
        }
        .final-calculation {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .calc-step {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.75rem;
        }
        .calc-result {
            font-size: 1.1rem;
            font-weight: 500;
            color: #2ea44f;
        }
        .final-price-calc {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .calc-formula {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 1rem;
        }
        /* 销售成本分析样式 */
        .sales-cost-analysis {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .analysis-header {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            line-height: 1.5;
        }
        .cost-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .cost-item {
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 1rem;
        }
        .cost-title {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 0.75rem;
        }
        .cost-details {
            margin-left: 1.5rem;
        }
        .detail-row {
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
            font-size: 0.9rem;
        }
        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        .cost-formula {
            color: #666;
            font-size: 0.9rem;
        }
        .total-cost {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .total-value {
            color: #2ea44f;
            font-size: 1.1rem;
        }
        .save-button {
            background: none;
            color: #0066cc;
            border: none;
            padding: 0.25rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color 0.2s ease;
            width: auto;
            margin: 0;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .save-button:hover {
            color: #0077ed;
            background: none;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-size: 0.9rem;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .toast-hide {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>电商合理售价计算器（税务合规版）</h2>
        
        <div class="tab-container">
            <div class="tabs">
                <button class="tab" onclick="switchTab('price')">售价计算</button>
                <button class="tab active" onclick="switchTab('profit')">利润计算</button>
            </div>
        </div>

        <!-- 售价计算tab -->
        <div id="priceTab" class="tab-content">
            <div class="section">
                <h3>第一步：基础成本</h3>
                <div class="step-description">
                    这部分是您需要支付给供应商的费用，包括商品本身的成本和相关税费。
                </div>
                <div class="input-groups-container">
                    <div class="input-group">
                        <label>进货价（不含税）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="costPrice" value="100" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">这是供应商提供的不含税商品价格</div>
                    </div>

                    <div class="input-group">
                        <label>开票成本（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="inputTaxRate" value="6" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">供应商开具发票时收取的额外费用比例（通常是6%）</div>
                    </div>

                    <div class="input-group">
                        <label>商品税率（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="outputTaxRate" value="13" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">商品的增值税税率（如服装类13%），这部分税费将来可以抵扣</div>
                    </div>
                </div>
                
                <div class="cost-summary" id="purchaseCostSummary" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div class="summary-title">成本计算结果</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>实际支付总额：</span>
                        <span id="totalPayment" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #2ea44f;">
                        <span>税后实际成本：</span>
                        <span id="effectiveCost" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div class="field-hint" style="margin-top: 0.5rem; font-size: 0.8rem;">
                        <div>• 实际支付总额 = 进货价 + 开票费用</div>
                        <div>• 税后实际成本 = 实际支付总额 - 可抵扣进项税</div>
                        <div>• 可抵扣进项税在销售时可以抵减应缴税款，相当于未来的税收优惠</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>第二步：销售环节费用</h3>
                <div class="step-description">
                    这部分是在销售过程中产生的各项费用，包括平台费用、物流费用和营销费用。
                </div>
                <div class="input-groups-container">
                    <div class="cost-category">
                        <div class="category-title">平台费用</div>
                        <div class="input-group">
                            <label>平台抽佣比例（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="platformRate" value="5.5" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">电商平台收取的交易佣金，基于最终售价（含税）计算</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">物流费用</div>
                        <div class="input-group">
                            <label>物流费（元/单）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="shippingCost" value="2.8" step="0.01">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">每个订单的快递费用</div>
                        </div>

                        <div class="input-group">
                            <label>运费险（元/单）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="shippingInsurance" value="1.5" step="0.01">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">每个订单的运费险费用</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">营销费用</div>
                        <div class="input-group">
                            <label>广告费用比例（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="adRate" value="30" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">广告费占最终售价的比例，可开具6%专票抵扣税款</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">其他费用</div>
                        <div class="input-group">
                            <label>其他成本（元/单）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="otherCost" value="2.5" step="0.01">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">包装材料等其他固定成本</div>
                        </div>

                        <div class="input-group">
                            <label>销项税率（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="salesTaxRate" value="13" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">销项税率（如13%）。注意：销项税不是直接用含税价×13%，而是要先去税，即：含税价÷1.13×13%</div>
                        </div>
                    </div>
                </div>
                
                <div class="cost-summary" id="salesCostSummary" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>固定成本（含退货分摊）：</span>
                        <span id="totalFixedCost" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>平台佣金：</span>
                        <span id="platformFeePreview" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>广告费：</span>
                        <span id="adCostPreview" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>销项税（13%）：</span>
                        <span id="salesTax" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #2ea44f;">
                        <span>总销售成本：</span>
                        <span id="totalSalesCost" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div class="field-hint" style="margin-top: 0.5rem; font-size: 0.8rem;">
                        总销售成本 = 固定成本 + 平台佣金 + 广告费 + 销项税（基于最终售价）
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>第三步：目标设定</h3>
                <div class="step-description">
                    设置您的经营目标和风险预期，这将影响最终售价的计算。
                </div>
                <div class="input-groups-container">
                    <div class="cost-category">
                        <div class="category-title">经营目标</div>
                        <div class="input-group">
                            <label>目标利润率（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="targetProfitRate" value="8" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">您期望的利润率，基于最终售价计算（例：8%意味着每100元售价中有8元是利润）</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">风险预期</div>
                        <div class="input-group">
                            <label>预计退货率（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="returnRate" value="20" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">预计的退货率，影响成本分摊（例：20%意味着每100单中有20单会退货）</div>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- 结束售价计算tab -->

        <!-- 利润计算tab -->
        <div id="profitTab" class="tab-content active">
            <div class="section">
                <h3>利润计算</h3>
                <div class="step-description">
                    输入商品的进货价和实际售价，计算各项成本和最终利润。
                </div>
                <div class="input-groups-container">
                    <div class="input-group">
                        <label>进货价（不含税）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="profitCostPrice" value="100" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">这是供应商提供的不含税商品价格</div>
                    </div>

                    <div class="input-group">
                        <label>实际售价（含税）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="actualPrice" value="200" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">实际销售时的含税价格</div>
                    </div>

                    <div class="input-group">
                        <label>实际利润:</label>
                        <div class="input-wrapper" style="position: relative;">
                            <input type="text" id="actualProfit" readonly style="background-color: #f8f9fa; cursor: default;">
                            <div id="profitRate" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #2ea44f; font-size: 0.9rem;"></div>
                        </div>
                        <div class="field-hint" style="display: flex; justify-content: space-between;">
                            <span>计算得出的实际利润金额</span>
                            <span id="profitStatus" style="font-weight: 500;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                #actualProfit {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    font-weight: 500;
                }
                #actualProfit.profit-positive {
                    color: #2ea44f;
                }
                #actualProfit.profit-negative {
                    color: #e65100;
                }
                #profitStatus.status-good {
                    color: #2ea44f;
                }
                #profitStatus.status-bad {
                    color: #e65100;
                }
                #profitStatus.status-warning {
                    color: #f59e0b;
                }
            </style>

            <div class="section">
                <h3>费用设置</h3>
                <div class="step-description">
                    设置各项费用参数，这些参数将影响最终的利润计算。
                </div>
                <div class="input-groups-container">
                    <div class="cost-category">
                        <div class="category-title">税费设置</div>
                        <div class="input-group">
                            <label>开票成本（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitInputTaxRate" value="6" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">供应商开具发票时收取的额外费用比例（通常是6%）</div>
                        </div>

                        <div class="input-group">
                            <label>商品进项税率（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitOutputTaxRate" value="13" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">商品的进项税率，用于计算可抵扣的进项税额（如服装类13%）</div>
                        </div>

                        <div class="input-group">
                            <label>销项税率（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitSalesTaxRate" value="13" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">销售时的增值税税率，通常与商品进项税率相同（如13%）</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">平台费用</div>
                        <div class="input-group">
                            <label>平台抽佣比例（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitPlatformRate" value="5.5" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">电商平台收取的交易佣金，基于最终售价（含税）计算。平台开具6%专票，可抵扣进项税。</div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f7ff; border-radius: 4px; font-size: 0.85rem; color: #2ea44f;">
                            💡 提示：平台佣金可以获得6%的进项税抵扣，这部分抵扣会降低实际成本。
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">物流费用</div>
                        <div class="input-group">
                            <label>物流费（元/单）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitShippingCost" value="2.8" step="0.01">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">每个订单的快递费用</div>
                        </div>

                        <div class="input-group">
                            <label>运费险（元/单）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitShippingInsurance" value="1.5" step="0.01">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">每个订单的运费险费用</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">营销费用</div>
                        <div class="input-group">
                            <label>广告费用比例（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitAdRate" value="30" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">广告费占最终售价的比例，广告服务商开具6%专票，可抵扣进项税。</div>
                        </div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f7ff; border-radius: 4px; font-size: 0.85rem; color: #2ea44f;">
                            💡 提示：广告费用可以获得6%的进项税抵扣。由于广告费金额较大，这部分抵扣会显著降低实际营销成本。
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">其他费用</div>
                        <div class="input-group">
                            <label>其他成本（元/单）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitOtherCost" value="2.5" step="0.01">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">包装材料等其他固定成本</div>
                        </div>
                    </div>

                    <div class="cost-category">
                        <div class="category-title">风险预期</div>
                        <div class="input-group">
                            <label>预计退货率（%）:</label>
                            <div class="input-wrapper">
                                <input type="number" id="profitReturnRate" value="20" step="0.1">
                                <button class="save-button" onclick="saveInputs()">保存</button>
                            </div>
                            <div class="field-hint">预计的退货率，影响成本分摊（例：20%意味着每100单中有20单会退货）</div>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="calculateProfit()">计算利润</button>
        </div>

        <div class="result" id="result"></div>
        
        <div class="description">
            <p>计算说明：</p>
            <ul>
                <li>进货价请填写不含税价格</li>
                <li>开票成本是供应商收取的开票费用比例（如6%）</li>
                <li>销项税率用于计算可抵扣的进项税额（如服装类目13%）</li>
                <li>计算结果已考虑开票成本、税费抵扣、平台抽佣等</li>
                <li>目标利润率基于最终售价计算</li>
            </ul>

            <p style="margin-top: 1.5rem; color: #0066cc;">重要提示：关于利润率计算</p>
            <ul style="color: #666;">
                <li>售价计算模块：
                    <ul>
                        <li>目标利润率是针对有效订单（扣除退货后）的利润率</li>
                        <li>系统会提高售价来补偿退货带来的损失</li>
                        <li>确保有效订单能达到设定的目标利润率</li>
                    </ul>
                </li>
                <li>利润计算模块：
                    <ul>
                        <li>显示整体业务的实际利润率（包含所有订单）</li>
                        <li>通常会高于售价计算的目标利润率</li>
                        <li>这是正常现象，因为售价中包含了退货补偿</li>
                    </ul>
                </li>
                <li>建议：
                    <ul>
                        <li>同时参考两个模块来评估定价策略</li>
                        <li>可以通过调整目标利润率来达到理想的整体利润水平</li>
                        <li>定期根据实际运营数据调整参数设置</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // Tab切换功能
        function switchTab(tabName) {
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有tab按钮的active状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的tab内容
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 设置选中tab按钮的active状态
            event.target.classList.add('active');
            
            // 清空结果区域
            document.getElementById('result').innerHTML = '';
        }

        /**
         * 计算实际利润的主函数
         * 
         * 重要说明：利润计算模块与售价计算模块的差异
         * 1. 利润计算模块（本函数）
         *    - 目的：计算实际经营的整体利润率
         *    - 原理：基于实际售价，计算所有订单的平均利润率
         *    - 特点：显示的利润率通常会高于售价计算模块的目标利润率
         *    - 例如：如果售价是基于8%目标利润率计算的：
         *      · 由于售价中包含了退货补偿
         *      · 实际利润率可能会达到12-15%
         * 
         * 2. 与售价计算模块的区别
         *    - 利润计算：展示整体业务表现（所有订单的平均结果）
         *    - 售价计算：关注单个有效订单的目标利润（扣除退货影响）
         *    - 差异原因：售价计算模块会提高价格来补偿退货损失
         * 
         * 3. 实际应用说明
         *    - 此模块适合评估实际经营效果
         *    - 可以用来验证定价策略的实际效果
         *    - 帮助理解退货率对整体利润的影响
         *    - 建议同时参考两个模块来制定定价策略
         */
        function calculateProfit() {
            try {
                // 获取基础输入
                const costPrice = validateInput(parseFloat(document.getElementById('profitCostPrice').value), 0.01, 1000000, "进货价");
                const actualPrice = validateInput(parseFloat(document.getElementById('actualPrice').value), 0.01, 1000000, "实际售价");
                const inputTaxRate = validateInput(parseFloat(document.getElementById('profitInputTaxRate').value), 0, 100, "开票成本") / 100;
                const outputTaxRate = validateInput(parseFloat(document.getElementById('profitOutputTaxRate').value), 0, 100, "商品进项税率") / 100;
                const salesTaxRate = validateInput(parseFloat(document.getElementById('profitSalesTaxRate').value), 0, 100, "销项税率") / 100;
                const platformRate = validateInput(parseFloat(document.getElementById('profitPlatformRate').value), 0, 100, "平台抽佣比例") / 100;
                const shippingCost = validateInput(parseFloat(document.getElementById('profitShippingCost').value), 0, 10000, "物流费");
                const shippingInsurance = validateInput(parseFloat(document.getElementById('profitShippingInsurance').value), 0, 100, "运费险");
                const adRate = validateInput(parseFloat(document.getElementById('profitAdRate').value), 0, 100, "广告费用比例") / 100;
                const otherCost = validateInput(parseFloat(document.getElementById('profitOtherCost').value), 0, 10000, "其他成本");
                const returnRate = validateInput(parseFloat(document.getElementById('profitReturnRate').value), 0, 100, "退货率") / 100;

                // 计算进货成本
                const invoiceCost = costPrice * inputTaxRate; // 开票成本
                const totalPurchaseCost = costPrice + invoiceCost; // 总进货成本
                const purchaseVAT = costPrice * outputTaxRate; // 进项税额
                const effectiveCost = totalPurchaseCost - purchaseVAT; // 税后实际成本

                // 计算有效销售率
                const effectiveRate = 1 - returnRate;

                // 计算销售相关费用（考虑退货率）
                const platformFee = actualPrice * platformRate; // 平台佣金（可退回）
                const adCost = actualPrice * adRate; // 广告费（不可退回，需分摊）
                const adCostEffective = adCost / effectiveRate; // 分摊后的广告费
                const adVAT = adCostEffective * 0.06; // 广告费可抵扣进项税（6%）
                
                // 运营成本（不可退回，需分摊）
                const operationalCostBase = shippingCost + shippingInsurance + otherCost;
                const operationalCost = operationalCostBase / effectiveRate;

                // 计算销项税
                const netPrice = actualPrice / (1 + salesTaxRate); // 不含税售价
                const outputVAT = netPrice * salesTaxRate; // 销项税额

                // 计算总可抵扣进项税
                const totalVATDeduction = purchaseVAT + adVAT + (platformFee * 0.06); // 商品+广告+平台佣金的进项税
                const actualVAT = outputVAT - totalVATDeduction; // 实际应缴税额

                // 计算总成本（考虑退货分摊）
                const totalCost = effectiveCost + platformFee + adCostEffective + operationalCost + actualVAT;

                // 计算利润
                const profit = actualPrice - totalCost;
                const profitRate = (profit / actualPrice * 100).toFixed(2);

                // 更新实时利润显示
                const actualProfitInput = document.getElementById('actualProfit');
                const profitRateDisplay = document.getElementById('profitRate');
                const profitStatus = document.getElementById('profitStatus');

                // 设置利润金额和样式
                actualProfitInput.value = `¥ ${profit.toFixed(2)}`;
                actualProfitInput.className = profit >= 0 ? 'profit-positive' : 'profit-negative';

                // 设置利润率
                profitRateDisplay.textContent = `${profitRate}%`;

                // 设置状态提示
                let statusText = '';
                let statusClass = '';
                if (profit < 0) {
                    statusText = '亏损';
                    statusClass = 'status-bad';
                } else if (profitRate < 5) {
                    statusText = '利润率过低';
                    statusClass = 'status-warning';
                } else if (profitRate > 30) {
                    statusText = '利润率优秀';
                    statusClass = 'status-good';
                } else {
                    statusText = '利润率正常';
                    statusClass = 'status-good';
                }
                profitStatus.textContent = statusText;
                profitStatus.className = statusClass;

                // 生成结果HTML
                const resultHtml = `
                    <div class="final-price">
                        <div class="price-label">实际利润</div>
                        <div class="price-value">¥ ${profit.toFixed(2)}</div>
                        <div class="price-hint">利润率：${profitRate}%</div>
                    </div>

                    <div class="section calculation-process">
                        <h3>利润构成分析</h3>
                        <div class="profit-composition">
                            <div class="composition-item revenue">
                                <div class="item-label">销售收入</div>
                                <div class="item-value">¥ ${actualPrice.toFixed(2)}</div>
                                <div class="item-percent">100%</div>
                            </div>
                            <div class="composition-item cost">
                                <div class="item-label">基础成本</div>
                                <div class="item-value">¥ ${effectiveCost.toFixed(2)}</div>
                                <div class="item-percent">${(effectiveCost/actualPrice*100).toFixed(1)}%</div>
                                <div class="cost-detail" style="text-align: left;">
                                    <div class="cost-item">
                                        进货价（不含税）：¥ ${costPrice.toFixed(2)}
                                    </div>
                                    <div style="margin: 0.5rem 0; padding: 0.5rem 0; border-top: 1px dashed #e0e0e0; border-bottom: 1px dashed #e0e0e0;">
                                        <div class="cost-item">
                                            开票成本（${(inputTaxRate*100).toFixed(1)}%）：¥ ${(costPrice * inputTaxRate).toFixed(2)}
                                        </div>
                                        <div class="cost-item" style="color: #2ea44f; margin-top: 0.5rem;">
                                            可抵扣商品税（${(outputTaxRate*100).toFixed(0)}%）：¥ ${purchaseVAT.toFixed(2)}
                                        </div>
                                    </div>
                                    <div class="cost-item" style="font-weight: 500;">
                                        税后实际成本：¥ ${effectiveCost.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #e0e0e0;">
                                        计算过程：进货价 + 开票成本 - 可抵扣商品税
                                    </div>
                                </div>
                            </div>
                            <div class="composition-item expenses">
                                <div class="item-label">销售费用</div>
                                <div class="item-value">¥ ${(platformFee + operationalCost + adCostEffective).toFixed(2)}</div>
                                <div class="item-percent">${((platformFee + operationalCost + adCostEffective)/actualPrice*100).toFixed(1)}%</div>
                                <div class="cost-detail" style="text-align: left;">
                                    <div class="cost-item">平台佣金（可退回）：¥ ${platformFee.toFixed(2)}</div>
                                    <div class="cost-item">广告费用（分摊后）：¥ ${adCostEffective.toFixed(2)}</div>
                                    <div class="cost-item">物流及其他（分摊后）：¥ ${operationalCost.toFixed(2)}</div>
                                    <div class="cost-item" style="color: #666; font-size: 0.85rem;">
                                        注：不可退回费用已按退货率${(returnRate*100).toFixed(0)}%分摊
                                    </div>
                                </div>
                            </div>
                            <div class="composition-item tax" style="background: #f0f7ff;">
                                <div class="item-label">税费分析</div>
                                <div class="item-value">¥ ${actualVAT.toFixed(2)}</div>
                                <div class="item-percent">${(actualVAT/actualPrice*100).toFixed(1)}%</div>
                                <div class="cost-detail" style="text-align: left;">
                                    <div class="cost-item" style="color: #e65100;">
                                        应缴销项税：¥ ${outputVAT.toFixed(2)} (${(outputVAT/actualPrice*100).toFixed(1)}%)
                                    </div>
                                    <div style="margin: 0.5rem 0; padding: 0.5rem 0; border-top: 1px dashed #e0e0e0; border-bottom: 1px dashed #e0e0e0;">
                                        <div class="cost-item" style="color: #2ea44f;">
                                            可抵扣进项税：¥ ${totalVATDeduction.toFixed(2)} (${(totalVATDeduction/actualPrice*100).toFixed(1)}%)
                                        </div>
                                        <div style="margin-top: 0.5rem; padding-left: 1rem; font-size: 0.85rem; color: #666;">
                                            <div class="cost-item">• 商品进项税：¥${purchaseVAT.toFixed(2)}</div>
                                            <div class="cost-item">• 广告费进项税：¥${adVAT.toFixed(2)}</div>
                                            <div class="cost-item">• 平台佣金进项税：¥${(platformFee * 0.06).toFixed(2)}</div>
                                        </div>
                                    </div>
                                    <div class="cost-item" style="font-weight: 500;">
                                        实际应缴税费：¥ ${actualVAT.toFixed(2)} (${(actualVAT/actualPrice*100).toFixed(1)}%)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="calculation-steps">
                            <div class="step-header">详细成本分析：</div>
                            
                            <div class="step-section">
                                <div class="step-title">1. 进货成本分析</div>
                                <div class="cost-table">
                                    <table>
                                        <tr>
                                            <td>进货价（不含税）</td>
                                            <td class="amount">${costPrice.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>开票费用（${(inputTaxRate*100).toFixed(1)}%）</td>
                                            <td class="amount">${invoiceCost.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>进项税额（${(outputTaxRate*100).toFixed(1)}%）</td>
                                            <td class="amount">${purchaseVAT.toFixed(2)}元</td>
                                        </tr>
                                        <tr class="total">
                                            <td>税后实际成本</td>
                                            <td class="amount">${effectiveCost.toFixed(2)}元</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="step-section">
                                <div class="step-title">2. 销售费用分析</div>
                                <div class="cost-table">
                                    <table>
                                        <tr>
                                            <td>平台佣金（${(platformRate*100).toFixed(1)}%，可退回）</td>
                                            <td class="amount">${platformFee.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>广告费用（${(adRate*100).toFixed(1)}%）</td>
                                            <td class="formula">${adCost.toFixed(2)} ÷ ${(effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${adCostEffective.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>物流费用</td>
                                            <td class="formula">${shippingCost.toFixed(2)} ÷ ${(effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${(shippingCost/effectiveRate).toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>运费险</td>
                                            <td class="formula">${shippingInsurance.toFixed(2)} ÷ ${(effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${(shippingInsurance/effectiveRate).toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>其他成本</td>
                                            <td class="formula">${otherCost.toFixed(2)} ÷ ${(effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${(otherCost/effectiveRate).toFixed(2)}元</td>
                                        </tr>
                                        <tr class="total">
                                            <td colspan="2">销售费用合计（考虑退货分摊）</td>
                                            <td class="amount">${(platformFee + operationalCost + adCostEffective).toFixed(2)}元</td>
                                        </tr>
                                    </table>
                                    <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                                        注：由于退货率${(returnRate*100).toFixed(0)}%，不可退回费用（广告费、物流费等）需要由${(effectiveRate*100).toFixed(0)}%的成功订单分摊承担。
                                    </div>
                                </div>
                            </div>

                            <div class="step-section">
                                <div class="step-title">3. 税费分析</div>
                                <div class="cost-table">
                                    <div class="table-section">
                                        <div class="section-title" style="color: #e65100;">销项税计算：</div>
                                        <div class="section-note">
                                            销项税是基于不含税售价计算的，计算步骤如下：
                                        </div>
                                        <table>
                                            <tr>
                                                <td>含税售价</td>
                                                <td class="formula">${actualPrice.toFixed(2)}</td>
                                                <td class="amount">${actualPrice.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>不含税售价</td>
                                                <td class="formula">${actualPrice.toFixed(2)} ÷ (1 + ${(outputTaxRate*100).toFixed(0)}%)</td>
                                                <td class="amount">${(actualPrice/(1+outputTaxRate)).toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>销项税额（${(outputTaxRate*100).toFixed(0)}%）</td>
                                                <td class="formula">${(actualPrice/(1+outputTaxRate)).toFixed(2)} × ${(outputTaxRate*100).toFixed(0)}%</td>
                                                <td class="amount">${outputVAT.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>占含税售价比例</td>
                                                <td class="formula">${outputVAT.toFixed(2)} ÷ ${actualPrice.toFixed(2)} × 100%</td>
                                                <td class="amount">${(outputVAT/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <div class="table-section">
                                        <div class="section-title" style="color: #2ea44f;">进项税抵扣：</div>
                                        <div class="section-note">
                                            进项税包括商品、广告费和平台佣金的可抵扣税额：
                                        </div>
                                        <table>
                                            <tr>
                                                <td>商品进项税（${(outputTaxRate*100).toFixed(0)}%）</td>
                                                <td class="formula">${costPrice.toFixed(2)} × ${(outputTaxRate*100).toFixed(0)}%</td>
                                                <td class="amount">${purchaseVAT.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>广告费进项税（6%）</td>
                                                <td class="formula">${adCostEffective.toFixed(2)} × 6%</td>
                                                <td class="amount">${adVAT.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>平台佣金进项税（6%）</td>
                                                <td class="formula">${platformFee.toFixed(2)} × 6%</td>
                                                <td class="amount">${(platformFee * 0.06).toFixed(2)}元</td>
                                            </tr>
                                            <tr class="total">
                                                <td>可抵扣进项税合计</td>
                                                <td class="formula"></td>
                                                <td class="amount">${totalVATDeduction.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>占含税售价比例</td>
                                                <td class="formula">${totalVATDeduction.toFixed(2)} ÷ ${actualPrice.toFixed(2)} × 100%</td>
                                                <td class="amount">${(totalVATDeduction/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <div class="table-section">
                                        <div class="section-title">实际税负：</div>
                                        <table>
                                            <tr>
                                                <td>销项税</td>
                                                <td class="amount" style="color: #e65100;">+${outputVAT.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>可抵扣进项税</td>
                                                <td class="amount" style="color: #2ea44f;">-${totalVATDeduction.toFixed(2)}元</td>
                                            </tr>
                                            <tr class="total">
                                                <td>实际应缴税额</td>
                                                <td class="amount">${actualVAT.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>占含税售价比例</td>
                                                <td class="amount">${(actualVAT/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="step-section">
                                <div class="step-title">4. 最终利润分析</div>
                                <div class="cost-table">
                                    <div class="table-section">
                                        <div class="section-title">收入分析：</div>
                                        <table>
                                            <tr>
                                                <td>含税销售收入</td>
                                                <td class="amount">${actualPrice.toFixed(2)}元</td>
                                            </tr>
                                            <tr>
                                                <td>不含税销售收入</td>
                                                <td class="formula">${actualPrice.toFixed(2)} ÷ (1 + ${(outputTaxRate*100).toFixed(0)}%)</td>
                                                <td class="amount">${(actualPrice/(1+outputTaxRate)).toFixed(2)}元</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <div class="table-section">
                                        <div class="section-title">成本构成：</div>
                                        <table>
                                            <tr>
                                                <td colspan="2">1. 基础成本</td>
                                                <td class="amount">${effectiveCost.toFixed(2)}元</td>
                                                <td class="percent">${(effectiveCost/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">2. 销售费用：</td>
                                                <td class="amount">${(platformFee + operationalCost + adCostEffective).toFixed(2)}元</td>
                                                <td class="percent">${((platformFee + operationalCost + adCostEffective)/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td width="20px"></td>
                                                <td>• 平台佣金（可退回）</td>
                                                <td class="amount">${platformFee.toFixed(2)}元</td>
                                                <td class="percent">${(platformFee/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td>• 广告费用（分摊后）</td>
                                                <td class="amount">${adCostEffective.toFixed(2)}元</td>
                                                <td class="percent">${(adCostEffective/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td>• 物流及其他（分摊后）</td>
                                                <td class="amount">${operationalCost.toFixed(2)}元</td>
                                                <td class="percent">${(operationalCost/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">3. 税费支出（净额）</td>
                                                <td class="amount">${actualVAT.toFixed(2)}元</td>
                                                <td class="percent">${(actualVAT/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr class="total">
                                                <td colspan="2">总成本</td>
                                                <td class="amount">${totalCost.toFixed(2)}元</td>
                                                <td class="percent">${(totalCost/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <div class="table-section">
                                        <div class="section-title" style="color: #2ea44f;">最终利润：</div>
                                        <table>
                                            <tr>
                                                <td>销售收入</td>
                                                <td class="amount">+${actualPrice.toFixed(2)}元</td>
                                                <td class="percent">100%</td>
                                            </tr>
                                            <tr>
                                                <td>总成本</td>
                                                <td class="amount" style="color: #e65100;">-${totalCost.toFixed(2)}元</td>
                                                <td class="percent">${(totalCost/actualPrice*100).toFixed(1)}%</td>
                                            </tr>
                                            <tr class="total">
                                                <td>实际利润</td>
                                                <td class="amount" style="color: #2ea44f;">${profit.toFixed(2)}元</td>
                                                <td class="percent">${profitRate}%</td>
                                            </tr>
                                        </table>
                                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                                            注：所有百分比均基于含税销售收入计算。不可退回费用已按退货率${(returnRate*100).toFixed(0)}%分摊。
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('result').innerHTML = resultHtml;
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        }

        // 保存所有输入值到localStorage
        function saveInputs() {
            const inputs = {
                // 售价计算tab的输入
                costPrice: document.getElementById("costPrice").value,
                inputTaxRate: document.getElementById("inputTaxRate").value,
                outputTaxRate: document.getElementById("outputTaxRate").value,
                salesTaxRate: document.getElementById("salesTaxRate").value,  // 销售成本中的销项税率
                platformRate: document.getElementById("platformRate").value,
                adRate: document.getElementById("adRate").value,
                shippingInsurance: document.getElementById("shippingInsurance").value,
                shippingCost: document.getElementById("shippingCost").value,
                otherCost: document.getElementById("otherCost").value,
                targetProfitRate: document.getElementById("targetProfitRate").value,
                
                // 利润计算tab的输入
                profitCostPrice: document.getElementById("profitCostPrice").value,
                actualPrice: document.getElementById("actualPrice").value,
                profitInputTaxRate: document.getElementById("profitInputTaxRate").value,
                profitOutputTaxRate: document.getElementById("profitOutputTaxRate").value,
                profitSalesTaxRate: document.getElementById("profitSalesTaxRate").value,
                profitPlatformRate: document.getElementById("profitPlatformRate").value,
                profitShippingCost: document.getElementById("profitShippingCost").value,
                profitShippingInsurance: document.getElementById("profitShippingInsurance").value,
                profitAdRate: document.getElementById("profitAdRate").value,
                profitOtherCost: document.getElementById("profitOtherCost").value,
                profitReturnRate: document.getElementById("profitReturnRate").value
            };
            localStorage.setItem('priceCalculatorInputs', JSON.stringify(inputs));
            
            // 显示保存成功提示
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = '已保存输入值';
            document.body.appendChild(toast);
            
            // 2秒后移除提示
            setTimeout(() => {
                toast.classList.add('toast-hide');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2000);
        }

        // 从localStorage加载保存的输入值
        function loadSavedInputs() {
            const saved = localStorage.getItem('priceCalculatorInputs');
            if (saved) {
                const inputs = JSON.parse(saved);
                Object.entries(inputs).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                    }
                });
            }
        }

        // 验证输入值的合法性
        function validateInput(value, min, max, name) {
            if (isNaN(value) || value < min || value > max) {
                throw new Error(`${name}必须在${min}到${max}之间`);
            }
            return value;
        }

        // 获取并验证所有输入值
        function getValidatedInputs() {
            return {
                costPrice: validateInput(parseFloat(document.getElementById("costPrice").value), 0.01, 1000000, "进货价"),
                inputTaxRate: validateInput(parseFloat(document.getElementById("inputTaxRate").value), 0, 100, "进项税率") / 100,
                outputTaxRate: validateInput(parseFloat(document.getElementById("outputTaxRate").value), 0, 100, "商品税率") / 100,
                salesTaxRate: validateInput(parseFloat(document.getElementById("salesTaxRate").value), 0, 100, "销项税率") / 100,
                platformRate: validateInput(parseFloat(document.getElementById("platformRate").value), 0, 100, "平台抽佣比例") / 100,
                shippingCost: validateInput(parseFloat(document.getElementById("shippingCost").value), 0, 10000, "物流费"),
                otherCost: validateInput(parseFloat(document.getElementById("otherCost").value), 0, 10000, "其他成本"),
                adRate: validateInput(parseFloat(document.getElementById("adRate").value), 0, 100, "付费占比") / 100,
                shippingInsurance: validateInput(parseFloat(document.getElementById("shippingInsurance").value), 0, 100, "运费险"),
                returnRate: validateInput(parseFloat(document.getElementById("returnRate").value), 0, 100, "退货率") / 100,
                targetProfitRate: validateInput(parseFloat(document.getElementById("targetProfitRate").value), 0, 100, "目标利润率") / 100
            };
        }

        // 计算进货成本和可抵扣税额
        function calculatePurchaseCost(inputs) {
            // 1. 基础进货成本计算
            const purchasePrice = inputs.costPrice; // 进货价（不含税）
            const invoiceCost = purchasePrice * inputs.inputTaxRate; // 开票成本（如6%）
            
            // 2. 进项税额计算（可抵扣，未来可用于抵减销项税）
            const purchaseVAT = purchasePrice * inputs.outputTaxRate; // 商品进项税额（如13%）
            
            // 3. 总进货成本（实际需要支付的金额）
            const totalPurchaseCost = purchasePrice + invoiceCost; // 总进货成本
            
            // 4. 税后实际成本（考虑未来进项税抵扣后的实际成本）
            const effectiveCost = totalPurchaseCost - purchaseVAT; // 考虑进项税抵扣后的实际成本

            return {
                purchasePrice,      // 不含税进货价
                invoiceCost,        // 开票费用
                totalPurchaseCost,  // 实际支付总金额
                purchaseVAT,        // 可抵扣进项税（未来税收收益）
                effectiveCost       // 考虑税收抵扣后的实际成本
            };
        }

        // 计算销售成本和税费
        function calculateSalesCost(inputs, adCost, purchaseCost) {
            // 1. 计算退货影响
            const returnRate = inputs.returnRate;
            const effectiveRate = 1 - returnRate;

            // 2. 计算销售相关成本（考虑退货分摊）
            const operationalCosts = {
                shipping: inputs.shippingCost / effectiveRate,
                insurance: inputs.shippingInsurance / effectiveRate,
                advertising: adCost / effectiveRate,
                other: inputs.otherCost / effectiveRate
            };

            // 3. 广告费和平台佣金的进项税额（可抵扣）
            const VAT_RATE = 0.06; // 现代服务业增值税率6%
            const adVAT = (adCost / effectiveRate) * VAT_RATE;
            const platformVAT = inputs.platformRate * VAT_RATE; // 平台佣金的可抵扣进项税率

            // 4. 总销售成本（不含平台佣金，因为佣金基于最终售价）
            const totalOperationalCost = Object.values(operationalCosts).reduce((a, b) => a + b, 0);

            // 5. 总可抵扣进项税
            const totalVATDeduction = purchaseCost.purchaseVAT + adVAT + platformVAT;

            return {
                operationalCosts,
                adVAT,
                totalOperationalCost,
                totalVATDeduction,
                returnRate,
                effectiveRate
            };
        }

        // 计算最终价格和相关费用
        function calculatePrices(purchaseCost, salesCost, inputs) {
            // 1. 计算固定成本（考虑退货率）
            // 按新规则：仅对"不可退回"的固定成本（物流、运费险、其他）按有效销售率分摊
            // 进货成本C不随退货率分摊，原因：退货后商品可回收再售，成本不被损耗
            const fixedCosts = (inputs.shippingCost + inputs.shippingInsurance + inputs.otherCost) / salesCost.effectiveRate;
            
            // 2. 利润率按定义：(最终售价-所有成本和税费)/最终售价 = 目标利润率
            // 将基于最终价计提的销项税等比例项换算为"最终价的占比"
            const VAT_RATE = 0.06; // 现代服务业增值税率6%
            const taxFactorOnFinal = inputs.salesTaxRate / (1 + inputs.salesTaxRate); // 销项税占最终售价比例
            const adFactorEffective = inputs.adRate / salesCost.effectiveRate;       // 广告费分摊（不可退回）
            const adVatCreditFactor = VAT_RATE * adFactorEffective;                  // 广告费进项税抵扣占比
            const platformVatCreditFactor = VAT_RATE * inputs.platformRate;          // 平台佣金进项税抵扣占比
            const profitFactorEffective = inputs.targetProfitRate;                   // 目标利润率按最终售价口径，不随退货分摊
            
            // 分子：C（已扣进项税）+ F_不可退回/(1-R)
            const numeratorFinal = purchaseCost.effectiveCost + fixedCosts;
            // 分母：1 - 平台费 - 税占比 - 目标利润率 - 广告费分摊占比 + 广告费可抵扣进项税占比 + 平台佣金进项税抵扣占比
            const denominatorFinal = 1 - inputs.platformRate - taxFactorOnFinal - inputs.targetProfitRate - adFactorEffective + adVatCreditFactor + platformVatCreditFactor;
            
            // 3. 计算含税售价、及不含税净价
            const finalPrice = numeratorFinal / denominatorFinal;
            const netPrice = finalPrice / (1 + inputs.salesTaxRate);
            
            // 4. 计算各项费用
            const platformFee = finalPrice * inputs.platformRate;
            const adCost = finalPrice * inputs.adRate;
            const outputVAT = netPrice * inputs.salesTaxRate;
            const profit = finalPrice * inputs.targetProfitRate;
            
            // 5. 计算广告费进项税（广告费为可抵扣6%，且为不可退回成本，需按(1-R)分摊）
            const adVAT = (adCost / salesCost.effectiveRate) * VAT_RATE;
            
            // 6. 计算实际税负（销项税 - 进项税(商品+广告)）
            const totalVATDeduction = purchaseCost.purchaseVAT + adVAT;
            const actualVAT = outputVAT - totalVATDeduction;

            // 7. 计算“有效成本”用于结果展示（不参与联立，便于理解口径）
            // 有效成本 = C（税后进货成本） + F_不可退回/(1-R)
            // 其中 F_不可退回 = 广告费 + 发货物流费 + 运费险 + 其他固定成本
            const effectiveNonReturnableCost = (inputs.shippingCost + inputs.shippingInsurance + inputs.otherCost) / salesCost.effectiveRate + (adCost / salesCost.effectiveRate);
            const effectiveCostTotal = purchaseCost.effectiveCost + effectiveNonReturnableCost;

            return {
                netPrice,
                finalPrice,
                platformFee,
                outputVAT,
                actualVAT,
                profit,
                profitRate: inputs.targetProfitRate * 100,
                adCost,
                fixedCosts,
                adVAT,
                totalVATDeduction,
                effectiveNonReturnableCost,
                effectiveCostTotal,
                taxFactorOnFinal,
                adFactorEffective,
                adVatCreditFactor,
                profitFactorEffective,
                platformVatCreditFactor
            };
        }

        // 生成结果HTML
        function generateResultHtml(purchaseCost, salesCost, priceInfo, inputs) {
            const adCost = priceInfo.adCost;
            
            return `
                <div class="final-price">
                    <div class="price-label">建议含税售价</div>
                    <div class="price-value">¥ ${priceInfo.finalPrice.toFixed(2)}</div>
                    <div class="price-hint">此价格已考虑所有成本、税费和目标利润</div>
                </div>

                <div class="section calculation-process">
                    <h3>价格构成分析</h3>
                    <div class="price-composition">
                        <div class="composition-item">
                            <div class="item-label">基础成本</div>
                            <div class="item-value">¥ ${purchaseCost.effectiveCost.toFixed(2)}</div>
                            <div class="item-percent">${(purchaseCost.effectiveCost/priceInfo.finalPrice*100).toFixed(1)}%</div>
                        </div>
                        <div class="composition-item">
                            <div class="item-label">销售费用</div>
                            <div class="item-value">¥ ${(priceInfo.platformFee + salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (priceInfo.adCost / salesCost.effectiveRate)).toFixed(2)}</div>
                            <div class="item-percent">${((priceInfo.platformFee + salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (priceInfo.adCost / salesCost.effectiveRate))/priceInfo.finalPrice*100).toFixed(1)}%</div>
                            <div class="cost-detail">
                                <div class="cost-item">平台佣金：¥ ${priceInfo.platformFee.toFixed(2)}</div>
                                <div class="cost-item">广告费用：¥ ${(priceInfo.adCost / salesCost.effectiveRate).toFixed(2)}</div>
                                <div class="cost-item">物流及其他：¥ ${(salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance).toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="composition-item">
                            <div class="item-label">税费支出（净额）</div>
                            <div class="item-value">¥ ${priceInfo.actualVAT.toFixed(2)}</div>
                            <div class="item-percent">${(priceInfo.actualVAT/priceInfo.finalPrice*100).toFixed(1)}%</div>
                            <div class="tax-detail">
                                <div class="tax-item">销项税：¥ ${priceInfo.outputVAT.toFixed(2)}</div>
                                <div class="tax-item">可抵扣：¥ ${priceInfo.totalVATDeduction.toFixed(2)}</div>
                                <div class="tax-item">实缴税费：¥ ${priceInfo.actualVAT.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="composition-item profit">
                            <div class="item-label">预期利润</div>
                            <div class="item-value">¥ ${priceInfo.profit.toFixed(2)}</div>
                            <div class="item-percent">${(priceInfo.profit/priceInfo.finalPrice*100).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="price-note">注意：由于平台佣金（${(inputs.platformRate*100).toFixed(1)}%）和广告费（${(inputs.adRate*100).toFixed(1)}%）是基于最终售价计算的，所以各项金额直接相加不等于最终售价。</div>
                    
                    <div class="calculation-steps">
                        <div class="step-header">计算过程分为以下步骤（所有成本都已考虑退货率${(salesCost.returnRate*100).toFixed(0)}%的影响）：</div>
                        
                        <div class="step-section">
                            <div class="step-title">1. 基础成本计算</div>
                            
                            <div class="cost-table">
                                <div class="table-section">
                                    <div class="section-title">进货相关：</div>
                                    <table>
                                        <tr>
                                            <td>进货成本</td>
                                            <td class="amount">${purchaseCost.totalPurchaseCost.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>税后实际成本（C）<br><span class="note">已扣除可抵扣进项税，不随退货率分摊</span></td>
                                            <td class="amount">${purchaseCost.effectiveCost.toFixed(2)}元</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="table-section">
                                    <div class="section-title">运营相关（考虑退货分摊）：</div>
                                    <div class="section-note">注：平台佣金（${(inputs.platformRate*100).toFixed(1)}%）基于最终售价计算，将在最终定价时计入</div>
                                    <table>
                                        <tr>
                                            <td>物流费</td>
                                            <td class="formula">${inputs.shippingCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${salesCost.operationalCosts.shipping.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>运费险</td>
                                            <td class="formula">${inputs.shippingInsurance.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${salesCost.operationalCosts.insurance.toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>广告费（不可退回）</td>
                                            <td class="formula">${adCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${(adCost / salesCost.effectiveRate).toFixed(2)}元</td>
                                        </tr>
                                        <tr>
                                            <td>其他成本</td>
                                            <td class="formula">${inputs.otherCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}%</td>
                                            <td class="amount">${salesCost.operationalCosts.other.toFixed(2)}元</td>
                                        </tr>
                                        <tr class="total">
                                            <td colspan="2">运营成本合计（不含平台佣金）</td>
                                            <td class="amount">${(salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (adCost / salesCost.effectiveRate) + salesCost.operationalCosts.other).toFixed(2)}元</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="table-section">
                                    <div class="section-title">基础成本合计：</div>
                                    <div class="total-amount">${(purchaseCost.effectiveCost + salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (adCost / salesCost.effectiveRate) + salesCost.operationalCosts.other).toFixed(2)}元</div>
                                </div>
                            </div>
                        </div>

                        <div class="step-section">
                            <div class="step-title">2. 计算不含税售价</div>
                            <div class="formula-box">
                                <div class="formula-title">计算公式：</div>
                                <div class="formula-content">
                                    (税后进货成本 + 不可退回固定成本/(1-退货率)) ÷ (1 - 平台费率 - 销项税率 - 目标利润率 - 广告费率/(1-退货率) + 广告费进项税抵扣 + 平台佣金进项税抵扣)
                                </div>
                                <div class="formula-note">
                                    说明：按利润率定义 (最终售价-所有成本和税费)/最终售价 = 目标利润率 进行联立求解
                                </div>
                            </div>
                            
                            <div class="calculation-details">
                                <table>
                                    <tr>
                                        <td>固定成本（物流、运费险、其他）</td>
                                        <td class="amount">${priceInfo.fixedCosts.toFixed(2)}元</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            比例费用（按最终售价口径）：<br>
                                            <span class="detail-items">
                                                平台佣金 ${(inputs.platformRate*100).toFixed(1)}% +<br>
                                                销项税占比 ${(priceInfo.taxFactorOnFinal*100).toFixed(1)}% +<br>
                                                目标利润分摊 ${(priceInfo.profitFactorEffective*100).toFixed(1)}% +<br>
                                                广告费分摊 ${(priceInfo.adFactorEffective*100).toFixed(1)}% -<br>
                                                广告费进项税抵扣 ${(priceInfo.adVatCreditFactor*100).toFixed(1)}% -<br>
                                                平台佣金进项税抵扣 ${(priceInfo.platformVatCreditFactor*100).toFixed(1)}%
                                            </span>
                                        </td>
                                        <td class="amount">${(100*(inputs.platformRate + priceInfo.taxFactorOnFinal + priceInfo.profitFactorEffective + priceInfo.adFactorEffective - priceInfo.adVatCreditFactor - priceInfo.platformVatCreditFactor)).toFixed(1)}%</td>
                                    </tr>
                                </table>
                                
                                <div class="final-calculation">
                                    <div class="calc-step">
                                        具体计算：(${purchaseCost.effectiveCost.toFixed(2)} + ${priceInfo.fixedCosts.toFixed(2)}) ÷ (1 - ${(100*(inputs.platformRate + priceInfo.taxFactorOnFinal + priceInfo.profitFactorEffective + priceInfo.adFactorEffective - priceInfo.adVatCreditFactor)).toFixed(1)}%)
                                    </div>
                                    <div class="calc-result">
                                        = ${priceInfo.netPrice.toFixed(2)}元
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-section">
                            <div class="step-title">3. 计算含税售价</div>
                            <div class="final-price-calc">
                                <div class="calc-formula">不含税售价 × (1 + 商品税率)</div>
                                <div class="calc-step">${priceInfo.netPrice.toFixed(2)} × (1 + ${(inputs.outputTaxRate*100).toFixed(0)}%)</div>
                                <div class="calc-result">= ${priceInfo.finalPrice.toFixed(2)}元</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h3>进货成本分析</h3>
                    <ul>
                        <li>产品成本（不含税）：${purchaseCost.purchasePrice.toFixed(2)} 元</li>
                        <li>开票费用（${(inputs.inputTaxRate*100).toFixed(0)}%）：${purchaseCost.invoiceCost.toFixed(2)} 元</li>
                        <li>实际支付总额：${purchaseCost.totalPurchaseCost.toFixed(2)} 元</li>
                        <li>可抵扣进项税（${(inputs.outputTaxRate*100).toFixed(0)}%）：${purchaseCost.purchaseVAT.toFixed(2)} 元
                            <ul>
                                <li>这部分税额将来可以抵减销项税，相当于未来的税收收益</li>
                                <li>注意：这不是立即的现金收益，而是在销售环节产生销项税时才能抵扣</li>
                            </ul>
                        </li>
                        <li>税后实际成本：${purchaseCost.effectiveCost.toFixed(2)} 元
                            <ul>
                                <li>这是考虑了进项税抵扣后的实际成本压力</li>
                                <li>计算方式：实际支付总额 - 可抵扣进项税</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="section">
                    <h3>销售成本（考虑退货率${(salesCost.returnRate*100).toFixed(0)}%）</h3>
                    <div class="sales-cost-analysis">
                        <div class="analysis-header">
                            由于退货率${(salesCost.returnRate*100).toFixed(0)}%，意味着每100单中有${(salesCost.returnRate*100).toFixed(0)}单会退货，以下成本会由${(salesCost.effectiveRate*100).toFixed(0)}单成功销售的订单分摊承担
                        </div>
                        <div class="cost-breakdown">
                            <div class="cost-item">
                                <div class="cost-title">广告费用：${(adCost / salesCost.effectiveRate).toFixed(2)}元</div>
                                <div class="cost-details">
                                    <div class="detail-row">
                                        <span class="detail-label">基础广告费（${(inputs.adRate*100).toFixed(0)}%）：</span>
                                        <span class="detail-value">${adCost.toFixed(2)}元</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">分摊后每单广告费：</span>
                                        <span class="detail-formula">${adCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(adCost / salesCost.effectiveRate).toFixed(2)}元</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">广告费进项税（6%，可抵扣）：</span>
                                        <span class="detail-value">${priceInfo.adVAT.toFixed(2)}元</span>
                                    </div>
                                </div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-row">
                                    <span class="cost-label">物流费用：</span>
                                    <span class="cost-formula">${inputs.shippingCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.shipping.toFixed(2)}元</span>
                                </div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-row">
                                    <span class="cost-label">运费险：</span>
                                    <span class="cost-formula">${inputs.shippingInsurance.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.insurance.toFixed(2)}元</span>
                                </div>
                            </div>
                            <div class="cost-item">
                                <div class="cost-row">
                                    <span class="cost-label">其他成本：</span>
                                    <span class="cost-formula">${inputs.otherCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.other.toFixed(2)}元</span>
                                </div>
                            </div>
                            <div class="total-cost">
                                <span class="total-label">总运营成本：</span>
                                <span class="total-value">${(salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (adCost / salesCost.effectiveRate) + salesCost.operationalCosts.other).toFixed(2)}元</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>税费分析</h3>
                    <ul>
                        <li>销项税额（应收）：${priceInfo.outputVAT.toFixed(2)} 元</li>
                        <li>进项税额（可抵扣）：${(purchaseCost.purchaseVAT + priceInfo.adVAT + priceInfo.platformVatCreditFactor * priceInfo.finalPrice).toFixed(2)} 元
                            <ul>
                                <li>商品进项税：${purchaseCost.purchaseVAT.toFixed(2)} 元</li>
                                <li>广告费进项税：${priceInfo.adVAT.toFixed(2)} 元</li>
                                <li>平台佣金进项税：${(priceInfo.platformVatCreditFactor * priceInfo.finalPrice).toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>实际应缴税额：${priceInfo.actualVAT.toFixed(2)} 元</li>
                    </ul>
                </div>

                <div class="section">
                    <h3>最终结果</h3>
                    <ul>
                        <li>有效成本：
                            <ul>
                                <li>C（税后进货成本）：${purchaseCost.effectiveCost.toFixed(2)} 元</li>
                                <li>F 不可退回分摊：
                                    <ul>
                                        <li>广告费：${priceInfo.adCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(priceInfo.adCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>发货物流费：${inputs.shippingCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(inputs.shippingCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>运费险：${inputs.shippingInsurance.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(inputs.shippingInsurance / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>其他固定成本：${inputs.otherCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(inputs.otherCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>合计（F 不可退回/(1-R)）：${priceInfo.effectiveNonReturnableCost.toFixed(2)} 元</li>
                                    </ul>
                                </li>
                                <li>有效成本合计：${priceInfo.effectiveCostTotal.toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>不含税售价：${priceInfo.netPrice.toFixed(2)} 元</li>
                        <li>含税售价：${priceInfo.finalPrice.toFixed(2)} 元</li>
                        <li>平台佣金：
                            <ul>
                                <li>计算基数：含税售价 ${priceInfo.finalPrice.toFixed(2)} 元</li>
                                <li>费率：${(inputs.platformRate*100).toFixed(1)}%</li>
                                <li>佣金金额：${priceInfo.platformFee.toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>预期利润：${priceInfo.profit.toFixed(2)} 元（${priceInfo.profitRate.toFixed(1)}%）</li>
                    </ul>
                </div>

                <p class="calculation-note">计算说明：</p>
                <ul class="calculation-note">
                    <li>进货相关：
                        <ul>
                            <li>实际支付总额 = 产品成本（不含税） + 开票费用</li>
                            <li>可抵扣进项税 = 产品成本 × 商品税率（${(inputs.outputTaxRate*100).toFixed(0)}%）</li>
                            <li>税后实际成本 = 实际支付总额 - 可抵扣进项税</li>
                            <li>注意：进项税抵扣是未来的税收收益，不是立即的现金减少</li>
                        </ul>
                    </li>
                    <li>广告费相关：
                        <ul>
                            <li>广告费 = 最终售价 × 广告费率（${(inputs.adRate*100).toFixed(0)}%）</li>
                            <li>广告费进项税 = 广告费 × 6%（可抵扣）</li>
                        </ul>
                    </li>
                    <li>税费相关：
                        <ul>
                            <li>销项税额 = 含税售价 ÷ (1 + 税率) × 税率</li>
                            <li>实际应缴税额 = 销项税额 - 可抵扣进项税额（包括商品和广告费）</li>
                        </ul>
                    </li>
                    <li>其他计算：
                        <ul>
                            <li>平台佣金 = 含税售价 × 平台费率</li>
                            <li>预期利润 = 含税售价 × 目标利润率</li>
                        </ul>
                    </li>
                    <li>退货率影响：
                        <ul>
                            <li>有效销售率 = 1 - 退货率</li>
                            <li>仅不可退回成本分摊：分摊后不可退回成本 = 原始不可退回成本 ÷ 有效销售率</li>
                            <li>可退回费用（平台佣金、销项税）退货后可全额退回，不参与分摊</li>
                            <li>例如：不可退回成本5元，退货率20%，则分摊后不可退回成本 = 5 ÷ 80% = 6.25元</li>
                        </ul>
                    </li>
                </ul>
            `;
        }

        /**
         * 计算合理售价的主函数
         * 
         * 重要说明：售价计算模块与利润计算模块的差异
         * 1. 售价计算模块（本函数）
         *    - 目的：确保有效订单（扣除退货后）达到目标利润率
         *    - 原理：基于退货率提高售价，确保剩余有效订单达到目标利润
         *    - 例如：目标利润率8%，退货率20%时：
         *      · 售价会被适当提高，以确保80%的有效订单达到8%的利润率
         *      · 最终售价会高于简单基于8%利润率计算的价格
         * 
         * 2. 与利润计算模块的区别
         *    - 售价计算：关注单个有效订单的利润率（退货分摊后）
         *    - 利润计算：展示整体业务的利润率（所有订单）
         *    - 这导致：相同售价下，利润计算模块显示的利润率会高于目标利润率
         *    - 原因：售价中包含了对退货损失的补偿
         * 
         * 3. 实际应用建议
         *    - 如果想让整体利润率接近目标值，可以适当调低这里的目标利润率
         *    - 建议通过实际运营数据来调整目标利润率
         *    - 密切关注退货率变化对定价的影响
         */
        function calculate() {
            // 清除之前的错误信息
            document.getElementById("result").innerHTML = "";
            try {
                // 1. 获取并验证所有输入值
                const inputs = getValidatedInputs();
                
                // 2. 验证比例费用组合（按最终售价口径）：
                // 需满足 1 - (平台 + 销项税占比 + 目标利润 + 广告分摊 - 广告进项抵扣) > 0
                const returnRate = parseFloat(document.getElementById("returnRate").value) / 100 || 0;
                const effectiveRate = 1 - returnRate;
                const VAT_RATE = 0.06; // 现代服务业增值税率6%
                const taxFactorOnFinal = inputs.salesTaxRate / (1 + inputs.salesTaxRate);
                const adFactorEffective = inputs.adRate / effectiveRate;
                const adVatCreditFactor = VAT_RATE * adFactorEffective;
                const profitFactorEffective = inputs.targetProfitRate; // 利润率按最终售价口径
                const denominatorFinal = 1 - (inputs.platformRate + taxFactorOnFinal + profitFactorEffective + adFactorEffective - adVatCreditFactor);
                if (denominatorFinal <= 0) {
                    throw new Error("参数组合过高（平台、税费占比、目标利润、广告费(分摊) - 广告进项抵扣），无法计算有效售价");
                }

                // 3. 计算进货成本和可抵扣进项税
                const purchaseCost = calculatePurchaseCost(inputs);
                
                // 4. 计算销售成本和总可抵扣税额（不含广告费，因为广告费会基于最终售价计算）
                const salesCost = calculateSalesCost(inputs, 0, purchaseCost);
                
                // 5. 一次性计算最终价格和各项费用
                const priceInfo = calculatePrices(purchaseCost, salesCost, inputs);

                // 6. 更新销售成本预览
                updateSalesCostSummary(priceInfo.finalPrice);

                // 7. 显示结果
                document.getElementById("result").innerHTML = generateResultHtml(purchaseCost, salesCost, priceInfo, inputs);
            } catch (error) {
                // 显示错误信息
                document.getElementById("result").innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        }

        // 页面加载完成后加载保存的值并计算
        window.onload = function() {
            loadSavedInputs();
            calculate();
        };
        
        // 实时计算进货成本
        function updatePurchaseCostSummary() {
            try {
                const costPrice = parseFloat(document.getElementById("costPrice").value) || 0;
                const inputTaxRate = parseFloat(document.getElementById("inputTaxRate").value) / 100 || 0;
                const outputTaxRate = parseFloat(document.getElementById("outputTaxRate").value) / 100 || 0;

                const invoiceCost = costPrice * inputTaxRate;
                const totalPayment = costPrice + invoiceCost;
                const purchaseVAT = costPrice * outputTaxRate;
                const effectiveCost = totalPayment - purchaseVAT;

                document.getElementById("totalPayment").textContent = `¥${totalPayment.toFixed(2)}`;
                document.getElementById("effectiveCost").textContent = `¥${effectiveCost.toFixed(2)}`;
            } catch (error) {
                document.getElementById("totalPayment").textContent = "¥0.00";
                document.getElementById("effectiveCost").textContent = "¥0.00";
            }
        }

        // 实时计算销售成本
        function updateSalesCostSummary(finalPrice = 0) {
            try {
                // 获取基础输入值
                const shippingCost = parseFloat(document.getElementById("shippingCost").value) || 0;
                const shippingInsurance = parseFloat(document.getElementById("shippingInsurance").value) || 0;
                const otherCost = parseFloat(document.getElementById("otherCost").value) || 0;
                const returnRate = parseFloat(document.getElementById("returnRate").value) / 100 || 0;
                const salesTaxRate = parseFloat(document.getElementById("salesTaxRate").value) / 100 || 0;
                const platformRate = parseFloat(document.getElementById("platformRate").value) / 100 || 0;
                const adRate = parseFloat(document.getElementById("adRate").value) / 100 || 0;

                // 计算有效销售率（考虑退货）
                const effectiveRate = 1 - returnRate;

                // 计算固定成本（考虑退货分摊）
                const totalFixedCost = (shippingCost + shippingInsurance + otherCost) / effectiveRate;

                // 计算基于最终售价的费用
                const platformFee = finalPrice * platformRate;
                const adCost = finalPrice * adRate;
                // 广告费为不可退回，需按有效销售率分摊
                const adCostEffective = adCost / effectiveRate;
                const salesTax = finalPrice / (1 + salesTaxRate) * salesTaxRate;  // 正确的销项税计算：含税价÷(1+税率)×税率

                // 计算总销售成本
                const totalSalesCost = totalFixedCost + platformFee + adCostEffective + salesTax;

                // 更新显示
                document.getElementById("totalFixedCost").textContent = `¥${totalFixedCost.toFixed(2)}`;
                document.getElementById("platformFeePreview").textContent = `¥${platformFee.toFixed(2)}`;
                document.getElementById("adCostPreview").textContent = `¥${adCostEffective.toFixed(2)}`;
                document.getElementById("salesTax").textContent = `¥${salesTax.toFixed(2)}`;
                document.getElementById("totalSalesCost").textContent = `¥${totalSalesCost.toFixed(2)}`;

                // 更新销项税率显示
                const salesTaxLabel = document.querySelector('#salesCostSummary div:nth-child(4) span:first-child');
                salesTaxLabel.textContent = `销项税（${(salesTaxRate * 100).toFixed(1)}%）：`;

            } catch (error) {
                document.getElementById("totalFixedCost").textContent = "¥0.00";
                document.getElementById("platformFeePreview").textContent = "¥0.00";
                document.getElementById("adCostPreview").textContent = "¥0.00";
                document.getElementById("salesTax").textContent = "¥0.00";
                document.getElementById("totalSalesCost").textContent = "¥0.00";
            }
        }

        // 为所有输入框添加实时计算功能
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                try {
                    // 判断当前激活的tab
                    const profitTabActive = document.getElementById('profitTab').classList.contains('active');
                    
                    if (profitTabActive) {
                        // 利润计算tab的实时计算
                        try {
                            // 获取基础输入
                            const costPrice = validateInput(parseFloat(document.getElementById('profitCostPrice').value), 0.01, 1000000, "进货价");
                            const actualPrice = validateInput(parseFloat(document.getElementById('actualPrice').value), 0.01, 1000000, "实际售价");
                            const inputTaxRate = validateInput(parseFloat(document.getElementById('profitInputTaxRate').value), 0, 100, "开票成本") / 100;
                            const outputTaxRate = validateInput(parseFloat(document.getElementById('profitOutputTaxRate').value), 0, 100, "商品税率") / 100;
                            const platformRate = validateInput(parseFloat(document.getElementById('profitPlatformRate').value), 0, 100, "平台抽佣比例") / 100;
                            const shippingCost = validateInput(parseFloat(document.getElementById('profitShippingCost').value), 0, 10000, "物流费");
                            const shippingInsurance = validateInput(parseFloat(document.getElementById('profitShippingInsurance').value), 0, 100, "运费险");
                            const adRate = validateInput(parseFloat(document.getElementById('profitAdRate').value), 0, 100, "广告费用比例") / 100;
                            const otherCost = validateInput(parseFloat(document.getElementById('profitOtherCost').value), 0, 10000, "其他成本");
                            const returnRate = validateInput(parseFloat(document.getElementById('profitReturnRate').value), 0, 100, "退货率") / 100;

                            // 触发利润计算
                            calculateProfit();
                        } catch (error) {
                            // 如果输入无效，清空结果区域
                            document.getElementById('result').innerHTML = '';
                        }
                    } else {
                        // 售价计算tab的实时计算
                        try {
                            // 获取并验证所有输入值
                            const inputs = getValidatedInputs();
                            
                            // 计算进货成本
                            const purchaseCost = calculatePurchaseCost(inputs);
                            
                            // 计算销售成本（不含广告费，因为广告费会基于最终售价计算）
                            const salesCost = calculateSalesCost(inputs, 0, purchaseCost);
                            
                            // 计算最终价格
                            const priceInfo = calculatePrices(purchaseCost, salesCost, inputs);

                            // 更新显示
                            updatePurchaseCostSummary();
                            updateSalesCostSummary(priceInfo.finalPrice);
                            calculate();
                        } catch (error) {
                            updatePurchaseCostSummary();
                            updateSalesCostSummary(0);
                        }
                    }
                } catch (error) {
                    // 处理任何未预期的错误
                    console.error('实时计算错误:', error);
                }
            });
        });

        // 页面加载时计算一次
        window.addEventListener('load', () => {
            loadSavedInputs(); // 先加载保存的输入值
            
            try {
                // 默认显示利润计算结果
                calculateProfit();
            } catch (error) {
                console.error('初始化计算错误:', error);
            }
        });
    </script>
</body>
</html>