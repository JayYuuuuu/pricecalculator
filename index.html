<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>电商合理售价计算器</title>
    <style>
        /* 现代化的UI样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f5f5f7;
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 
                       0 8px 24px rgba(0, 0, 0, 0.04);
        }
        h2 {
            color: #1d1d1f;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 500;
        }
        .section {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .section h3 {
            color: #1d1d1f;
            font-size: 1.1rem;
            margin: 0 0 1.5rem 0;
            font-weight: 500;
        }
        .input-groups-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        .input-group {
            margin-bottom: 0;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        label {
            display: block;
            margin-bottom: 0.35rem;
            color: #1d1d1f;
            font-weight: 400;
            font-size: 0.9rem;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: #fafafa;
            margin-right: 8px;
        }
        input:focus {
            border-color: #0066cc;
            outline: none;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
        }
        .field-hint {
            font-size: 0.8rem;
            color: #86868b;
            margin-top: 0.25rem;
            line-height: 1.2;
        }
        button {
            width: auto;
            padding: 0.75rem 1.5rem;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 1.5rem auto;
            display: block;
        }
        button:hover {
            background-color: #0077ed;
        }
        .result {
            margin-top: 2rem;
            font-size: 1rem;
        }
        .final-price {
            text-align: center;
            background: #f5f5f7;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .final-price .price-label {
            font-size: 1.2rem;
            color: #1d1d1f;
            margin-bottom: 1rem;
        }
        .final-price .price-value {
            font-size: 2.5rem;
            font-weight: 600;
            color: #0066cc;
        }
        .calculation-process {
            margin-top: 2rem;
            background: #ffffff;
        }
        .result .section {
            margin-bottom: 1.5rem;
        }
        .result .section h3 {
            color: #1d1d1f;
            font-size: 1rem;
            margin: 0 0 1rem 0;
            font-weight: 500;
        }
        .result ul {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
            list-style-type: none;
        }
        .result ul li {
            margin: 0.4rem 0;
            position: relative;
        }
        .result ul li:before {
            content: "•";
            color: #86868b;
            position: absolute;
            left: -1rem;
        }
        .result ul ul {
            margin: 0.35rem 0 0.35rem 0.5rem;
            color: #515154;
        }
        .result ul ul li:before {
            content: "◦";
        }
        .error {
            color: #ff3b30;
            padding: 1rem;
            background-color: #fff2f2;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.95rem;
        }
        .description {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #86868b;
            padding: 1rem;
            background-color: #f5f5f7;
            border-radius: 6px;
        }
        .calculation-note {
            font-size: 0.85rem;
            color: #515154;
            margin-top: 1rem;
            border-top: 1px solid #d2d2d7;
            padding-top: 1rem;
        }
        .save-button {
            background: none;
            color: #0066cc;
            border: none;
            padding: 0.25rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color 0.2s ease;
            width: auto;
            margin: 0;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .save-button:hover {
            color: #0077ed;
            background: none;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-size: 0.9rem;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .toast-hide {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>电商合理售价计算器</h2>
        
                    <div class="section">
                <h3>进货成本</h3>
                <div class="input-groups-container">
                    <div class="input-group">
                        <label>进货价（不含税）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="costPrice" value="100" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>开票费率（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="inputTaxRate" value="6" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">供应商收取的开票费用比例</div>
                    </div>

                    <div class="input-group">
                        <label>商品税率（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="outputTaxRate" value="13" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">增值税税率（如服装类13%），用于计算进项税抵扣</div>
                    </div>
                </div>
                
                <div class="cost-summary" id="purchaseCostSummary" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>实际支付总额：</span>
                        <span id="totalPayment" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #2ea44f;">
                        <span>税后实际成本：</span>
                        <span id="effectiveCost" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div class="field-hint" style="margin-top: 0.5rem; font-size: 0.8rem;">
                        税后实际成本 = 实际支付总额 - 可抵扣进项税（未来税收收益）
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>销售成本</h3>
                <div class="input-groups-container">
                    <div class="input-group">
                        <label>平台抽佣比例（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="platformRate" value="5.5" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">基于最终售价（含税）计算的平台佣金比例</div>
                    </div>

                    <div class="input-group">
                        <label>物流费（元）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="shippingCost" value="5" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>付费占比（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="adRate" value="30" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">广告费占最终售价的比例，可开具6%专票用于抵扣</div>
                    </div>

                    <div class="input-group">
                        <label>运费险（元）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="shippingInsurance" value="1" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">每单运费险的预估成本</div>
                    </div>

                    <div class="input-group">
                        <label>其他成本（元）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="otherCost" value="2" step="0.01">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>销项税率（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="salesTaxRate" value="13" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">每笔交易需缴纳的销项税率（如服装类13%）</div>
                    </div>
                </div>
                
                <div class="cost-summary" id="salesCostSummary" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>固定成本（含退货分摊）：</span>
                        <span id="totalFixedCost" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>平台佣金：</span>
                        <span id="platformFeePreview" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>广告费：</span>
                        <span id="adCostPreview" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>销项税（13%）：</span>
                        <span id="salesTax" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #2ea44f;">
                        <span>总销售成本：</span>
                        <span id="totalSalesCost" style="font-weight: 500;">¥0.00</span>
                    </div>
                    <div class="field-hint" style="margin-top: 0.5rem; font-size: 0.8rem;">
                        总销售成本 = 固定成本 + 平台佣金 + 广告费 + 销项税（基于最终售价）
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>其他参数</h3>
                <div class="input-groups-container">
                    <div class="input-group">
                        <label>退货率（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="returnRate" value="20" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">预计的退货率，影响实际利润计算</div>
                    </div>

                    <div class="input-group">
                        <label>目标利润率（%）:</label>
                        <div class="input-wrapper">
                            <input type="number" id="targetProfitRate" value="20" step="0.1">
                            <button class="save-button" onclick="saveInputs()">保存</button>
                        </div>
                        <div class="field-hint">基于最终售价的目标利润率</div>
                    </div>
                </div>
            </div>

        <button onclick="calculate()">计算合理售价</button>

        <div class="result" id="result"></div>
        
        <div class="description">
            <p>计算说明：</p>
            <ul>
                <li>进货价请填写不含税价格</li>
                <li>开票费率是供应商收取的开票费用比例（如6%）</li>
                <li>销项税率用于计算可抵扣的进项税额（如服装类目13%）</li>
                <li>计算结果已考虑开票成本、税费抵扣、平台抽佣等</li>
                <li>目标利润率基于最终售价计算</li>
            </ul>
        </div>
    </div>

    <script>
        // 保存所有输入值到localStorage
        function saveInputs() {
            const inputs = {
                costPrice: document.getElementById("costPrice").value,
                inputTaxRate: document.getElementById("inputTaxRate").value,
                outputTaxRate: document.getElementById("outputTaxRate").value,
                salesTaxRate: document.getElementById("salesTaxRate").value,  // 销售成本中的销项税率
                platformRate: document.getElementById("platformRate").value,
                adRate: document.getElementById("adRate").value,
                shippingInsurance: document.getElementById("shippingInsurance").value,
                shippingCost: document.getElementById("shippingCost").value,
                otherCost: document.getElementById("otherCost").value,
                targetProfitRate: document.getElementById("targetProfitRate").value
            };
            localStorage.setItem('priceCalculatorInputs', JSON.stringify(inputs));
            
            // 显示保存成功提示
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = '已保存输入值';
            document.body.appendChild(toast);
            
            // 2秒后移除提示
            setTimeout(() => {
                toast.classList.add('toast-hide');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2000);
        }

        // 从localStorage加载保存的输入值
        function loadSavedInputs() {
            const saved = localStorage.getItem('priceCalculatorInputs');
            if (saved) {
                const inputs = JSON.parse(saved);
                Object.entries(inputs).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                    }
                });
            }
        }

        // 验证输入值的合法性
        function validateInput(value, min, max, name) {
            if (isNaN(value) || value < min || value > max) {
                throw new Error(`${name}必须在${min}到${max}之间`);
            }
            return value;
        }

        // 获取并验证所有输入值
        function getValidatedInputs() {
            return {
                costPrice: validateInput(parseFloat(document.getElementById("costPrice").value), 0.01, 1000000, "进货价"),
                inputTaxRate: validateInput(parseFloat(document.getElementById("inputTaxRate").value), 0, 100, "进项税率") / 100,
                outputTaxRate: validateInput(parseFloat(document.getElementById("outputTaxRate").value), 0, 100, "商品税率") / 100,
                salesTaxRate: validateInput(parseFloat(document.getElementById("salesTaxRate").value), 0, 100, "销项税率") / 100,
                platformRate: validateInput(parseFloat(document.getElementById("platformRate").value), 0, 100, "平台抽佣比例") / 100,
                shippingCost: validateInput(parseFloat(document.getElementById("shippingCost").value), 0, 10000, "物流费"),
                otherCost: validateInput(parseFloat(document.getElementById("otherCost").value), 0, 10000, "其他成本"),
                adRate: validateInput(parseFloat(document.getElementById("adRate").value), 0, 100, "付费占比") / 100,
                shippingInsurance: validateInput(parseFloat(document.getElementById("shippingInsurance").value), 0, 100, "运费险"),
                returnRate: validateInput(parseFloat(document.getElementById("returnRate").value), 0, 100, "退货率") / 100,
                targetProfitRate: validateInput(parseFloat(document.getElementById("targetProfitRate").value), 0, 100, "目标利润率") / 100
            };
        }

        // 计算进货成本和可抵扣税额
        function calculatePurchaseCost(inputs) {
            // 1. 基础进货成本计算
            const purchasePrice = inputs.costPrice; // 进货价（不含税）
            const invoiceCost = purchasePrice * inputs.inputTaxRate; // 开票成本（如6%）
            
            // 2. 进项税额计算（可抵扣，未来可用于抵减销项税）
            const purchaseVAT = purchasePrice * inputs.outputTaxRate; // 商品进项税额（如13%）
            
            // 3. 总进货成本（实际需要支付的金额）
            const totalPurchaseCost = purchasePrice + invoiceCost; // 总进货成本
            
            // 4. 税后实际成本（考虑未来进项税抵扣后的实际成本）
            const effectiveCost = totalPurchaseCost - purchaseVAT; // 考虑进项税抵扣后的实际成本

            return {
                purchasePrice,      // 不含税进货价
                invoiceCost,        // 开票费用
                totalPurchaseCost,  // 实际支付总金额
                purchaseVAT,        // 可抵扣进项税（未来税收收益）
                effectiveCost       // 考虑税收抵扣后的实际成本
            };
        }

        // 计算销售成本和税费
        function calculateSalesCost(inputs, adCost, purchaseCost) {
            // 1. 计算退货影响
            const returnRate = inputs.returnRate;
            const effectiveRate = 1 - returnRate;

            // 2. 计算销售相关成本（考虑退货分摊）
            const operationalCosts = {
                shipping: inputs.shippingCost / effectiveRate,
                insurance: inputs.shippingInsurance / effectiveRate,
                advertising: adCost / effectiveRate,
                other: inputs.otherCost / effectiveRate
            };

            // 3. 广告费进项税额（可抵扣）
            const AD_VAT_RATE = 0.06;
            const adVAT = (adCost / effectiveRate) * AD_VAT_RATE;

            // 4. 总销售成本（不含平台佣金，因为佣金基于最终售价）
            const totalOperationalCost = Object.values(operationalCosts).reduce((a, b) => a + b, 0);

            // 5. 总可抵扣进项税
            const totalVATDeduction = purchaseCost.purchaseVAT + adVAT;

            return {
                operationalCosts,
                adVAT,
                totalOperationalCost,
                totalVATDeduction,
                returnRate,
                effectiveRate
            };
        }

        // 计算最终价格和相关费用
        function calculatePrices(purchaseCost, salesCost, inputs) {
            // 1. 计算固定成本（考虑退货率）
            // 按新规则：仅对"不可退回"的固定成本（物流、运费险、其他）按有效销售率分摊
            // 进货成本C不随退货率分摊，原因：退货后商品可回收再售，成本不被损耗
            const fixedCosts = (inputs.shippingCost + inputs.shippingInsurance + inputs.otherCost) / salesCost.effectiveRate;
            
            // 2. 利润率按定义：(最终售价-所有成本和税费)/最终售价 = 目标利润率
            // 将基于最终价计提的销项税等比例项换算为"最终价的占比"
            const AD_VAT_RATE = 0.06;
            const taxFactorOnFinal = inputs.salesTaxRate / (1 + inputs.salesTaxRate); // 销项税占最终售价的比例 = s/(1+s)
            const adFactorEffective = inputs.adRate / salesCost.effectiveRate;       // 广告费（不可退回）按(1-R)分摊
            const adVatCreditFactor = AD_VAT_RATE * adFactorEffective;                // 广告费可抵扣进项税（6%）对应占比
            const profitFactorEffective = inputs.targetProfitRate / salesCost.effectiveRate; // 目标利润（不可退回）按(1-R)分摊
            
            // 分子：C（已扣进项税）+ F_不可退回/(1-R)
            const numeratorFinal = purchaseCost.effectiveCost + fixedCosts;
            // 分母：1 - 平台费 - 税占比 - 目标利润率/(1-R) - 广告费分摊占比 + 广告费可抵扣进项税占比
            const denominatorFinal = 1 - inputs.platformRate - taxFactorOnFinal - profitFactorEffective - adFactorEffective + adVatCreditFactor;
            
            // 3. 计算含税售价、及不含税净价
            const finalPrice = numeratorFinal / denominatorFinal;
            const netPrice = finalPrice / (1 + inputs.salesTaxRate);
            
            // 4. 计算各项费用
            const platformFee = finalPrice * inputs.platformRate;
            const adCost = finalPrice * inputs.adRate;
            const outputVAT = netPrice * inputs.salesTaxRate;
            const profit = finalPrice * inputs.targetProfitRate;
            
            // 5. 计算广告费进项税（广告费为可抵扣6%，且为不可退回成本，需按(1-R)分摊）
            const adVAT = (adCost / salesCost.effectiveRate) * AD_VAT_RATE;
            
            // 6. 计算实际税负（销项税 - 进项税(商品+广告)）
            const totalVATDeduction = purchaseCost.purchaseVAT + adVAT;
            const actualVAT = outputVAT - totalVATDeduction;

            // 7. 计算“有效成本”用于结果展示（不参与联立，便于理解口径）
            // 有效成本 = C（税后进货成本） + F_不可退回/(1-R)
            // 其中 F_不可退回 = 广告费 + 发货物流费 + 运费险 + 其他固定成本
            const effectiveNonReturnableCost = (inputs.shippingCost + inputs.shippingInsurance + inputs.otherCost) / salesCost.effectiveRate + (adCost / salesCost.effectiveRate);
            const effectiveCostTotal = purchaseCost.effectiveCost + effectiveNonReturnableCost;

            return {
                netPrice,
                finalPrice,
                platformFee,
                outputVAT,
                actualVAT,
                profit,
                profitRate: inputs.targetProfitRate * 100,
                adCost,
                fixedCosts,
                adVAT,
                totalVATDeduction,
                effectiveNonReturnableCost,
                effectiveCostTotal,
                taxFactorOnFinal,
                adFactorEffective,
                adVatCreditFactor,
                profitFactorEffective
            };
        }

        // 生成结果HTML
        function generateResultHtml(purchaseCost, salesCost, priceInfo, inputs) {
            const adCost = priceInfo.adCost;
            
            return `
                <div class="final-price">
                    <div class="price-label">建议含税售价</div>
                    <div class="price-value">¥ ${priceInfo.finalPrice.toFixed(2)}</div>
                </div>

                <div class="section calculation-process">
                    <h3>售价计算过程</h3>
                    <div class="field-hint">计算过程分为以下步骤（所有成本都已考虑退货率${(salesCost.returnRate*100).toFixed(0)}%的影响）：</div>
                    <ul>
                        <li>1. 基础成本计算：
                            <ul>
                                <li>进货相关：
                                    <ul>
                                        <li>进货成本：${purchaseCost.totalPurchaseCost.toFixed(2)}元</li>
                                        <li>税后实际成本（C）：${purchaseCost.effectiveCost.toFixed(2)}元（已扣除可抵扣进项税，不随退货率分摊）</li>
                                    </ul>
                                </li>
                                <li>运营相关（考虑退货分摊）：
                                    <ul>
                                        <li>物流费：${inputs.shippingCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.shipping.toFixed(2)}元</li>
                                        <li>运费险：${inputs.shippingInsurance.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.insurance.toFixed(2)}元</li>
                                        <li>广告费（不可退回）：${adCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(adCost / salesCost.effectiveRate).toFixed(2)}元</li>
                                        <li>其他成本：${inputs.otherCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.other.toFixed(2)}元</li>
                                        <li>运营成本合计：${(salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (adCost / salesCost.effectiveRate) + salesCost.operationalCosts.other).toFixed(2)}元</li>
                                    </ul>
                                </li>
                                <li>基础成本合计：${(purchaseCost.effectiveCost + salesCost.operationalCosts.shipping + salesCost.operationalCosts.insurance + (adCost / salesCost.effectiveRate) + salesCost.operationalCosts.other).toFixed(2)}元</li>
                            </ul>
                        </li>
                        <li>2. 计算不含税售价：
                            <ul>
                                <li>计算公式：(税后进货成本 + 不可退回固定成本/(1-退货率)) ÷ (1 - 平台费率 - 销项税率 - 目标利润率 - 广告费率/(1-退货率))</li>
                                <li>说明：按利润率定义 (最终售价-所有成本和税费)/最终售价 = 目标利润率 进行联立求解</li>
                                <li>固定成本：${priceInfo.fixedCosts.toFixed(2)}元（物流、运费险、其他）</li>
                                <li>比例费用（按最终售价口径）：平台佣金${(inputs.platformRate*100).toFixed(1)}% + 销项税占比${(priceInfo.taxFactorOnFinal*100).toFixed(1)}% + 目标利润分摊${(priceInfo.profitFactorEffective*100).toFixed(1)}% + 广告费分摊${(priceInfo.adFactorEffective*100).toFixed(1)}% - 广告费进项税抵扣${(priceInfo.adVatCreditFactor*100).toFixed(1)}%</li>
                                <li>具体计算：(${purchaseCost.effectiveCost.toFixed(2)} + ${priceInfo.fixedCosts.toFixed(2)}) ÷ (1 - ${(100*(inputs.platformRate + priceInfo.taxFactorOnFinal + priceInfo.profitFactorEffective + priceInfo.adFactorEffective - priceInfo.adVatCreditFactor)).toFixed(1)}%)</li>
                                <li>= ${priceInfo.netPrice.toFixed(2)}元</li>
                            </ul>
                        </li>
                        <li>3. 计算含税售价：
                            <ul>
                                <li>不含税售价 × (1 + 商品税率)</li>
                                <li>${priceInfo.netPrice.toFixed(2)} × (1 + ${(inputs.outputTaxRate*100).toFixed(0)}%)</li>
                                <li>= ${priceInfo.finalPrice.toFixed(2)}元</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="section">
                    <h3>进货成本分析</h3>
                    <ul>
                        <li>产品成本（不含税）：${purchaseCost.purchasePrice.toFixed(2)} 元</li>
                        <li>开票费用（${(inputs.inputTaxRate*100).toFixed(0)}%）：${purchaseCost.invoiceCost.toFixed(2)} 元</li>
                        <li>实际支付总额：${purchaseCost.totalPurchaseCost.toFixed(2)} 元</li>
                        <li>可抵扣进项税（${(inputs.outputTaxRate*100).toFixed(0)}%）：${purchaseCost.purchaseVAT.toFixed(2)} 元
                            <ul>
                                <li>这部分税额将来可以抵减销项税，相当于未来的税收收益</li>
                                <li>注意：这不是立即的现金收益，而是在销售环节产生销项税时才能抵扣</li>
                            </ul>
                        </li>
                        <li>税后实际成本：${purchaseCost.effectiveCost.toFixed(2)} 元
                            <ul>
                                <li>这是考虑了进项税抵扣后的实际成本压力</li>
                                <li>计算方式：实际支付总额 - 可抵扣进项税</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="section">
                    <h3>销售成本（考虑退货率${(salesCost.returnRate*100).toFixed(0)}%）</h3>
                    <div class="field-hint">由于退货率${(salesCost.returnRate*100).toFixed(0)}%，意味着每100单中有${(salesCost.returnRate*100).toFixed(0)}单会退货，以下成本会由${(salesCost.effectiveRate*100).toFixed(0)}单成功销售的订单分摊承担</div>
                    <ul>
                        <li>广告费用：${(adCost / salesCost.effectiveRate).toFixed(2)} 元
                            <ul>
                                <li>基础广告费（${(inputs.adRate*100).toFixed(0)}%）：${adCost.toFixed(2)} 元</li>
                                <li>分摊后每单广告费：${adCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(adCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                <li>广告费进项税（6%，可抵扣）：${priceInfo.adVAT.toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>物流费用：${inputs.shippingCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.shipping.toFixed(2)} 元</li>
                        <li>运费险：${inputs.shippingInsurance.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.insurance.toFixed(2)} 元</li>
                        <li>其他成本：${inputs.otherCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${salesCost.operationalCosts.other.toFixed(2)} 元</li>
                        <li>总运营成本：${salesCost.totalOperationalCost.toFixed(2)} 元</li>
                    </ul>
                </div>

                <div class="section">
                    <h3>税费分析</h3>
                    <ul>
                        <li>销项税额（应收）：${priceInfo.outputVAT.toFixed(2)} 元</li>
                        <li>进项税额（可抵扣）：${(purchaseCost.purchaseVAT + priceInfo.adVAT).toFixed(2)} 元
                            <ul>
                                <li>商品进项税：${purchaseCost.purchaseVAT.toFixed(2)} 元</li>
                                <li>广告费进项税：${priceInfo.adVAT.toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>实际应缴税额：${priceInfo.actualVAT.toFixed(2)} 元</li>
                    </ul>
                </div>

                <div class="section">
                    <h3>最终结果</h3>
                    <ul>
                        <li>有效成本：
                            <ul>
                                <li>C（税后进货成本）：${purchaseCost.effectiveCost.toFixed(2)} 元</li>
                                <li>F 不可退回分摊：
                                    <ul>
                                        <li>广告费：${priceInfo.adCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(priceInfo.adCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>发货物流费：${inputs.shippingCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(inputs.shippingCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>运费险：${inputs.shippingInsurance.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(inputs.shippingInsurance / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>其他固定成本：${inputs.otherCost.toFixed(2)} ÷ ${(salesCost.effectiveRate*100).toFixed(0)}% = ${(inputs.otherCost / salesCost.effectiveRate).toFixed(2)} 元</li>
                                        <li>合计（F 不可退回/(1-R)）：${priceInfo.effectiveNonReturnableCost.toFixed(2)} 元</li>
                                    </ul>
                                </li>
                                <li>有效成本合计：${priceInfo.effectiveCostTotal.toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>不含税售价：${priceInfo.netPrice.toFixed(2)} 元</li>
                        <li>含税售价：${priceInfo.finalPrice.toFixed(2)} 元</li>
                        <li>平台佣金：
                            <ul>
                                <li>计算基数：含税售价 ${priceInfo.finalPrice.toFixed(2)} 元</li>
                                <li>费率：${(inputs.platformRate*100).toFixed(1)}%</li>
                                <li>佣金金额：${priceInfo.platformFee.toFixed(2)} 元</li>
                            </ul>
                        </li>
                        <li>预期利润：${priceInfo.profit.toFixed(2)} 元（${priceInfo.profitRate.toFixed(1)}%）</li>
                    </ul>
                </div>

                <p class="calculation-note">计算说明：</p>
                <ul class="calculation-note">
                    <li>进货相关：
                        <ul>
                            <li>实际支付总额 = 产品成本（不含税） + 开票费用</li>
                            <li>可抵扣进项税 = 产品成本 × 商品税率（${(inputs.outputTaxRate*100).toFixed(0)}%）</li>
                            <li>税后实际成本 = 实际支付总额 - 可抵扣进项税</li>
                            <li>注意：进项税抵扣是未来的税收收益，不是立即的现金减少</li>
                        </ul>
                    </li>
                    <li>广告费相关：
                        <ul>
                            <li>广告费 = 最终售价 × 广告费率（${(inputs.adRate*100).toFixed(0)}%）</li>
                            <li>广告费进项税 = 广告费 × 6%（可抵扣）</li>
                        </ul>
                    </li>
                    <li>税费相关：
                        <ul>
                            <li>销项税额 = 不含税售价 × 商品税率</li>
                            <li>实际应缴税额 = 销项税额 - 可抵扣进项税额（包括商品和广告费）</li>
                        </ul>
                    </li>
                    <li>其他计算：
                        <ul>
                            <li>平台佣金 = 含税售价 × 平台费率</li>
                            <li>预期利润 = 含税售价 × 目标利润率</li>
                        </ul>
                    </li>
                    <li>退货率影响：
                        <ul>
                            <li>有效销售率 = 1 - 退货率</li>
                            <li>仅不可退回成本分摊：分摊后不可退回成本 = 原始不可退回成本 ÷ 有效销售率</li>
                            <li>可退回费用（平台佣金、销项税）退货后可全额退回，不参与分摊</li>
                            <li>例如：不可退回成本5元，退货率20%，则分摊后不可退回成本 = 5 ÷ 80% = 6.25元</li>
                        </ul>
                    </li>
                </ul>
            `;
        }

        // 计算合理售价的主函数
        function calculate() {
            // 清除之前的错误信息
            document.getElementById("result").innerHTML = "";
            try {
                // 1. 获取并验证所有输入值
                const inputs = getValidatedInputs();
                
                // 2. 验证比例费用组合（按最终售价口径）：
                // 需满足 1 - (平台 + 销项税占比 + 目标利润 + 广告分摊 - 广告进项抵扣) > 0
                const returnRate = parseFloat(document.getElementById("returnRate").value) / 100 || 0;
                const effectiveRate = 1 - returnRate;
                const AD_VAT_RATE = 0.06;
                const taxFactorOnFinal = inputs.salesTaxRate / (1 + inputs.salesTaxRate);
                const adFactorEffective = inputs.adRate / effectiveRate;
                const adVatCreditFactor = AD_VAT_RATE * adFactorEffective;
                const profitFactorEffective = inputs.targetProfitRate / effectiveRate;
                const denominatorFinal = 1 - (inputs.platformRate + taxFactorOnFinal + profitFactorEffective + adFactorEffective - adVatCreditFactor);
                if (denominatorFinal <= 0) {
                    throw new Error("参数组合过高（平台、税费占比、目标利润、广告费(分摊) - 广告进项抵扣），无法计算有效售价");
                }

                // 3. 计算进货成本和可抵扣进项税
                const purchaseCost = calculatePurchaseCost(inputs);
                
                // 4. 计算销售成本和总可抵扣税额（不含广告费，因为广告费会基于最终售价计算）
                const salesCost = calculateSalesCost(inputs, 0, purchaseCost);
                
                // 5. 一次性计算最终价格和各项费用
                const priceInfo = calculatePrices(purchaseCost, salesCost, inputs);

                // 6. 更新销售成本预览
                updateSalesCostSummary(priceInfo.finalPrice);

                // 7. 显示结果
                document.getElementById("result").innerHTML = generateResultHtml(purchaseCost, salesCost, priceInfo, inputs);
            } catch (error) {
                // 显示错误信息
                document.getElementById("result").innerHTML = `
                    <div class="error">${error.message}</div>
                `;
            }
        }

        // 页面加载完成后加载保存的值并计算
        window.onload = function() {
            loadSavedInputs();
            calculate();
        };
        
        // 实时计算进货成本
        function updatePurchaseCostSummary() {
            try {
                const costPrice = parseFloat(document.getElementById("costPrice").value) || 0;
                const inputTaxRate = parseFloat(document.getElementById("inputTaxRate").value) / 100 || 0;
                const outputTaxRate = parseFloat(document.getElementById("outputTaxRate").value) / 100 || 0;

                const invoiceCost = costPrice * inputTaxRate;
                const totalPayment = costPrice + invoiceCost;
                const purchaseVAT = costPrice * outputTaxRate;
                const effectiveCost = totalPayment - purchaseVAT;

                document.getElementById("totalPayment").textContent = `¥${totalPayment.toFixed(2)}`;
                document.getElementById("effectiveCost").textContent = `¥${effectiveCost.toFixed(2)}`;
            } catch (error) {
                document.getElementById("totalPayment").textContent = "¥0.00";
                document.getElementById("effectiveCost").textContent = "¥0.00";
            }
        }

        // 实时计算销售成本
        function updateSalesCostSummary(finalPrice = 0) {
            try {
                // 获取基础输入值
                const shippingCost = parseFloat(document.getElementById("shippingCost").value) || 0;
                const shippingInsurance = parseFloat(document.getElementById("shippingInsurance").value) || 0;
                const otherCost = parseFloat(document.getElementById("otherCost").value) || 0;
                const returnRate = parseFloat(document.getElementById("returnRate").value) / 100 || 0;
                const salesTaxRate = parseFloat(document.getElementById("salesTaxRate").value) / 100 || 0;
                const platformRate = parseFloat(document.getElementById("platformRate").value) / 100 || 0;
                const adRate = parseFloat(document.getElementById("adRate").value) / 100 || 0;

                // 计算有效销售率（考虑退货）
                const effectiveRate = 1 - returnRate;

                // 计算固定成本（考虑退货分摊）
                const totalFixedCost = (shippingCost + shippingInsurance + otherCost) / effectiveRate;

                // 计算基于最终售价的费用
                const platformFee = finalPrice * platformRate;
                const adCost = finalPrice * adRate;
                // 广告费为不可退回，需按有效销售率分摊
                const adCostEffective = adCost / effectiveRate;
                const salesTax = finalPrice * salesTaxRate;

                // 计算总销售成本
                const totalSalesCost = totalFixedCost + platformFee + adCostEffective + salesTax;

                // 更新显示
                document.getElementById("totalFixedCost").textContent = `¥${totalFixedCost.toFixed(2)}`;
                document.getElementById("platformFeePreview").textContent = `¥${platformFee.toFixed(2)}`;
                document.getElementById("adCostPreview").textContent = `¥${adCostEffective.toFixed(2)}`;
                document.getElementById("salesTax").textContent = `¥${salesTax.toFixed(2)}`;
                document.getElementById("totalSalesCost").textContent = `¥${totalSalesCost.toFixed(2)}`;

                // 更新销项税率显示
                const salesTaxLabel = document.querySelector('#salesCostSummary div:nth-child(4) span:first-child');
                salesTaxLabel.textContent = `销项税（${(salesTaxRate * 100).toFixed(1)}%）：`;

            } catch (error) {
                document.getElementById("totalFixedCost").textContent = "¥0.00";
                document.getElementById("platformFeePreview").textContent = "¥0.00";
                document.getElementById("adCostPreview").textContent = "¥0.00";
                document.getElementById("salesTax").textContent = "¥0.00";
                document.getElementById("totalSalesCost").textContent = "¥0.00";
            }
        }

        // 为所有输入框添加实时计算功能
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                try {
                    // 获取并验证所有输入值
                    const inputs = getValidatedInputs();
                    
                    // 计算进货成本
                    const purchaseCost = calculatePurchaseCost(inputs);
                    
                    // 计算销售成本（不含广告费，因为广告费会基于最终售价计算）
                    const salesCost = calculateSalesCost(inputs, 0, purchaseCost);
                    
                    // 计算最终价格
                    const priceInfo = calculatePrices(purchaseCost, salesCost, inputs);

                    // 更新显示
                    updatePurchaseCostSummary();
                    updateSalesCostSummary(priceInfo.finalPrice);
                    calculate();
                } catch (error) {
                    updatePurchaseCostSummary();
                    updateSalesCostSummary(0);
                }
            });
        });

        // 页面加载时计算一次
        window.addEventListener('load', () => {
            try {
                // 获取并验证所有输入值
                const inputs = getValidatedInputs();
                
                // 计算进货成本
                const purchaseCost = calculatePurchaseCost(inputs);
                
                // 计算销售成本（不含广告费，因为广告费会基于最终售价计算）
                const salesCost = calculateSalesCost(inputs, 0, purchaseCost);
                
                // 计算最终价格
                const priceInfo = calculatePrices(purchaseCost, salesCost, inputs);

                // 更新显示
                updatePurchaseCostSummary();
                updateSalesCostSummary(priceInfo.finalPrice);
                calculate();
            } catch (error) {
                updatePurchaseCostSummary();
                updateSalesCostSummary(0);
            }
        });
    </script>
</body>
</html>