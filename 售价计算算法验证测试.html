<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”®ä»·è®¡ç®—ç®—æ³•éªŒè¯æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .input-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .input-item label { display: block; font-weight: bold; margin-bottom: 5px; }
        .input-item input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .test-button { background: #007cba; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; }
        .result-section { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§® å”®ä»·è®¡ç®—ç®—æ³•éªŒè¯æµ‹è¯•</h1>
        <p>éªŒè¯ä¿®å¤åçš„å”®ä»·è®¡ç®—ç®—æ³•ä¸æ­£ç¡®æ•°å­¦æ¨¡å‹çš„ä¸€è‡´æ€§</p>
        
        <!-- æµ‹è¯•1: åŸºç¡€å”®ä»·è®¡ç®—éªŒè¯ -->
        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•1: åŸºç¡€å”®ä»·è®¡ç®—éªŒè¯</h2>
            <div class="input-group">
                <div class="input-item">
                    <label>è¿›è´§ä»· (å…ƒ)</label>
                    <input type="number" id="test1_costPrice" value="50" step="0.01">
                </div>
                <div class="input-item">
                    <label>å¼€ç¥¨æˆæœ¬ (%)</label>
                    <input type="number" id="test1_inputTaxRate" value="1" step="0.1">
                </div>
                <div class="input-item">
                    <label>å•†å“è¿›é¡¹ç¨ç‡ (%)</label>
                    <input type="number" id="test1_outputTaxRate" value="13" step="0.1">
                </div>
                <div class="input-item">
                    <label>å¹³å°ä½£é‡‘ (%)</label>
                    <input type="number" id="test1_platformRate" value="5.5" step="0.1">
                </div>
                <div class="input-item">
                    <label>å¹¿å‘Šè´¹å æ¯” (%)</label>
                    <input type="number" id="test1_adRate" value="8" step="0.1">
                </div>
                <div class="input-item">
                    <label>é€€è´§ç‡ (%)</label>
                    <input type="number" id="test1_returnRate" value="20" step="0.1">
                </div>
                <div class="input-item">
                    <label>ç›®æ ‡åˆ©æ¶¦ç‡ (%)</label>
                    <input type="number" id="test1_targetProfitRate" value="8" step="0.1">
                </div>
                <div class="input-item">
                    <label>ç‰©æµè´¹ (å…ƒ)</label>
                    <input type="number" id="test1_shippingCost" value="8" step="0.01">
                </div>
            </div>
            <button class="test-button" onclick="runTest1()">ğŸš€ è¿è¡Œæµ‹è¯•1</button>
            <div id="test1_result" class="result-section" style="display: none;"></div>
        </div>
        
        <!-- æµ‹è¯•2: ç®—æ³•ä¸€è‡´æ€§éªŒè¯ -->
        <div class="test-section">
            <h2>ğŸ”„ æµ‹è¯•2: ç®—æ³•ä¸€è‡´æ€§éªŒè¯</h2>
            <p>éªŒè¯å”®ä»·è®¡ç®—â†’æˆæœ¬ä»·åæ¨â†’å†æ¬¡å”®ä»·è®¡ç®—çš„ä¸€è‡´æ€§</p>
            <button class="test-button" onclick="runTest2()">ğŸ”„ è¿è¡Œä¸€è‡´æ€§æµ‹è¯•</button>
            <div id="test2_result" class="result-section" style="display: none;"></div>
        </div>
    </div>

    <script src="js/calculator.js"></script>
    <script>
        // æ­£ç¡®ç®—æ³•å®ç°
        function calculateCorrectPrice(params) {
            const E = 1 - params.returnRate;
            const C_goods = params.costPrice * (1 + params.inputTaxRate);
            const C_fix = (params.shippingCost + (params.shippingInsurance||0) + (params.otherCost||0)) / E;
            const VAT_in_goods = params.costPrice * params.outputTaxRate;
            
            const Î± = params.platformRate;
            const Î² = params.adRate;
            const t = params.salesTaxRate || 0.13;
            const v = 0.06;
            const m = params.targetProfitRate;
            
            const A = 1 - Î± - Î²/E - t/(1+t) + v/(1+v)*(Î±+Î²);
            const K0 = C_goods + C_fix - VAT_in_goods;
            
            if (A - m <= 0) throw new Error('å‚æ•°ç»„åˆå¯¼è‡´æ— è§£');
            
            return { finalPrice: K0 / (A - m), A, K0 };
        }
        
        function runTest1() {
            try {
                const params = {
                    costPrice: parseFloat(document.getElementById('test1_costPrice').value),
                    inputTaxRate: parseFloat(document.getElementById('test1_inputTaxRate').value) / 100,
                    outputTaxRate: parseFloat(document.getElementById('test1_outputTaxRate').value) / 100,
                    platformRate: parseFloat(document.getElementById('test1_platformRate').value) / 100,
                    adRate: parseFloat(document.getElementById('test1_adRate').value) / 100,
                    returnRate: parseFloat(document.getElementById('test1_returnRate').value) / 100,
                    targetProfitRate: parseFloat(document.getElementById('test1_targetProfitRate').value) / 100,
                    shippingCost: parseFloat(document.getElementById('test1_shippingCost').value),
                    salesTaxRate: 0.13, shippingInsurance: 1, otherCost: 2
                };
                
                const correctResult = calculateCorrectPrice(params);
                const purchaseCost = calculatePurchaseCost(params);
                const salesCost = calculateSalesCost(params, 0, purchaseCost);
                const systemResult = calculatePrices(purchaseCost, salesCost, params);
                
                const priceDiff = Math.abs(correctResult.finalPrice - systemResult.finalPrice);
                const priceMatch = priceDiff < 0.01;
                
                document.getElementById('test1_result').style.display = 'block';
                document.getElementById('test1_result').innerHTML = `
                    <h3>æµ‹è¯•ç»“æœ</h3>
                    <p><strong>æ­£ç¡®ç®—æ³•è®¡ç®—å”®ä»·:</strong> Â¥${correctResult.finalPrice.toFixed(2)}</p>
                    <p><strong>ç³»ç»Ÿç®—æ³•è®¡ç®—å”®ä»·:</strong> Â¥${systemResult.finalPrice.toFixed(2)}</p>
                    <p><strong>ä»·æ ¼å·®å¼‚:</strong> <span class="${priceMatch ? 'success' : 'error'}">Â¥${priceDiff.toFixed(4)}</span></p>
                    <p><strong>æµ‹è¯•ç»“æœ:</strong> <span class="${priceMatch ? 'success' : 'error'}">${priceMatch ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</span></p>
                `;
            } catch (error) {
                document.getElementById('test1_result').innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                document.getElementById('test1_result').style.display = 'block';
            }
        }
        
        function runTest2() {
            const testCases = [
                { costPrice: 50, adRate: 0.08, targetProfitRate: 0.08 },
                { costPrice: 100, adRate: 0.05, targetProfitRate: 0.12 },
                { costPrice: 30, adRate: 0.10, targetProfitRate: 0.06 }
            ];
            
            let results = [];
            testCases.forEach((testCase, index) => {
                try {
                    const params = {
                        inputTaxRate: 0.01, outputTaxRate: 0.13, salesTaxRate: 0.13,
                        platformRate: 0.055, returnRate: 0.20, shippingCost: 8,
                        shippingInsurance: 1, otherCost: 2, ...testCase
                    };
                    
                    // è®¡ç®—å”®ä»·
                    const purchaseCost = calculatePurchaseCost(params);
                    const salesCost = calculateSalesCost(params, 0, purchaseCost);
                    const priceResult = calculatePrices(purchaseCost, salesCost, params);
                    const finalPrice = priceResult.finalPrice;
                    
                    // åæ¨æˆæœ¬ä»·
                    const reversedCostPrice = calculateCostPriceByClosedForm(finalPrice, testCase.adRate, testCase.targetProfitRate, params);
                    
                    // å†æ¬¡è®¡ç®—å”®ä»·
                    const verifyParams = { ...params, costPrice: reversedCostPrice };
                    const verifyPurchaseCost = calculatePurchaseCost(verifyParams);
                    const verifySalesCost = calculateSalesCost(verifyParams, 0, verifyPurchaseCost);
                    const verifyPriceResult = calculatePrices(verifyPurchaseCost, verifySalesCost, verifyParams);
                    
                    const costDiff = Math.abs(testCase.costPrice - reversedCostPrice);
                    const priceDiff = Math.abs(finalPrice - verifyPriceResult.finalPrice);
                    const consistent = costDiff < 0.01 && priceDiff < 0.01;
                    
                    results.push({ index: index + 1, originalCost: testCase.costPrice, reversedCost: reversedCostPrice, costDiff, priceDiff, consistent });
                } catch (error) {
                    results.push({ index: index + 1, error: error.message, consistent: false });
                }
            });
            
            let tableHtml = `<h3>ç®—æ³•ä¸€è‡´æ€§æµ‹è¯•ç»“æœ</h3><table><thead><tr><th>ç”¨ä¾‹</th><th>åŸå§‹æˆæœ¬ä»·</th><th>åæ¨æˆæœ¬ä»·</th><th>æˆæœ¬å·®å¼‚</th><th>ç»“æœ</th></tr></thead><tbody>`;
            results.forEach(result => {
                const statusText = result.consistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´';
                if (result.error) {
                    tableHtml += `<tr><td>${result.index}</td><td colspan="3">é”™è¯¯: ${result.error}</td><td>${statusText}</td></tr>`;
                } else {
                    tableHtml += `<tr><td>${result.index}</td><td>Â¥${result.originalCost.toFixed(2)}</td><td>Â¥${result.reversedCost.toFixed(2)}</td><td>Â¥${result.costDiff.toFixed(4)}</td><td>${statusText}</td></tr>`;
                }
            });
            tableHtml += '</tbody></table>';
            
            document.getElementById('test2_result').style.display = 'block';
            document.getElementById('test2_result').innerHTML = tableHtml;
        }
    </script>
</body>
</html>