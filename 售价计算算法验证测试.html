<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>售价计算算法验证测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .input-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px; }
        .input-item label { display: block; font-weight: bold; margin-bottom: 5px; }
        .input-item input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .test-button { background: #007cba; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; }
        .result-section { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧮 售价计算算法验证测试</h1>
        <p>验证修复后的售价计算算法与正确数学模型的一致性</p>
        
        <!-- 测试1: 基础售价计算验证 -->
        <div class="test-section">
            <h2>📊 测试1: 基础售价计算验证</h2>
            <div class="input-group">
                <div class="input-item">
                    <label>进货价 (元)</label>
                    <input type="number" id="test1_costPrice" value="50" step="0.01">
                </div>
                <div class="input-item">
                    <label>开票成本 (%)</label>
                    <input type="number" id="test1_inputTaxRate" value="1" step="0.1">
                </div>
                <div class="input-item">
                    <label>商品进项税率 (%)</label>
                    <input type="number" id="test1_outputTaxRate" value="13" step="0.1">
                </div>
                <div class="input-item">
                    <label>平台佣金 (%)</label>
                    <input type="number" id="test1_platformRate" value="5.5" step="0.1">
                </div>
                <div class="input-item">
                    <label>广告费占比 (%)</label>
                    <input type="number" id="test1_adRate" value="8" step="0.1">
                </div>
                <div class="input-item">
                    <label>退货率 (%)</label>
                    <input type="number" id="test1_returnRate" value="20" step="0.1">
                </div>
                <div class="input-item">
                    <label>目标利润率 (%)</label>
                    <input type="number" id="test1_targetProfitRate" value="8" step="0.1">
                </div>
                <div class="input-item">
                    <label>物流费 (元)</label>
                    <input type="number" id="test1_shippingCost" value="8" step="0.01">
                </div>
            </div>
            <button class="test-button" onclick="runTest1()">🚀 运行测试1</button>
            <div id="test1_result" class="result-section" style="display: none;"></div>
        </div>
        
        <!-- 测试2: 算法一致性验证 -->
        <div class="test-section">
            <h2>🔄 测试2: 算法一致性验证</h2>
            <p>验证售价计算→成本价反推→再次售价计算的一致性</p>
            <button class="test-button" onclick="runTest2()">🔄 运行一致性测试</button>
            <div id="test2_result" class="result-section" style="display: none;"></div>
        </div>
    </div>

    <script src="js/calculator.js"></script>
    <script>
        // 正确算法实现
        function calculateCorrectPrice(params) {
            const E = 1 - params.returnRate;
            const C_goods = params.costPrice * (1 + params.inputTaxRate);
            const C_fix = (params.shippingCost + (params.shippingInsurance||0) + (params.otherCost||0)) / E;
            const VAT_in_goods = params.costPrice * params.outputTaxRate;
            
            const α = params.platformRate;
            const β = params.adRate;
            const t = params.salesTaxRate || 0.13;
            const v = 0.06;
            const m = params.targetProfitRate;
            
            const A = 1 - α - β/E - t/(1+t) + v/(1+v)*(α+β);
            const K0 = C_goods + C_fix - VAT_in_goods;
            
            if (A - m <= 0) throw new Error('参数组合导致无解');
            
            return { finalPrice: K0 / (A - m), A, K0 };
        }
        
        function runTest1() {
            try {
                const params = {
                    costPrice: parseFloat(document.getElementById('test1_costPrice').value),
                    inputTaxRate: parseFloat(document.getElementById('test1_inputTaxRate').value) / 100,
                    outputTaxRate: parseFloat(document.getElementById('test1_outputTaxRate').value) / 100,
                    platformRate: parseFloat(document.getElementById('test1_platformRate').value) / 100,
                    adRate: parseFloat(document.getElementById('test1_adRate').value) / 100,
                    returnRate: parseFloat(document.getElementById('test1_returnRate').value) / 100,
                    targetProfitRate: parseFloat(document.getElementById('test1_targetProfitRate').value) / 100,
                    shippingCost: parseFloat(document.getElementById('test1_shippingCost').value),
                    salesTaxRate: 0.13, shippingInsurance: 1, otherCost: 2
                };
                
                const correctResult = calculateCorrectPrice(params);
                const purchaseCost = calculatePurchaseCost(params);
                const salesCost = calculateSalesCost(params, 0, purchaseCost);
                const systemResult = calculatePrices(purchaseCost, salesCost, params);
                
                const priceDiff = Math.abs(correctResult.finalPrice - systemResult.finalPrice);
                const priceMatch = priceDiff < 0.01;
                
                document.getElementById('test1_result').style.display = 'block';
                document.getElementById('test1_result').innerHTML = `
                    <h3>测试结果</h3>
                    <p><strong>正确算法计算售价:</strong> ¥${correctResult.finalPrice.toFixed(2)}</p>
                    <p><strong>系统算法计算售价:</strong> ¥${systemResult.finalPrice.toFixed(2)}</p>
                    <p><strong>价格差异:</strong> <span class="${priceMatch ? 'success' : 'error'}">¥${priceDiff.toFixed(4)}</span></p>
                    <p><strong>测试结果:</strong> <span class="${priceMatch ? 'success' : 'error'}">${priceMatch ? '✅ 通过' : '❌ 失败'}</span></p>
                `;
            } catch (error) {
                document.getElementById('test1_result').innerHTML = `<div class="error">测试失败: ${error.message}</div>`;
                document.getElementById('test1_result').style.display = 'block';
            }
        }
        
        function runTest2() {
            const testCases = [
                { costPrice: 50, adRate: 0.08, targetProfitRate: 0.08 },
                { costPrice: 100, adRate: 0.05, targetProfitRate: 0.12 },
                { costPrice: 30, adRate: 0.10, targetProfitRate: 0.06 }
            ];
            
            let results = [];
            testCases.forEach((testCase, index) => {
                try {
                    const params = {
                        inputTaxRate: 0.01, outputTaxRate: 0.13, salesTaxRate: 0.13,
                        platformRate: 0.055, returnRate: 0.20, shippingCost: 8,
                        shippingInsurance: 1, otherCost: 2, ...testCase
                    };
                    
                    // 计算售价
                    const purchaseCost = calculatePurchaseCost(params);
                    const salesCost = calculateSalesCost(params, 0, purchaseCost);
                    const priceResult = calculatePrices(purchaseCost, salesCost, params);
                    const finalPrice = priceResult.finalPrice;
                    
                    // 反推成本价
                    const reversedCostPrice = calculateCostPriceByClosedForm(finalPrice, testCase.adRate, testCase.targetProfitRate, params);
                    
                    // 再次计算售价
                    const verifyParams = { ...params, costPrice: reversedCostPrice };
                    const verifyPurchaseCost = calculatePurchaseCost(verifyParams);
                    const verifySalesCost = calculateSalesCost(verifyParams, 0, verifyPurchaseCost);
                    const verifyPriceResult = calculatePrices(verifyPurchaseCost, verifySalesCost, verifyParams);
                    
                    const costDiff = Math.abs(testCase.costPrice - reversedCostPrice);
                    const priceDiff = Math.abs(finalPrice - verifyPriceResult.finalPrice);
                    const consistent = costDiff < 0.01 && priceDiff < 0.01;
                    
                    results.push({ index: index + 1, originalCost: testCase.costPrice, reversedCost: reversedCostPrice, costDiff, priceDiff, consistent });
                } catch (error) {
                    results.push({ index: index + 1, error: error.message, consistent: false });
                }
            });
            
            let tableHtml = `<h3>算法一致性测试结果</h3><table><thead><tr><th>用例</th><th>原始成本价</th><th>反推成本价</th><th>成本差异</th><th>结果</th></tr></thead><tbody>`;
            results.forEach(result => {
                const statusText = result.consistent ? '✅ 一致' : '❌ 不一致';
                if (result.error) {
                    tableHtml += `<tr><td>${result.index}</td><td colspan="3">错误: ${result.error}</td><td>${statusText}</td></tr>`;
                } else {
                    tableHtml += `<tr><td>${result.index}</td><td>¥${result.originalCost.toFixed(2)}</td><td>¥${result.reversedCost.toFixed(2)}</td><td>¥${result.costDiff.toFixed(4)}</td><td>${statusText}</td></tr>`;
                }
            });
            tableHtml += '</tbody></table>';
            
            document.getElementById('test2_result').style.display = 'block';
            document.getElementById('test2_result').innerHTML = tableHtml;
        }
    </script>
</body>
</html>