<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>利润计算算法验证测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .diff { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .number { text-align: right; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>利润计算算法验证测试</h1>
    <p>此测试页面用于验证修复后的利润计算算法与用户提供的正确算法是否一致。</p>

    <div class="test-section">
        <h2>测试参数设置</h2>
        <table>
            <tr><th>参数</th><th>值</th><th>说明</th></tr>
            <tr><td>进货价（不含税）</td><td id="costPrice">100</td><td>costPrice</td></tr>
            <tr><td>开票成本比例</td><td id="inputTaxRate">0.06</td><td>inputTaxRate (6%)</td></tr>
            <tr><td>商品进项税率</td><td id="outputTaxRate">0.13</td><td>outputTaxRate (13%)</td></tr>
            <tr><td>含税售价</td><td id="sellingPrice">200</td><td>sellingPrice</td></tr>
            <tr><td>销项税率</td><td id="salesTaxRate">0.13</td><td>salesTaxRate (13%)</td></tr>
            <tr><td>平台佣金比例</td><td id="platformRate">0.05</td><td>platformRate (5%)</td></tr>
            <tr><td>广告费占比</td><td id="adRate">0.08</td><td>adRate (8%)</td></tr>
            <tr><td>物流费</td><td id="shippingCost">10</td><td>shippingCost</td></tr>
            <tr><td>运费险</td><td id="shippingInsurance">2</td><td>shippingInsurance</td></tr>
            <tr><td>其他成本</td><td id="otherCost">3</td><td>otherCost</td></tr>
            <tr><td>退货率</td><td id="returnRate">0.10</td><td>returnRate (10%)</td></tr>
        </table>
        <button onclick="runTest()">运行测试</button>
        <button onclick="changeTestCase()">切换测试用例</button>
    </div>

    <div class="test-section">
        <h2>计算结果对比</h2>
        <div id="testResults">点击"运行测试"开始验证</div>
    </div>

    <div class="test-section">
        <h2>详细计算过程对比</h2>
        <div id="detailResults"></div>
    </div>

    <script src="js/calculator.js"></script>
    <script>
        // 测试用例
        const testCases = [
            {
                name: "基础测试用例",
                params: {
                    costPrice: 100,
                    inputTaxRate: 0.06,
                    outputTaxRate: 0.13,
                    sellingPrice: 200,
                    salesTaxRate: 0.13,
                    platformRate: 0.05,
                    adRate: 0.08,
                    shippingCost: 10,
                    shippingInsurance: 2,
                    otherCost: 3,
                    returnRate: 0.10
                }
            },
            {
                name: "高利润率测试",
                params: {
                    costPrice: 50,
                    inputTaxRate: 0.06,
                    outputTaxRate: 0.13,
                    sellingPrice: 300,
                    salesTaxRate: 0.13,
                    platformRate: 0.03,
                    adRate: 0.05,
                    shippingCost: 8,
                    shippingInsurance: 1,
                    otherCost: 2,
                    returnRate: 0.05
                }
            },
            {
                name: "低利润率测试",
                params: {
                    costPrice: 180,
                    inputTaxRate: 0.06,
                    outputTaxRate: 0.13,
                    sellingPrice: 200,
                    salesTaxRate: 0.13,
                    platformRate: 0.08,
                    adRate: 0.12,
                    shippingCost: 15,
                    shippingInsurance: 3,
                    otherCost: 5,
                    returnRate: 0.15
                }
            }
        ];

        let currentTestCase = 0;

        function updateTestParams() {
            const params = testCases[currentTestCase].params;
            Object.keys(params).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = params[key];
                }
            });
        }

        function changeTestCase() {
            currentTestCase = (currentTestCase + 1) % testCases.length;
            updateTestParams();
            document.getElementById('testResults').innerHTML = `已切换到：${testCases[currentTestCase].name}，点击"运行测试"开始验证`;
        }

        function runTest() {
            const params = testCases[currentTestCase].params;
            
            // 运行修复后的系统计算
            const systemResult = calculateProfitUnified({
                costPrice: params.costPrice,
                actualPrice: params.sellingPrice,
                inputTaxRate: params.inputTaxRate,
                outputTaxRate: params.outputTaxRate,
                salesTaxRate: params.salesTaxRate,
                platformRate: params.platformRate,
                adRate: params.adRate,
                shippingCost: params.shippingCost,
                shippingInsurance: params.shippingInsurance,
                otherCost: params.otherCost,
                returnRate: params.returnRate
            });

            // 运行正确算法
            const correctResult = calculateProfitCorrect(params);

            // 显示结果对比
            displayResults(systemResult, correctResult, params);
        }

        function displayResults(systemResult, correctResult, params) {
            const resultsDiv = document.getElementById('testResults');
            const detailDiv = document.getElementById('detailResults');

            // 核心指标对比
            const profitDiff = Math.abs(systemResult.profit - correctResult.profit);
            const profitRateDiff = Math.abs(systemResult.profitRate - (correctResult.profit / params.sellingPrice));
            
            let resultClass = 'success';
            let resultMessage = '算法一致性验证通过';

            if (profitDiff > 0.01 || profitRateDiff > 0.0001) {
                resultClass = 'diff';
                resultMessage = '发现差异，需要进一步检查';
            }

            resultsDiv.innerHTML = `
                <div class="result ${resultClass}">
                    <h3>${testCases[currentTestCase].name} - ${resultMessage}</h3>
                    <table>
                        <tr><th>指标</th><th>修复后系统</th><th>正确算法</th><th>差异</th></tr>
                        <tr>
                            <td>利润</td>
                            <td class="number">¥${systemResult.profit.toFixed(2)}</td>
                            <td class="number">¥${correctResult.profit.toFixed(2)}</td>
                            <td class="number">${profitDiff.toFixed(4)}</td>
                        </tr>
                        <tr>
                            <td>利润率</td>
                            <td class="number">${(systemResult.profitRate * 100).toFixed(2)}%</td>
                            <td class="number">${(correctResult.profit / params.sellingPrice * 100).toFixed(2)}%</td>
                            <td class="number">${(profitRateDiff * 100).toFixed(4)}%</td>
                        </tr>
                        <tr>
                            <td>有效率</td>
                            <td class="number">${((1-params.returnRate) * 100).toFixed(1)}%</td>
                            <td class="number">${(correctResult.breakdown.E * 100).toFixed(1)}%</td>
                            <td class="number">-</td>
                        </tr>
                    </table>
                </div>
            `;

            // 详细过程对比
            detailDiv.innerHTML = `
                <h3>详细计算过程对比</h3>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <h4>修复后系统算法</h4>
                        <table>
                            <tr><th>项目</th><th>金额</th></tr>
                            <tr><td>实际成本</td><td class="number">¥${systemResult.effectiveCost.toFixed(2)}</td></tr>
                            <tr><td>平台佣金</td><td class="number">¥${systemResult.platformFee.toFixed(2)}</td></tr>
                            <tr><td>分摊广告费</td><td class="number">¥${systemResult.adCostEffective.toFixed(2)}</td></tr>
                            <tr><td>分摊物流费</td><td class="number">¥${systemResult.shippingCostEffective.toFixed(2)}</td></tr>
                            <tr><td>分摊运费险</td><td class="number">¥${systemResult.insuranceCostEffective.toFixed(2)}</td></tr>
                            <tr><td>分摊其他成本</td><td class="number">¥${systemResult.otherCostEffective.toFixed(2)}</td></tr>
                            <tr><td>实际税负</td><td class="number">¥${systemResult.actualVAT.toFixed(2)}</td></tr>
                            <tr><td>总成本</td><td class="number">¥${systemResult.totalCost.toFixed(2)}</td></tr>
                            <tr><td><strong>利润</strong></td><td class="number"><strong>¥${systemResult.profit.toFixed(2)}</strong></td></tr>
                        </table>
                    </div>
                    <div style="flex: 1;">
                        <h4>正确算法（用户提供）</h4>
                        <table>
                            <tr><th>项目</th><th>金额</th></tr>
                            <tr><td>进货净成本</td><td class="number">¥${correctResult.breakdown.goodsCost.toFixed(2)}</td></tr>
                            <tr><td>平台成本</td><td class="number">¥${correctResult.breakdown.platformCost.toFixed(2)}</td></tr>
                            <tr><td>分摊广告费</td><td class="number">¥${correctResult.breakdown.adCost.toFixed(2)}</td></tr>
                            <tr><td>固定成本分摊</td><td class="number">¥${correctResult.breakdown.fixCost.toFixed(2)}</td></tr>
                            <tr><td>销项税</td><td class="number">¥${correctResult.breakdown.outputVAT.toFixed(2)}</td></tr>
                            <tr><td>进项税总计</td><td class="number">¥${correctResult.breakdown.inputVAT_total.toFixed(2)}</td></tr>
                            <tr><td>净税负</td><td class="number">¥${correctResult.breakdown.netTax.toFixed(2)}</td></tr>
                            <tr><td>显性成本合计</td><td class="number">¥${correctResult.breakdown.totalCost.toFixed(2)}</td></tr>
                            <tr><td><strong>利润</strong></td><td class="number"><strong>¥${correctResult.profit.toFixed(2)}</strong></td></tr>
                        </table>
                    </div>
                </div>
            `;
        }

        // 页面加载完成后初始化
        window.onload = function() {
            updateTestParams();
        };
    </script>
</body>
</html>