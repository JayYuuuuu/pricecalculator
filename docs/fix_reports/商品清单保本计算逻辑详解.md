# 商品清单表格保本ROI和保本广告占比计算逻辑详解

## 📋 概述

本文档详细解析商品清单表格中"保本ROI"和"保本广告占比"列的计算方法和实现逻辑，包括核心算法、计算流程和代码实现。

## 🔢 核心计算逻辑

### 1. 计算入口函数

商品清单表格中的保本ROI和保本广告占比通过以下函数计算：

```javascript
// 位置：js/calculator.js L6380-6418
function computeRowWithCost(rowStd, costPrice) {
    // 使用统一的保本分析函数
    const roiResult = calculateBreakevenROI({
        costPrice: costPrice,
        inputTaxRate: rowStd.inputTaxRate,
        outputTaxRate: rowStd.outputTaxRate,
        salesTaxRate: rowStd.salesTaxRate,
        platformRate: rowStd.platformRate,
        shippingCost: rowStd.shippingCost,
        shippingInsurance: rowStd.shippingInsurance,
        otherCost: rowStd.otherCost,
        returnRate: rowStd.returnRate,
        finalPrice: P // 含税售价
    });
    
    return {
        breakevenROI: roiResult.breakevenROI,
        breakevenAdRate: roiResult.breakevenAdRate
    };
}
```

### 2. 核心算法函数：calculateBreakevenROI

```javascript
// 位置：js/calculator.js L1266-1328
function calculateBreakevenROI(params) {
    // 1) 参数读取和校验
    const costPrice = Number(params.costPrice) || 0;
    const inputTaxRate = Math.max(0, Number(params.inputTaxRate) || 0);
    const outputTaxRate = Math.max(0, Number(params.outputTaxRate) || 0);
    const salesTaxRate = Math.max(0, Number(params.salesTaxRate) || 0);
    const platformRate = Math.max(0, Number(params.platformRate) || 0);
    const shippingCost = Math.max(0, Number(params.shippingCost) || 0);
    const shippingInsurance = Math.max(0, Number(params.shippingInsurance) || 0);
    const otherCost = Math.max(0, Number(params.otherCost) || 0);
    const returnRate = Math.min(0.9999, Math.max(0, Number(params.returnRate) || 0));
    const finalPrice = Number(params.finalPrice) || 0;

    // 2) 计算关键中间量
    const E = 1 - returnRate;                                              // 有效销售率
    const C_goods = costPrice * (1 + inputTaxRate);                        // 进货净成本
    const C_fix = (shippingCost + shippingInsurance + otherCost) / E;       // 固定成本摊到有效单
    const VAT_in_goods = costPrice * outputTaxRate;                        // 商品进项税额（可抵扣）
    const K0 = C_goods + C_fix - VAT_in_goods;                            // 常数K₀
    
    const α = platformRate;                                                 // 平台佣金率
    const t = salesTaxRate;                                                // 销项税率
    const v = 0.06;                                                        // 服务业税率

    // 3) 基于保本条件反解广告占比
    const baseConstant = 1 - α - t/(1+t) + v/(1+v)*α;                     // 不含广告的基础常数
    const K0_ratio = K0 / finalPrice;                                      // K₀占售价比例
    const adTaxFactor = 1 - v/(1+v);                                       // 广告费税务因子
    
    const breakevenAdRate = E * (baseConstant - K0_ratio) / adTaxFactor;

    // 4) 计算保本ROI
    let breakevenROI;
    if (breakevenAdRate <= 0) {
        breakevenROI = Infinity; // 无需广告即可保本
    } else if (!isFinite(breakevenAdRate)) {
        breakevenROI = NaN;
    } else {
        breakevenROI = E / breakevenAdRate; // ROI = 有效销售率 ÷ 保本广告占比
        if (breakevenAdRate >= 1) {
            // 需要广告占比≥100%才保本，基本不可行
            feasible = false;
        }
    }

    return { breakevenAdRate, breakevenROI, feasible, note };
}
```

## 📐 数学推导过程

### 1. 保本状态方程

在保本状态下，收入等于成本：
```
含税售价 = 进货成本 + 固定成本 + 广告费净成本 + 其他费用
```

### 2. 关键中间量计算

- **有效销售率 E** = 1 - 退货率
- **实际进货成本 C_goods** = 进货价 + 进货价 × 开票成本比例
- **商品进项税 VAT_in_goods** = 进货价 × 商品进项税率
- **固定成本分摊 C_fix** = (物流费 + 运费险 + 其他成本) ÷ 有效销售率
- **销项税占比** = 销项税率 ÷ (1 + 销项税率)

### 3. 保本广告占比计算公式

```
保本广告占比 = (有效销售率 ÷ (1 - 6%)) × (D - B ÷ 含税售价)

其中：
- B = 实际进货成本 - 商品进项税 + 固定成本分摊
- D = 1 - 平台佣金比例 - 销项税占比 + (6% ÷ (1 + 6%)) × 平台佣金比例
```

### 4. 保本ROI计算公式

```
保本ROI = 有效销售率 ÷ 保本广告占比
```

**数学原理**：
- ROI = 有效GMV ÷ 广告费
- 有效GMV = 含税售价 × 有效销售率
- 广告费 = 含税售价 × 保本广告占比
- 因此：保本ROI = (含税售价 × 有效销售率) ÷ (含税售价 × 保本广告占比) = 有效销售率 ÷ 保本广告占比

## 💻 表格显示逻辑

### 1. 表格渲染函数

```javascript
// 位置：js/calculator.js L6650+
function renderCatalogTable() {
    // 保本ROI列显示
    `<td class="lp-col-right" style="white-space:nowrap;">${(function(){
        if (Array.isArray(res.list)) return res.list.map(x=>`<div>${isFinite(x.breakevenROI)? Number(x.breakevenROI).toFixed(2) : '∞'}</div>`).join('');
        if (Array.isArray(res.priceRangeResults)) return res.priceRangeResults.map(x=>`<div>${fmtRange(x.breakevenROI,false,false)}</div>`).join('');
        if (Array.isArray(res.combinations)) return res.combinations.map(x=>`<div>${isFinite(x.breakevenROI)? Number(x.breakevenROI).toFixed(2) : '∞'}</div>`).join('');
        return roiText;
    })()}</td>`
    
    // 保本广告占比列显示
    `<td class="lp-col-right" style="white-space:nowrap;">${(function(){
        const renderAd = (a)=>{
            const text = (!isFinite(a)||isNaN(a))? '-' : (a<=0? '0%' : (a*100).toFixed(2)+'%');
            const over = isFinite(a)&&a>=1;
            const isDanger = isFinite(a) && a > 0 && a < 0.21; // 低于21%的实时预警
            
            const dangerStyle = isDanger ? 'background:#dc2626; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; animation:pulse-warning 2s infinite;' : '';
            const dangerIcon = isDanger ? '⚠️ ' : '';
            
            return `<div style="position:relative; display:inline-block; ${dangerStyle}">${dangerIcon}${text}${over?'<span title="需≥100%付费占比才保本" style="position:absolute; right:-8px; top:-4px; width:6px; height:6px; background:#ef4444; border-radius:50%;"></span>':''}</div>`;
        };
        // ... 处理多档情况的逻辑
        return buildAdCell(res.breakevenAdRate);
    })()}</td>`
}
```

### 2. 显示特性

#### 保本ROI显示规则：
- **有限数值**：保留2位小数（如 "2.45"）
- **无穷大**：显示为 "∞"（无需广告即可保本）
- **异常值**：显示为 "-"（计算不可行）

#### 保本广告占比显示规则：
- **正常范围**：显示为百分比（如 "28.90%"）
- **零或负值**：显示为 "0%"（无需广告即可保本）
- **≥100%**：显示百分比并添加红点预警⚠️
- **<21%**：添加红色背景和闪烁动画预警
- **异常值**：显示为 "-"

## 🔄 多档位计算逻辑

### 1. 单一计算（单价格单成本）
```javascript
const result = computeRowWithCost(rowStd, costPrice);
return {
    breakevenROI: result.breakevenROI,
    breakevenAdRate: result.breakevenAdRate
};
```

### 2. 多档计算（多价格多成本）
```javascript
if (salePriceTiers.length > 0 && costTiers.length > 0) {
    const list = salePriceTiers.map((price, i) => {
        const cost = costTiers[i];
        const rowWithPrice = { ...std, salePrice: price };
        const r = computeRowWithCost(rowWithPrice, cost);
        return { cost, price, ...r };
    });
    return { __result: { list, errors: [] } };
}
```

### 3. 区间计算（价格区间或成本区间）
```javascript
const range = (a,b) => { 
    if (!isFinite(a)&&!isFinite(b)) return '-'; 
    if (Math.abs(a-b)<1e-9) return a; 
    return {min:Math.min(a,b), max:Math.max(a,b)}; 
};
return {
    breakevenROI: range(resMin.breakevenROI, resMax.breakevenROI),
    breakevenAdRate: range(resMin.breakevenAdRate, resMax.breakevenAdRate)
};
```

## ⚙️ 参数来源

### 1. 全局默认参数
```javascript
function getGlobalDefaultsForCatalog() {
    return {
        inputTaxRate: 0.06,        // 开票成本比例 6%
        outputTaxRate: 0.13,       // 商品进项税率 13%
        salesTaxRate: 0.13,        // 销项税率 13%
        platformRate: 0.05,        // 平台佣金比例 5%
        shippingCost: 8,           // 物流费 8元
        shippingInsurance: 0.5,    // 运费险 0.5元
        otherCost: 2,              // 其他成本 2元
        returnRate: 0.15           // 退货率 15%
    };
}
```

### 2. 行级参数覆盖
```javascript
function mergeGlobalsWithRow(row, globals) {
    return {
        ...globals,
        ...row,  // 行级参数覆盖全局参数
        costPrice: row.costMin || row.costMax || 0,
        salePrice: row.salePrice || 0
    };
}
```

## 🎯 计算流程总结

1. **参数获取**：从全局设置和行数据中获取计算参数
2. **参数校验**：确保所有参数在合理范围内
3. **中间量计算**：计算有效销售率、进货成本、固定成本等
4. **保本条件求解**：基于利润=0的条件反解保本广告占比
5. **ROI计算**：ROI = 有效销售率 ÷ 保本广告占比
6. **结果展示**：根据计算结果和显示规则在表格中展示

## 📊 验证和调试

### 计算验证方法
1. **手工验证**：使用验证浮窗功能查看详细计算过程
2. **一致性检查**：确保与利润计算页面结果一致
3. **边界测试**：测试极值情况（如退货率接近100%）

### 常见问题排查
1. **显示"∞"**：表示无需广告即可保本，检查成本设置是否过低
2. **显示"-"**：表示计算不可行，检查参数是否合理
3. **红色预警**：表示保本广告占比过高，需要优化成本结构

## 📝 结论

商品清单表格中的保本ROI和保本广告占比计算采用统一的`calculateBreakevenROI`函数，基于严格的数学推导，考虑了税务抵扣、有效销售率等关键因素，确保计算结果的准确性和一致性。系统支持单档、多档和区间计算，并提供了丰富的显示特性和预警机制。