# å•†å“æ¸…å•è¡¨æ ¼ä¿æœ¬ROIå’Œä¿æœ¬å¹¿å‘Šå æ¯”è®¡ç®—é€»è¾‘è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£æå•†å“æ¸…å•è¡¨æ ¼ä¸­"ä¿æœ¬ROI"å’Œ"ä¿æœ¬å¹¿å‘Šå æ¯”"åˆ—çš„è®¡ç®—æ–¹æ³•å’Œå®ç°é€»è¾‘ï¼ŒåŒ…æ‹¬æ ¸å¿ƒç®—æ³•ã€è®¡ç®—æµç¨‹å’Œä»£ç å®ç°ã€‚

## ğŸ”¢ æ ¸å¿ƒè®¡ç®—é€»è¾‘

### 1. è®¡ç®—å…¥å£å‡½æ•°

å•†å“æ¸…å•è¡¨æ ¼ä¸­çš„ä¿æœ¬ROIå’Œä¿æœ¬å¹¿å‘Šå æ¯”é€šè¿‡ä»¥ä¸‹å‡½æ•°è®¡ç®—ï¼š

```javascript
// ä½ç½®ï¼šjs/calculator.js L6380-6418
function computeRowWithCost(rowStd, costPrice) {
    // ä½¿ç”¨ç»Ÿä¸€çš„ä¿æœ¬åˆ†æå‡½æ•°
    const roiResult = calculateBreakevenROI({
        costPrice: costPrice,
        inputTaxRate: rowStd.inputTaxRate,
        outputTaxRate: rowStd.outputTaxRate,
        salesTaxRate: rowStd.salesTaxRate,
        platformRate: rowStd.platformRate,
        shippingCost: rowStd.shippingCost,
        shippingInsurance: rowStd.shippingInsurance,
        otherCost: rowStd.otherCost,
        returnRate: rowStd.returnRate,
        finalPrice: P // å«ç¨å”®ä»·
    });
    
    return {
        breakevenROI: roiResult.breakevenROI,
        breakevenAdRate: roiResult.breakevenAdRate
    };
}
```

### 2. æ ¸å¿ƒç®—æ³•å‡½æ•°ï¼šcalculateBreakevenROI

```javascript
// ä½ç½®ï¼šjs/calculator.js L1266-1328
function calculateBreakevenROI(params) {
    // 1) å‚æ•°è¯»å–å’Œæ ¡éªŒ
    const costPrice = Number(params.costPrice) || 0;
    const inputTaxRate = Math.max(0, Number(params.inputTaxRate) || 0);
    const outputTaxRate = Math.max(0, Number(params.outputTaxRate) || 0);
    const salesTaxRate = Math.max(0, Number(params.salesTaxRate) || 0);
    const platformRate = Math.max(0, Number(params.platformRate) || 0);
    const shippingCost = Math.max(0, Number(params.shippingCost) || 0);
    const shippingInsurance = Math.max(0, Number(params.shippingInsurance) || 0);
    const otherCost = Math.max(0, Number(params.otherCost) || 0);
    const returnRate = Math.min(0.9999, Math.max(0, Number(params.returnRate) || 0));
    const finalPrice = Number(params.finalPrice) || 0;

    // 2) è®¡ç®—å…³é”®ä¸­é—´é‡
    const E = 1 - returnRate;                                              // æœ‰æ•ˆé”€å”®ç‡
    const C_goods = costPrice * (1 + inputTaxRate);                        // è¿›è´§å‡€æˆæœ¬
    const C_fix = (shippingCost + shippingInsurance + otherCost) / E;       // å›ºå®šæˆæœ¬æ‘Šåˆ°æœ‰æ•ˆå•
    const VAT_in_goods = costPrice * outputTaxRate;                        // å•†å“è¿›é¡¹ç¨é¢ï¼ˆå¯æŠµæ‰£ï¼‰
    const K0 = C_goods + C_fix - VAT_in_goods;                            // å¸¸æ•°Kâ‚€
    
    const Î± = platformRate;                                                 // å¹³å°ä½£é‡‘ç‡
    const t = salesTaxRate;                                                // é”€é¡¹ç¨ç‡
    const v = 0.06;                                                        // æœåŠ¡ä¸šç¨ç‡

    // 3) åŸºäºä¿æœ¬æ¡ä»¶åè§£å¹¿å‘Šå æ¯”
    const baseConstant = 1 - Î± - t/(1+t) + v/(1+v)*Î±;                     // ä¸å«å¹¿å‘Šçš„åŸºç¡€å¸¸æ•°
    const K0_ratio = K0 / finalPrice;                                      // Kâ‚€å å”®ä»·æ¯”ä¾‹
    const adTaxFactor = 1 - v/(1+v);                                       // å¹¿å‘Šè´¹ç¨åŠ¡å› å­
    
    const breakevenAdRate = E * (baseConstant - K0_ratio) / adTaxFactor;

    // 4) è®¡ç®—ä¿æœ¬ROI
    let breakevenROI;
    if (breakevenAdRate <= 0) {
        breakevenROI = Infinity; // æ— éœ€å¹¿å‘Šå³å¯ä¿æœ¬
    } else if (!isFinite(breakevenAdRate)) {
        breakevenROI = NaN;
    } else {
        breakevenROI = E / breakevenAdRate; // ROI = æœ‰æ•ˆé”€å”®ç‡ Ã· ä¿æœ¬å¹¿å‘Šå æ¯”
        if (breakevenAdRate >= 1) {
            // éœ€è¦å¹¿å‘Šå æ¯”â‰¥100%æ‰ä¿æœ¬ï¼ŒåŸºæœ¬ä¸å¯è¡Œ
            feasible = false;
        }
    }

    return { breakevenAdRate, breakevenROI, feasible, note };
}
```

## ğŸ“ æ•°å­¦æ¨å¯¼è¿‡ç¨‹

### 1. ä¿æœ¬çŠ¶æ€æ–¹ç¨‹

åœ¨ä¿æœ¬çŠ¶æ€ä¸‹ï¼Œæ”¶å…¥ç­‰äºæˆæœ¬ï¼š
```
å«ç¨å”®ä»· = è¿›è´§æˆæœ¬ + å›ºå®šæˆæœ¬ + å¹¿å‘Šè´¹å‡€æˆæœ¬ + å…¶ä»–è´¹ç”¨
```

### 2. å…³é”®ä¸­é—´é‡è®¡ç®—

- **æœ‰æ•ˆé”€å”®ç‡ E** = 1 - é€€è´§ç‡
- **å®é™…è¿›è´§æˆæœ¬ C_goods** = è¿›è´§ä»· + è¿›è´§ä»· Ã— å¼€ç¥¨æˆæœ¬æ¯”ä¾‹
- **å•†å“è¿›é¡¹ç¨ VAT_in_goods** = è¿›è´§ä»· Ã— å•†å“è¿›é¡¹ç¨ç‡
- **å›ºå®šæˆæœ¬åˆ†æ‘Š C_fix** = (ç‰©æµè´¹ + è¿è´¹é™© + å…¶ä»–æˆæœ¬) Ã· æœ‰æ•ˆé”€å”®ç‡
- **é”€é¡¹ç¨å æ¯”** = é”€é¡¹ç¨ç‡ Ã· (1 + é”€é¡¹ç¨ç‡)

### 3. ä¿æœ¬å¹¿å‘Šå æ¯”è®¡ç®—å…¬å¼

```
ä¿æœ¬å¹¿å‘Šå æ¯” = (æœ‰æ•ˆé”€å”®ç‡ Ã· (1 - 6%)) Ã— (D - B Ã· å«ç¨å”®ä»·)

å…¶ä¸­ï¼š
- B = å®é™…è¿›è´§æˆæœ¬ - å•†å“è¿›é¡¹ç¨ + å›ºå®šæˆæœ¬åˆ†æ‘Š
- D = 1 - å¹³å°ä½£é‡‘æ¯”ä¾‹ - é”€é¡¹ç¨å æ¯” + (6% Ã· (1 + 6%)) Ã— å¹³å°ä½£é‡‘æ¯”ä¾‹
```

### 4. ä¿æœ¬ROIè®¡ç®—å…¬å¼

```
ä¿æœ¬ROI = æœ‰æ•ˆé”€å”®ç‡ Ã· ä¿æœ¬å¹¿å‘Šå æ¯”
```

**æ•°å­¦åŸç†**ï¼š
- ROI = æœ‰æ•ˆGMV Ã· å¹¿å‘Šè´¹
- æœ‰æ•ˆGMV = å«ç¨å”®ä»· Ã— æœ‰æ•ˆé”€å”®ç‡
- å¹¿å‘Šè´¹ = å«ç¨å”®ä»· Ã— ä¿æœ¬å¹¿å‘Šå æ¯”
- å› æ­¤ï¼šä¿æœ¬ROI = (å«ç¨å”®ä»· Ã— æœ‰æ•ˆé”€å”®ç‡) Ã· (å«ç¨å”®ä»· Ã— ä¿æœ¬å¹¿å‘Šå æ¯”) = æœ‰æ•ˆé”€å”®ç‡ Ã· ä¿æœ¬å¹¿å‘Šå æ¯”

## ğŸ’» è¡¨æ ¼æ˜¾ç¤ºé€»è¾‘

### 1. è¡¨æ ¼æ¸²æŸ“å‡½æ•°

```javascript
// ä½ç½®ï¼šjs/calculator.js L6650+
function renderCatalogTable() {
    // ä¿æœ¬ROIåˆ—æ˜¾ç¤º
    `<td class="lp-col-right" style="white-space:nowrap;">${(function(){
        if (Array.isArray(res.list)) return res.list.map(x=>`<div>${isFinite(x.breakevenROI)? Number(x.breakevenROI).toFixed(2) : 'âˆ'}</div>`).join('');
        if (Array.isArray(res.priceRangeResults)) return res.priceRangeResults.map(x=>`<div>${fmtRange(x.breakevenROI,false,false)}</div>`).join('');
        if (Array.isArray(res.combinations)) return res.combinations.map(x=>`<div>${isFinite(x.breakevenROI)? Number(x.breakevenROI).toFixed(2) : 'âˆ'}</div>`).join('');
        return roiText;
    })()}</td>`
    
    // ä¿æœ¬å¹¿å‘Šå æ¯”åˆ—æ˜¾ç¤º
    `<td class="lp-col-right" style="white-space:nowrap;">${(function(){
        const renderAd = (a)=>{
            const text = (!isFinite(a)||isNaN(a))? '-' : (a<=0? '0%' : (a*100).toFixed(2)+'%');
            const over = isFinite(a)&&a>=1;
            const isDanger = isFinite(a) && a > 0 && a < 0.21; // ä½äº21%çš„å®æ—¶é¢„è­¦
            
            const dangerStyle = isDanger ? 'background:#dc2626; color:#fff; padding:2px 6px; border-radius:4px; font-weight:700; animation:pulse-warning 2s infinite;' : '';
            const dangerIcon = isDanger ? 'âš ï¸ ' : '';
            
            return `<div style="position:relative; display:inline-block; ${dangerStyle}">${dangerIcon}${text}${over?'<span title="éœ€â‰¥100%ä»˜è´¹å æ¯”æ‰ä¿æœ¬" style="position:absolute; right:-8px; top:-4px; width:6px; height:6px; background:#ef4444; border-radius:50%;"></span>':''}</div>`;
        };
        // ... å¤„ç†å¤šæ¡£æƒ…å†µçš„é€»è¾‘
        return buildAdCell(res.breakevenAdRate);
    })()}</td>`
}
```

### 2. æ˜¾ç¤ºç‰¹æ€§

#### ä¿æœ¬ROIæ˜¾ç¤ºè§„åˆ™ï¼š
- **æœ‰é™æ•°å€¼**ï¼šä¿ç•™2ä½å°æ•°ï¼ˆå¦‚ "2.45"ï¼‰
- **æ— ç©·å¤§**ï¼šæ˜¾ç¤ºä¸º "âˆ"ï¼ˆæ— éœ€å¹¿å‘Šå³å¯ä¿æœ¬ï¼‰
- **å¼‚å¸¸å€¼**ï¼šæ˜¾ç¤ºä¸º "-"ï¼ˆè®¡ç®—ä¸å¯è¡Œï¼‰

#### ä¿æœ¬å¹¿å‘Šå æ¯”æ˜¾ç¤ºè§„åˆ™ï¼š
- **æ­£å¸¸èŒƒå›´**ï¼šæ˜¾ç¤ºä¸ºç™¾åˆ†æ¯”ï¼ˆå¦‚ "28.90%"ï¼‰
- **é›¶æˆ–è´Ÿå€¼**ï¼šæ˜¾ç¤ºä¸º "0%"ï¼ˆæ— éœ€å¹¿å‘Šå³å¯ä¿æœ¬ï¼‰
- **â‰¥100%**ï¼šæ˜¾ç¤ºç™¾åˆ†æ¯”å¹¶æ·»åŠ çº¢ç‚¹é¢„è­¦âš ï¸
- **<21%**ï¼šæ·»åŠ çº¢è‰²èƒŒæ™¯å’Œé—ªçƒåŠ¨ç”»é¢„è­¦
- **å¼‚å¸¸å€¼**ï¼šæ˜¾ç¤ºä¸º "-"

## ğŸ”„ å¤šæ¡£ä½è®¡ç®—é€»è¾‘

### 1. å•ä¸€è®¡ç®—ï¼ˆå•ä»·æ ¼å•æˆæœ¬ï¼‰
```javascript
const result = computeRowWithCost(rowStd, costPrice);
return {
    breakevenROI: result.breakevenROI,
    breakevenAdRate: result.breakevenAdRate
};
```

### 2. å¤šæ¡£è®¡ç®—ï¼ˆå¤šä»·æ ¼å¤šæˆæœ¬ï¼‰
```javascript
if (salePriceTiers.length > 0 && costTiers.length > 0) {
    const list = salePriceTiers.map((price, i) => {
        const cost = costTiers[i];
        const rowWithPrice = { ...std, salePrice: price };
        const r = computeRowWithCost(rowWithPrice, cost);
        return { cost, price, ...r };
    });
    return { __result: { list, errors: [] } };
}
```

### 3. åŒºé—´è®¡ç®—ï¼ˆä»·æ ¼åŒºé—´æˆ–æˆæœ¬åŒºé—´ï¼‰
```javascript
const range = (a,b) => { 
    if (!isFinite(a)&&!isFinite(b)) return '-'; 
    if (Math.abs(a-b)<1e-9) return a; 
    return {min:Math.min(a,b), max:Math.max(a,b)}; 
};
return {
    breakevenROI: range(resMin.breakevenROI, resMax.breakevenROI),
    breakevenAdRate: range(resMin.breakevenAdRate, resMax.breakevenAdRate)
};
```

## âš™ï¸ å‚æ•°æ¥æº

### 1. å…¨å±€é»˜è®¤å‚æ•°
```javascript
function getGlobalDefaultsForCatalog() {
    return {
        inputTaxRate: 0.06,        // å¼€ç¥¨æˆæœ¬æ¯”ä¾‹ 6%
        outputTaxRate: 0.13,       // å•†å“è¿›é¡¹ç¨ç‡ 13%
        salesTaxRate: 0.13,        // é”€é¡¹ç¨ç‡ 13%
        platformRate: 0.05,        // å¹³å°ä½£é‡‘æ¯”ä¾‹ 5%
        shippingCost: 8,           // ç‰©æµè´¹ 8å…ƒ
        shippingInsurance: 0.5,    // è¿è´¹é™© 0.5å…ƒ
        otherCost: 2,              // å…¶ä»–æˆæœ¬ 2å…ƒ
        returnRate: 0.15           // é€€è´§ç‡ 15%
    };
}
```

### 2. è¡Œçº§å‚æ•°è¦†ç›–
```javascript
function mergeGlobalsWithRow(row, globals) {
    return {
        ...globals,
        ...row,  // è¡Œçº§å‚æ•°è¦†ç›–å…¨å±€å‚æ•°
        costPrice: row.costMin || row.costMax || 0,
        salePrice: row.salePrice || 0
    };
}
```

## ğŸ¯ è®¡ç®—æµç¨‹æ€»ç»“

1. **å‚æ•°è·å–**ï¼šä»å…¨å±€è®¾ç½®å’Œè¡Œæ•°æ®ä¸­è·å–è®¡ç®—å‚æ•°
2. **å‚æ•°æ ¡éªŒ**ï¼šç¡®ä¿æ‰€æœ‰å‚æ•°åœ¨åˆç†èŒƒå›´å†…
3. **ä¸­é—´é‡è®¡ç®—**ï¼šè®¡ç®—æœ‰æ•ˆé”€å”®ç‡ã€è¿›è´§æˆæœ¬ã€å›ºå®šæˆæœ¬ç­‰
4. **ä¿æœ¬æ¡ä»¶æ±‚è§£**ï¼šåŸºäºåˆ©æ¶¦=0çš„æ¡ä»¶åè§£ä¿æœ¬å¹¿å‘Šå æ¯”
5. **ROIè®¡ç®—**ï¼šROI = æœ‰æ•ˆé”€å”®ç‡ Ã· ä¿æœ¬å¹¿å‘Šå æ¯”
6. **ç»“æœå±•ç¤º**ï¼šæ ¹æ®è®¡ç®—ç»“æœå’Œæ˜¾ç¤ºè§„åˆ™åœ¨è¡¨æ ¼ä¸­å±•ç¤º

## ğŸ“Š éªŒè¯å’Œè°ƒè¯•

### è®¡ç®—éªŒè¯æ–¹æ³•
1. **æ‰‹å·¥éªŒè¯**ï¼šä½¿ç”¨éªŒè¯æµ®çª—åŠŸèƒ½æŸ¥çœ‹è¯¦ç»†è®¡ç®—è¿‡ç¨‹
2. **ä¸€è‡´æ€§æ£€æŸ¥**ï¼šç¡®ä¿ä¸åˆ©æ¶¦è®¡ç®—é¡µé¢ç»“æœä¸€è‡´
3. **è¾¹ç•Œæµ‹è¯•**ï¼šæµ‹è¯•æå€¼æƒ…å†µï¼ˆå¦‚é€€è´§ç‡æ¥è¿‘100%ï¼‰

### å¸¸è§é—®é¢˜æ’æŸ¥
1. **æ˜¾ç¤º"âˆ"**ï¼šè¡¨ç¤ºæ— éœ€å¹¿å‘Šå³å¯ä¿æœ¬ï¼Œæ£€æŸ¥æˆæœ¬è®¾ç½®æ˜¯å¦è¿‡ä½
2. **æ˜¾ç¤º"-"**ï¼šè¡¨ç¤ºè®¡ç®—ä¸å¯è¡Œï¼Œæ£€æŸ¥å‚æ•°æ˜¯å¦åˆç†
3. **çº¢è‰²é¢„è­¦**ï¼šè¡¨ç¤ºä¿æœ¬å¹¿å‘Šå æ¯”è¿‡é«˜ï¼Œéœ€è¦ä¼˜åŒ–æˆæœ¬ç»“æ„

## ğŸ“ ç»“è®º

å•†å“æ¸…å•è¡¨æ ¼ä¸­çš„ä¿æœ¬ROIå’Œä¿æœ¬å¹¿å‘Šå æ¯”è®¡ç®—é‡‡ç”¨ç»Ÿä¸€çš„`calculateBreakevenROI`å‡½æ•°ï¼ŒåŸºäºä¸¥æ ¼çš„æ•°å­¦æ¨å¯¼ï¼Œè€ƒè™‘äº†ç¨åŠ¡æŠµæ‰£ã€æœ‰æ•ˆé”€å”®ç‡ç­‰å…³é”®å› ç´ ï¼Œç¡®ä¿è®¡ç®—ç»“æœçš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ç³»ç»Ÿæ”¯æŒå•æ¡£ã€å¤šæ¡£å’ŒåŒºé—´è®¡ç®—ï¼Œå¹¶æä¾›äº†ä¸°å¯Œçš„æ˜¾ç¤ºç‰¹æ€§å’Œé¢„è­¦æœºåˆ¶ã€‚