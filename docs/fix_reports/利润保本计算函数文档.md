# 利润、保本ROI、保本广告占比计算函数文档

## 📋 概述

本文档提供了三个核心计算函数的JavaScript伪代码实现，用于计算电商业务的利润、保本ROI和保本广告占比。所有函数都严格使用系统内定义的字段名称，确保与现有代码的一致性。

## 🔧 常量定义

```javascript
// 服务业（广告/平台）增值税税率 6%（可抵扣）
const SERVICE_VAT = 0.06;
```

## 💰 利润计算函数

### 函数名：`calculateProfit` **假设名字**

**功能**：计算每个有效成交的利润

**参数说明**：
- `costPrice`：进货价（不含税）
- `inputTaxRate`：开票成本比例
- `outputTaxRate`：商品进项税率（可抵扣）
- `sellingPrice`：售价（含税）
- `salesTaxRate`：销项税率
- `platformRate`：平台佣金率
- `adRate`：广告费占比（含税/按售价）
- `shippingCost`：物流费
- `shippingInsurance`：运费险
- `otherCost`：其他成本
- `returnRate`：退货率

**计算逻辑**：

```javascript
/**
 * 利润（每个有效成交）
 */
function calculateProfit(params) {
  const {
    costPrice,          // 进货价（不含税）
    inputTaxRate,       // 开票成本比例
    outputTaxRate,      // 商品进项税率（可抵扣）
    sellingPrice,       // 售价（含税）
    salesTaxRate,       // 销项税率
    platformRate,       // 平台佣金率
    adRate,             // 广告费占比（含税/按售价）
    shippingCost,       // 物流费
    shippingInsurance,  // 运费险
    otherCost,          // 其他成本
    returnRate          // 退货率
  } = params;

  // 1) 有效率
  const E = 1 - returnRate;

  // 2) 成本口径（全部净额，不含税）
  const goodsCost = costPrice * (1 + inputTaxRate);                        // 进货净成本
  const fixCost   = (shippingCost + shippingInsurance + otherCost) / E;    // 固定成本随发货摊到有效单
  const adCost    = (sellingPrice * adRate) / E;                            // 广告费也需随发货摊到有效单（含税金额，见税处理）
  const platformCost = sellingPrice * platformRate;                         // 平台佣金按成交计（含税金额，见税处理）

  // 3) 税金（价内口径）
  const outputVAT = sellingPrice * (salesTaxRate / (1 + salesTaxRate));     // 销项税额（含税价拆出的税额）
  const inputVAT_goods    = costPrice * outputTaxRate;                      // 商品进项税额（已知为不含税价×进项税率）
  const inputVAT_ad       = (sellingPrice * adRate) * (SERVICE_VAT / (1 + SERVICE_VAT));      // 广告费可抵扣部分
  const inputVAT_platform = platformCost * (SERVICE_VAT / (1 + SERVICE_VAT));                 // 平台费可抵扣部分
  const inputVAT_total    = inputVAT_goods + inputVAT_ad + inputVAT_platform;
  const netTax            = outputVAT - inputVAT_total;                     // 税负净额

  // 4) 总成本（注意：adCost、platformCost是含税金额，此处按"显性支出"口径相加）
  const totalCost = goodsCost + fixCost + adCost + platformCost;

  // 5) 利润（每个有效成交）
  const profit = sellingPrice - totalCost - netTax;

  return {
    profit,
    breakdown: {
      E, goodsCost, fixCost, adCost, platformCost,
      outputVAT, inputVAT_total, netTax
    }
  };
}
```

**返回值**：
- `profit`：利润金额
- `breakdown`：详细计算过程

## 🎯 保本计算函数

### 函数名：`calculateBreakeven`  **假设名**

**功能**：计算保本广告占比和保本ROI

**计算逻辑**：

```javascript
/**
 * 保本广告占比（a*，定义为"含税广告费 / 含税成交额"）与 保本 ROI（E/a*）
 * 说明：全部从不含税方程推导，再用 (1+6%) 做税制桥回到"含税占比"口径
 */
function calculateBreakeven(params) {
  const {
    costPrice,
    inputTaxRate,
    sellingPrice,
    salesTaxRate,
    platformRate,
    shippingCost,
    shippingInsurance,
    otherCost,
    returnRate
  } = params;

  const P = sellingPrice;
  const tOut = salesTaxRate;
  const v = SERVICE_VAT;
  const alpha = platformRate;
  const E = 1 - returnRate;

  // 成本（不含税）：进货净成本 + 固定成本（按有效率摊）
  const goodsCost = costPrice * (1 + inputTaxRate);
  const fixCost   = (shippingCost + shippingInsurance + otherCost) / E;
  const C = goodsCost + fixCost;                 // 不含税成本金额
  const k = C / P;                               // 不含税成本占售价的比例

  // 不含税收入系数 与 佣金不含税系数
  const revenueCoeff = 1 / (1 + tOut);           // 含税售价 -> 不含税收入的系数
  const commissionCoeff = alpha / (1 + v);       // 含税抽成 -> 不含税抽成的系数

  // 关键项（不含税方程中的"空间"）
  const term = revenueCoeff - commissionCoeff - k;

  // term <= 0 表示保本不可能（成本已吞没收入）
  if (term <= 0) {
    return { 
      breakevenAdRate: NaN, 
      breakevenROI: NaN, 
      feasible: false, 
      debug: { term, E, k, revenueCoeff, commissionCoeff } 
    };
  }

  // 含税广告占比 a*（税制桥：×(1+v)），再除以 E（因为广告按成交计，但我们在方程里按不含税写在 E·… 里）
  // 最终：a* = (1+v) * E * term
  const breakevenAdRate = (1 + v) * E * term;

  // 保本 ROI（按"有效GMV/含税广告费"）：ROI* = E / a*
  const breakevenROI = E / breakevenAdRate;

  return {
    breakevenAdRate,  // 保本广告占比（含税）
    breakevenROI,     // 保本 ROI
    feasible: true,
    debug: { term, E, k, revenueCoeff, commissionCoeff }
  };
}
```

**返回值**：
- `breakevenAdRate`：保本广告占比（含税）
- `breakevenROI`：保本ROI
- `feasible`：是否可行
- `debug`：调试信息

## 🔄 聚合计算函数

### 函数名：`calculateAll`  **假设名**

**功能**：一次返回利润和保本指标

```javascript
/**
 * 聚合：一次返回利润 + 保本指标
 */
function calculateAll(params) {
  const profitPart = calculateProfit(params);
  const bePart = calculateBreakeven(params);
  return { ...profitPart, ...bePart };
}
```

## 📊 使用示例

### 标准参数示例

```javascript
const params = {
  costPrice: 38,           // 进货价（不含税）
  inputTaxRate: 0.06,      // 开票成本比例 6%
  outputTaxRate: 0.13,     // 商品进项税率 13%
  sellingPrice: 100,       // 售价（含税）
  salesTaxRate: 0.13,      // 销项税率 13%
  platformRate: 0.055,     // 平台佣金率 5.5%
  adRate: 0.20,            // 广告费占比 20%
  shippingCost: 2.8,       // 物流费
  shippingInsurance: 1.5,  // 运费险
  otherCost: 2.5,          // 其他成本
  returnRate: 0.20          // 退货率 20%
};

// 计算所有指标
const results = calculateAll(params);
console.log('利润:', results.profit);
console.log('保本广告占比:', results.breakevenAdRate);
console.log('保本ROI:', results.breakevenROI);
```

## ⚠️ 重要说明与校验要点

### 1. 成本计算规则
- **`goodsCost = costPrice * (1 + inputTaxRate)`**：不再减进项税，这是实际支付给供应商的金额
- **固定成本与广告费**：都用 `/E` 做退货摊销，因为是不可退回成本
- **平台佣金**：不用摊销，因为可退回

### 2. 进项税抵扣规则
- **商品进项税**：`costPrice * outputTaxRate`
- **广告费进项税**：`(sellingPrice * adRate) * (0.06 / 1.06)`
- **平台费进项税**：`platformCost * (0.06 / 1.06)`
- **注意**：金额别用比例，要用实际金额

### 3. 保本计算规则
- **保本广告占比**：`a* = (1+6%) * E * ( 1/(1+t_out) − α/(1+6%) − C/P )`
- **保本ROI**：`ROI* = E / a*`
- **可行性判断**：若 `term ≤ 0`，直接返回不可保本（`feasible: false`）

### 4. 税制桥接
- 所有计算都基于不含税方程推导
- 最后用 `(1+6%)` 做税制桥回到"含税占比"口径
- 确保与系统现有计算逻辑完全一致

## 🔍 字段对照表

| 函数参数 | 系统字段ID | 中文名称 | 说明 |
|-----------|------------|----------|------|
| `costPrice` | `costPrice` | 进货价（不含税） | 基础进货成本 |
| `inputTaxRate` | `inputTaxRate` | 开票成本比例 | 供应商开票额外费用 |
| `outputTaxRate` | `outputTaxRate` | 商品进项税率 | 可抵扣的商品进项税率 |
| `sellingPrice` | `sellingPrice` | 售价（含税） | 实际销售价格 |
| `salesTaxRate` | `salesTaxRate` | 销项税率 | 销售时的增值税率 |
| `platformRate` | `platformRate` | 平台佣金率 | 平台抽佣比例 |
| `adRate` | `adRate` | 广告费占比 | 全店付费推广占比 |
| `shippingCost` | `shippingCost` | 物流费 | 每单物流成本 |
| `shippingInsurance` | `shippingInsurance` | 运费险 | 每单运费保险费 |
| `otherCost` | `otherCost` | 其他成本 | 包装材料等固定成本 |
| `returnRate` | `returnRate` | 退货率 | 预期退货率 |

## 📈 计算流程总结

1. **利润计算**：基于实际售价，计算各项成本和税负，得出净利润
2. **保本分析**：从不含税方程推导，计算保本所需的广告占比和ROI阈值
3. **税制处理**：统一使用6%的服务业税率进行进项税抵扣计算
4. **成本分摊**：不可退回成本按有效率分摊，可退回成本不参与分摊

## 🚀 扩展应用

这些函数可以用于：
- 实时利润监控
- 广告投放策略优化
- 定价策略制定
- 成本结构分析
- 批量产品计算

---

**文档版本**: v1.0  
**最后更新**: 2024年  
**维护人员**: 开发团队  
**适用系统**: E-commerce Rational Pricing Calculator
