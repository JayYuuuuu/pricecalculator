<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据显示错误修复验证测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-params {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .param-group {
            display: flex;
            flex-direction: column;
        }
        .param-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .param-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-button {
            background: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #e9ecef;
        }
        .result-card h3 {
            margin-top: 0;
            color: #495057;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .result-row:last-child {
            border-bottom: none;
        }
        .result-value {
            font-weight: bold;
        }
        .match {
            color: #28a745;
            background: #d4edda;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .mismatch {
            color: #dc3545;
            background: #f8d7da;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .comparison {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .debug-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 数据显示错误修复验证测试</h1>
        <p>此页面用于验证修复后的 <code>calculateBreakevenROI</code> 函数是否与 price.html 电脑端的计算结果一致。</p>
        
        <h2>测试参数</h2>
        <div class="test-params">
            <div class="param-group">
                <label>进货价（元）</label>
                <input type="number" id="costPrice" value="38" step="0.01">
            </div>
            <div class="param-group">
                <label>开票成本比例（%）</label>
                <input type="number" id="inputTaxRate" value="6" step="0.1">
            </div>
            <div class="param-group">
                <label>商品进项税率（%）</label>
                <input type="number" id="outputTaxRate" value="13" step="0.1">
            </div>
            <div class="param-group">
                <label>销项税率（%）</label>
                <input type="number" id="salesTaxRate" value="13" step="0.1">
            </div>
            <div class="param-group">
                <label>平台佣金（%）</label>
                <input type="number" id="platformRate" value="5.5" step="0.1">
            </div>
            <div class="param-group">
                <label>物流费（元）</label>
                <input type="number" id="shippingCost" value="2.8" step="0.01">
            </div>
            <div class="param-group">
                <label>运费险（元）</label>
                <input type="number" id="shippingInsurance" value="1.5" step="0.01">
            </div>
            <div class="param-group">
                <label>其他成本（元）</label>
                <input type="number" id="otherCost" value="2.5" step="0.01">
            </div>
            <div class="param-group">
                <label>退货率（%）</label>
                <input type="number" id="returnRate" value="20" step="1">
            </div>
            <div class="param-group">
                <label>含税售价（元）</label>
                <input type="number" id="finalPrice" value="79" step="0.01">
            </div>
        </div>
        
        <button class="test-button" onclick="runComparison()">🧪 运行对比测试</button>
        <button class="test-button" onclick="runBatchTests()">🔄 运行批量测试</button>
        <button class="test-button" onclick="loadDefaultParams()">📋 加载默认参数</button>
    </div>

    <div class="results-container" id="resultsContainer" style="display: none;">
        <div class="result-card">
            <h3>🎯 Price.html 电脑端算法（正确标准）</h3>
            <div id="priceHtmlResults"></div>
        </div>
        <div class="result-card">
            <h3>🔧 修复后的 calculateBreakevenROI 函数</h3>
            <div id="calculatorResults"></div>
        </div>
    </div>

    <div class="comparison" id="comparisonResults" style="display: none;">
        <h3>📊 对比分析结果</h3>
        <div id="comparisonContent"></div>
    </div>

    <script src="js/calculator.js"></script>
    <script>
        // Price.html 电脑端的正确算法实现
        function calculateBreakevenROI_PriceHtml(params) {
            try {
                const {
                    costPrice,
                    inputTaxRate,
                    outputTaxRate,
                    salesTaxRate,
                    platformRate,
                    shippingCost,
                    shippingInsurance,
                    otherCost,
                    returnRate,
                    finalPrice
                } = params;

                // Price.html 电脑端的算法逻辑
                const effectiveSalesRate = 1 - returnRate;
                const effectiveCost = costPrice + (costPrice * inputTaxRate);
                const fixedCosts = (shippingCost + shippingInsurance + otherCost) / effectiveSalesRate;
                
                const t = salesTaxRate;
                const taxFactorOnFinal = t / (1 + t);
                const B = effectiveCost + fixedCosts;
                
                const v = 0.06;
                const platformVatCredit = (platformRate / (1 + v)) * v;
                const D = 1 - platformRate - taxFactorOnFinal + platformVatCredit;

                const term = D - (B / finalPrice);
                const breakevenAdRate = (effectiveSalesRate / (1 - v/(1 + v))) * term;

                let breakevenROI;
                if (breakevenAdRate <= 0) {
                    breakevenROI = Infinity;
                } else if (!isFinite(breakevenAdRate) || breakevenAdRate >= 1) {
                    breakevenROI = NaN;
                } else {
                    breakevenROI = effectiveSalesRate / breakevenAdRate;
                }

                return {
                    breakevenAdRate,
                    breakevenROI,
                    feasible: isFinite(breakevenROI) && breakevenROI > 0,
                    note: breakevenAdRate <= 0 ? '无需广告也能保本' : 
                          breakevenAdRate >= 1 ? '不现实：需广告占比≥100%' : '',
                    debug: {
                        effectiveSalesRate,
                        effectiveCost,
                        fixedCosts,
                        B,
                        D,
                        term,
                        v,
                        taxFactorOnFinal,
                        platformVatCredit
                    }
                };
            } catch (error) {
                return {
                    breakevenAdRate: NaN,
                    breakevenROI: NaN,
                    feasible: false,
                    note: '计算失败: ' + error.message
                };
            }
        }

        function getInputParams() {
            return {
                costPrice: parseFloat(document.getElementById('costPrice').value) || 0,
                inputTaxRate: (parseFloat(document.getElementById('inputTaxRate').value) || 0) / 100,
                outputTaxRate: (parseFloat(document.getElementById('outputTaxRate').value) || 0) / 100,
                salesTaxRate: (parseFloat(document.getElementById('salesTaxRate').value) || 0) / 100,
                platformRate: (parseFloat(document.getElementById('platformRate').value) || 0) / 100,
                shippingCost: parseFloat(document.getElementById('shippingCost').value) || 0,
                shippingInsurance: parseFloat(document.getElementById('shippingInsurance').value) || 0,
                otherCost: parseFloat(document.getElementById('otherCost').value) || 0,
                returnRate: (parseFloat(document.getElementById('returnRate').value) || 0) / 100,
                finalPrice: parseFloat(document.getElementById('finalPrice').value) || 0
            };
        }

        function formatValue(value, decimals = 2) {
            if (!isFinite(value)) return value === Infinity ? '∞' : '-';
            if (isNaN(value)) return '-';
            return Number(value).toFixed(decimals);
        }

        function formatPercentage(value, decimals = 2) {
            if (!isFinite(value)) return value === Infinity ? '∞' : '-';
            if (isNaN(value)) return '-';
            return (Number(value) * 100).toFixed(decimals) + '%';
        }

        function displayResults(containerId, results, title) {
            const container = document.getElementById(containerId);
            
            const html = `
                <div class="result-row">
                    <span>保本广告占比:</span>
                    <span class="result-value">${formatPercentage(results.breakevenAdRate)}</span>
                </div>
                <div class="result-row">
                    <span>保本ROI:</span>
                    <span class="result-value">${formatValue(results.breakevenROI)}</span>
                </div>
                <div class="result-row">
                    <span>可行性:</span>
                    <span class="result-value">${results.feasible ? '✅ 可行' : '❌ 不可行'}</span>
                </div>
                <div class="result-row">
                    <span>备注:</span>
                    <span class="result-value">${results.note || '正常'}</span>
                </div>
                ${results.debug ? `
                <div class="debug-info">
                    <strong>调试信息:</strong><br>
                    有效销售率: ${formatPercentage(results.debug.effectiveSalesRate)}<br>
                    实际进货成本: ${formatValue(results.debug.effectiveCost)}<br>
                    固定成本分摊: ${formatValue(results.debug.fixedCosts)}<br>
                    B值: ${formatValue(results.debug.B)}<br>
                    D值: ${formatValue(results.debug.D)}<br>
                    Term: ${formatValue(results.debug.term)}
                </div>
                ` : ''}
            `;
            
            container.innerHTML = html;
        }

        function compareResults(priceHtmlResult, calculatorResult) {
            const adRateMatch = Math.abs((priceHtmlResult.breakevenAdRate || 0) - (calculatorResult.breakevenAdRate || 0)) < 0.00001;
            const roiMatch = Math.abs((priceHtmlResult.breakevenROI || 0) - (calculatorResult.breakevenROI || 0)) < 0.01;
            
            const comparisonHtml = `
                <div class="result-row">
                    <span>保本广告占比对比:</span>
                    <span class="${adRateMatch ? 'match' : 'mismatch'}">
                        ${adRateMatch ? '✅ 一致' : '❌ 不一致'}
                        (差异: ${formatValue(Math.abs((priceHtmlResult.breakevenAdRate || 0) - (calculatorResult.breakevenAdRate || 0)) * 100, 6)}%)
                    </span>
                </div>
                <div class="result-row">
                    <span>保本ROI对比:</span>
                    <span class="${roiMatch ? 'match' : 'mismatch'}">
                        ${roiMatch ? '✅ 一致' : '❌ 不一致'}
                        (差异: ${formatValue(Math.abs((priceHtmlResult.breakevenROI || 0) - (calculatorResult.breakevenROI || 0)), 6)})
                    </span>
                </div>
                <div class="result-row">
                    <span>整体评估:</span>
                    <span class="${adRateMatch && roiMatch ? 'match' : 'mismatch'}">
                        ${adRateMatch && roiMatch ? '🎉 算法修复成功！' : '⚠️ 算法仍需调整'}
                    </span>
                </div>
            `;
            
            document.getElementById('comparisonContent').innerHTML = comparisonHtml;
        }

        function runComparison() {
            const params = getInputParams();
            
            // 使用 Price.html 电脑端算法
            const priceHtmlResult = calculateBreakevenROI_PriceHtml(params);
            
            // 使用修复后的 calculator.js 函数
            const calculatorResult = calculateBreakevenROI(params);
            
            // 显示结果
            displayResults('priceHtmlResults', priceHtmlResult, 'Price.html 电脑端');
            displayResults('calculatorResults', calculatorResult, '修复后的函数');
            
            // 对比分析
            compareResults(priceHtmlResult, calculatorResult);
            
            // 显示结果区域
            document.getElementById('resultsContainer').style.display = 'grid';
            document.getElementById('comparisonResults').style.display = 'block';
        }

        function runBatchTests() {
            const testCases = [
                // 测试用例1：标准场景
                { costPrice: 38, inputTaxRate: 6, outputTaxRate: 13, salesTaxRate: 13, platformRate: 5.5, shippingCost: 2.8, shippingInsurance: 1.5, otherCost: 2.5, returnRate: 20, finalPrice: 79 },
                // 测试用例2：高退货率
                { costPrice: 50, inputTaxRate: 6, outputTaxRate: 13, salesTaxRate: 13, platformRate: 8, shippingCost: 3, shippingInsurance: 2, otherCost: 3, returnRate: 40, finalPrice: 120 },
                // 测试用例3：低成本高售价
                { costPrice: 20, inputTaxRate: 3, outputTaxRate: 9, salesTaxRate: 13, platformRate: 3, shippingCost: 1, shippingInsurance: 1, otherCost: 1, returnRate: 15, finalPrice: 100 },
                // 测试用例4：边界情况
                { costPrice: 80, inputTaxRate: 10, outputTaxRate: 13, salesTaxRate: 13, platformRate: 10, shippingCost: 5, shippingInsurance: 3, otherCost: 4, returnRate: 30, finalPrice: 100 }
            ];

            let passedTests = 0;
            let totalTests = testCases.length;
            let resultsHtml = '<h4>批量测试结果</h4>';

            testCases.forEach((testCase, index) => {
                // 转换参数为小数形式
                const params = {
                    costPrice: testCase.costPrice,
                    inputTaxRate: testCase.inputTaxRate / 100,
                    outputTaxRate: testCase.outputTaxRate / 100,
                    salesTaxRate: testCase.salesTaxRate / 100,
                    platformRate: testCase.platformRate / 100,
                    shippingCost: testCase.shippingCost,
                    shippingInsurance: testCase.shippingInsurance,
                    otherCost: testCase.otherCost,
                    returnRate: testCase.returnRate / 100,
                    finalPrice: testCase.finalPrice
                };

                const priceHtmlResult = calculateBreakevenROI_PriceHtml(params);
                const calculatorResult = calculateBreakevenROI(params);

                const adRateMatch = Math.abs((priceHtmlResult.breakevenAdRate || 0) - (calculatorResult.breakevenAdRate || 0)) < 0.00001;
                const roiMatch = Math.abs((priceHtmlResult.breakevenROI || 0) - (calculatorResult.breakevenROI || 0)) < 0.01;
                const testPassed = adRateMatch && roiMatch;

                if (testPassed) passedTests++;

                resultsHtml += `
                    <div class="result-row">
                        <span>测试用例 ${index + 1}:</span>
                        <span class="${testPassed ? 'match' : 'mismatch'}">
                            ${testPassed ? '✅ 通过' : '❌ 失败'}
                        </span>
                    </div>
                `;
            });

            resultsHtml += `
                <div class="result-row">
                    <span><strong>总体结果:</strong></span>
                    <span class="${passedTests === totalTests ? 'match' : 'mismatch'}">
                        ${passedTests}/${totalTests} 通过 ${passedTests === totalTests ? '🎉' : '⚠️'}
                    </span>
                </div>
            `;

            document.getElementById('comparisonContent').innerHTML = resultsHtml;
            document.getElementById('comparisonResults').style.display = 'block';
        }

        function loadDefaultParams() {
            // 加载默认测试参数
            document.getElementById('costPrice').value = '38';
            document.getElementById('inputTaxRate').value = '6';
            document.getElementById('outputTaxRate').value = '13';
            document.getElementById('salesTaxRate').value = '13';
            document.getElementById('platformRate').value = '5.5';
            document.getElementById('shippingCost').value = '2.8';
            document.getElementById('shippingInsurance').value = '1.5';
            document.getElementById('otherCost').value = '2.5';
            document.getElementById('returnRate').value = '20';
            document.getElementById('finalPrice').value = '79';
        }
    </script>
</body>
</html>