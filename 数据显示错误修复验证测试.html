<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ˜¾ç¤ºé”™è¯¯ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-params {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .param-group {
            display: flex;
            flex-direction: column;
        }
        .param-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .param-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-button {
            background: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #e9ecef;
        }
        .result-card h3 {
            margin-top: 0;
            color: #495057;
        }
        .result-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .result-row:last-child {
            border-bottom: none;
        }
        .result-value {
            font-weight: bold;
        }
        .match {
            color: #28a745;
            background: #d4edda;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .mismatch {
            color: #dc3545;
            background: #f8d7da;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .comparison {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .debug-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ•°æ®æ˜¾ç¤ºé”™è¯¯ä¿®å¤éªŒè¯æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºéªŒè¯ä¿®å¤åçš„ <code>calculateBreakevenROI</code> å‡½æ•°æ˜¯å¦ä¸ price.html ç”µè„‘ç«¯çš„è®¡ç®—ç»“æœä¸€è‡´ã€‚</p>
        
        <h2>æµ‹è¯•å‚æ•°</h2>
        <div class="test-params">
            <div class="param-group">
                <label>è¿›è´§ä»·ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="costPrice" value="38" step="0.01">
            </div>
            <div class="param-group">
                <label>å¼€ç¥¨æˆæœ¬æ¯”ä¾‹ï¼ˆ%ï¼‰</label>
                <input type="number" id="inputTaxRate" value="6" step="0.1">
            </div>
            <div class="param-group">
                <label>å•†å“è¿›é¡¹ç¨ç‡ï¼ˆ%ï¼‰</label>
                <input type="number" id="outputTaxRate" value="13" step="0.1">
            </div>
            <div class="param-group">
                <label>é”€é¡¹ç¨ç‡ï¼ˆ%ï¼‰</label>
                <input type="number" id="salesTaxRate" value="13" step="0.1">
            </div>
            <div class="param-group">
                <label>å¹³å°ä½£é‡‘ï¼ˆ%ï¼‰</label>
                <input type="number" id="platformRate" value="5.5" step="0.1">
            </div>
            <div class="param-group">
                <label>ç‰©æµè´¹ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="shippingCost" value="2.8" step="0.01">
            </div>
            <div class="param-group">
                <label>è¿è´¹é™©ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="shippingInsurance" value="1.5" step="0.01">
            </div>
            <div class="param-group">
                <label>å…¶ä»–æˆæœ¬ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="otherCost" value="2.5" step="0.01">
            </div>
            <div class="param-group">
                <label>é€€è´§ç‡ï¼ˆ%ï¼‰</label>
                <input type="number" id="returnRate" value="20" step="1">
            </div>
            <div class="param-group">
                <label>å«ç¨å”®ä»·ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="finalPrice" value="79" step="0.01">
            </div>
        </div>
        
        <button class="test-button" onclick="runComparison()">ğŸ§ª è¿è¡Œå¯¹æ¯”æµ‹è¯•</button>
        <button class="test-button" onclick="runBatchTests()">ğŸ”„ è¿è¡Œæ‰¹é‡æµ‹è¯•</button>
        <button class="test-button" onclick="loadDefaultParams()">ğŸ“‹ åŠ è½½é»˜è®¤å‚æ•°</button>
    </div>

    <div class="results-container" id="resultsContainer" style="display: none;">
        <div class="result-card">
            <h3>ğŸ¯ Price.html ç”µè„‘ç«¯ç®—æ³•ï¼ˆæ­£ç¡®æ ‡å‡†ï¼‰</h3>
            <div id="priceHtmlResults"></div>
        </div>
        <div class="result-card">
            <h3>ğŸ”§ ä¿®å¤åçš„ calculateBreakevenROI å‡½æ•°</h3>
            <div id="calculatorResults"></div>
        </div>
    </div>

    <div class="comparison" id="comparisonResults" style="display: none;">
        <h3>ğŸ“Š å¯¹æ¯”åˆ†æç»“æœ</h3>
        <div id="comparisonContent"></div>
    </div>

    <script src="js/calculator.js"></script>
    <script>
        // Price.html ç”µè„‘ç«¯çš„æ­£ç¡®ç®—æ³•å®ç°
        function calculateBreakevenROI_PriceHtml(params) {
            try {
                const {
                    costPrice,
                    inputTaxRate,
                    outputTaxRate,
                    salesTaxRate,
                    platformRate,
                    shippingCost,
                    shippingInsurance,
                    otherCost,
                    returnRate,
                    finalPrice
                } = params;

                // Price.html ç”µè„‘ç«¯çš„ç®—æ³•é€»è¾‘
                const effectiveSalesRate = 1 - returnRate;
                const effectiveCost = costPrice + (costPrice * inputTaxRate);
                const fixedCosts = (shippingCost + shippingInsurance + otherCost) / effectiveSalesRate;
                
                const t = salesTaxRate;
                const taxFactorOnFinal = t / (1 + t);
                const B = effectiveCost + fixedCosts;
                
                const v = 0.06;
                const platformVatCredit = (platformRate / (1 + v)) * v;
                const D = 1 - platformRate - taxFactorOnFinal + platformVatCredit;

                const term = D - (B / finalPrice);
                const breakevenAdRate = (effectiveSalesRate / (1 - v/(1 + v))) * term;

                let breakevenROI;
                if (breakevenAdRate <= 0) {
                    breakevenROI = Infinity;
                } else if (!isFinite(breakevenAdRate) || breakevenAdRate >= 1) {
                    breakevenROI = NaN;
                } else {
                    breakevenROI = effectiveSalesRate / breakevenAdRate;
                }

                return {
                    breakevenAdRate,
                    breakevenROI,
                    feasible: isFinite(breakevenROI) && breakevenROI > 0,
                    note: breakevenAdRate <= 0 ? 'æ— éœ€å¹¿å‘Šä¹Ÿèƒ½ä¿æœ¬' : 
                          breakevenAdRate >= 1 ? 'ä¸ç°å®ï¼šéœ€å¹¿å‘Šå æ¯”â‰¥100%' : '',
                    debug: {
                        effectiveSalesRate,
                        effectiveCost,
                        fixedCosts,
                        B,
                        D,
                        term,
                        v,
                        taxFactorOnFinal,
                        platformVatCredit
                    }
                };
            } catch (error) {
                return {
                    breakevenAdRate: NaN,
                    breakevenROI: NaN,
                    feasible: false,
                    note: 'è®¡ç®—å¤±è´¥: ' + error.message
                };
            }
        }

        function getInputParams() {
            return {
                costPrice: parseFloat(document.getElementById('costPrice').value) || 0,
                inputTaxRate: (parseFloat(document.getElementById('inputTaxRate').value) || 0) / 100,
                outputTaxRate: (parseFloat(document.getElementById('outputTaxRate').value) || 0) / 100,
                salesTaxRate: (parseFloat(document.getElementById('salesTaxRate').value) || 0) / 100,
                platformRate: (parseFloat(document.getElementById('platformRate').value) || 0) / 100,
                shippingCost: parseFloat(document.getElementById('shippingCost').value) || 0,
                shippingInsurance: parseFloat(document.getElementById('shippingInsurance').value) || 0,
                otherCost: parseFloat(document.getElementById('otherCost').value) || 0,
                returnRate: (parseFloat(document.getElementById('returnRate').value) || 0) / 100,
                finalPrice: parseFloat(document.getElementById('finalPrice').value) || 0
            };
        }

        function formatValue(value, decimals = 2) {
            if (!isFinite(value)) return value === Infinity ? 'âˆ' : '-';
            if (isNaN(value)) return '-';
            return Number(value).toFixed(decimals);
        }

        function formatPercentage(value, decimals = 2) {
            if (!isFinite(value)) return value === Infinity ? 'âˆ' : '-';
            if (isNaN(value)) return '-';
            return (Number(value) * 100).toFixed(decimals) + '%';
        }

        function displayResults(containerId, results, title) {
            const container = document.getElementById(containerId);
            
            const html = `
                <div class="result-row">
                    <span>ä¿æœ¬å¹¿å‘Šå æ¯”:</span>
                    <span class="result-value">${formatPercentage(results.breakevenAdRate)}</span>
                </div>
                <div class="result-row">
                    <span>ä¿æœ¬ROI:</span>
                    <span class="result-value">${formatValue(results.breakevenROI)}</span>
                </div>
                <div class="result-row">
                    <span>å¯è¡Œæ€§:</span>
                    <span class="result-value">${results.feasible ? 'âœ… å¯è¡Œ' : 'âŒ ä¸å¯è¡Œ'}</span>
                </div>
                <div class="result-row">
                    <span>å¤‡æ³¨:</span>
                    <span class="result-value">${results.note || 'æ­£å¸¸'}</span>
                </div>
                ${results.debug ? `
                <div class="debug-info">
                    <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                    æœ‰æ•ˆé”€å”®ç‡: ${formatPercentage(results.debug.effectiveSalesRate)}<br>
                    å®é™…è¿›è´§æˆæœ¬: ${formatValue(results.debug.effectiveCost)}<br>
                    å›ºå®šæˆæœ¬åˆ†æ‘Š: ${formatValue(results.debug.fixedCosts)}<br>
                    Bå€¼: ${formatValue(results.debug.B)}<br>
                    Då€¼: ${formatValue(results.debug.D)}<br>
                    Term: ${formatValue(results.debug.term)}
                </div>
                ` : ''}
            `;
            
            container.innerHTML = html;
        }

        function compareResults(priceHtmlResult, calculatorResult) {
            const adRateMatch = Math.abs((priceHtmlResult.breakevenAdRate || 0) - (calculatorResult.breakevenAdRate || 0)) < 0.00001;
            const roiMatch = Math.abs((priceHtmlResult.breakevenROI || 0) - (calculatorResult.breakevenROI || 0)) < 0.01;
            
            const comparisonHtml = `
                <div class="result-row">
                    <span>ä¿æœ¬å¹¿å‘Šå æ¯”å¯¹æ¯”:</span>
                    <span class="${adRateMatch ? 'match' : 'mismatch'}">
                        ${adRateMatch ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}
                        (å·®å¼‚: ${formatValue(Math.abs((priceHtmlResult.breakevenAdRate || 0) - (calculatorResult.breakevenAdRate || 0)) * 100, 6)}%)
                    </span>
                </div>
                <div class="result-row">
                    <span>ä¿æœ¬ROIå¯¹æ¯”:</span>
                    <span class="${roiMatch ? 'match' : 'mismatch'}">
                        ${roiMatch ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}
                        (å·®å¼‚: ${formatValue(Math.abs((priceHtmlResult.breakevenROI || 0) - (calculatorResult.breakevenROI || 0)), 6)})
                    </span>
                </div>
                <div class="result-row">
                    <span>æ•´ä½“è¯„ä¼°:</span>
                    <span class="${adRateMatch && roiMatch ? 'match' : 'mismatch'}">
                        ${adRateMatch && roiMatch ? 'ğŸ‰ ç®—æ³•ä¿®å¤æˆåŠŸï¼' : 'âš ï¸ ç®—æ³•ä»éœ€è°ƒæ•´'}
                    </span>
                </div>
            `;
            
            document.getElementById('comparisonContent').innerHTML = comparisonHtml;
        }

        function runComparison() {
            const params = getInputParams();
            
            // ä½¿ç”¨ Price.html ç”µè„‘ç«¯ç®—æ³•
            const priceHtmlResult = calculateBreakevenROI_PriceHtml(params);
            
            // ä½¿ç”¨ä¿®å¤åçš„ calculator.js å‡½æ•°
            const calculatorResult = calculateBreakevenROI(params);
            
            // æ˜¾ç¤ºç»“æœ
            displayResults('priceHtmlResults', priceHtmlResult, 'Price.html ç”µè„‘ç«¯');
            displayResults('calculatorResults', calculatorResult, 'ä¿®å¤åçš„å‡½æ•°');
            
            // å¯¹æ¯”åˆ†æ
            compareResults(priceHtmlResult, calculatorResult);
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultsContainer').style.display = 'grid';
            document.getElementById('comparisonResults').style.display = 'block';
        }

        function runBatchTests() {
            const testCases = [
                // æµ‹è¯•ç”¨ä¾‹1ï¼šæ ‡å‡†åœºæ™¯
                { costPrice: 38, inputTaxRate: 6, outputTaxRate: 13, salesTaxRate: 13, platformRate: 5.5, shippingCost: 2.8, shippingInsurance: 1.5, otherCost: 2.5, returnRate: 20, finalPrice: 79 },
                // æµ‹è¯•ç”¨ä¾‹2ï¼šé«˜é€€è´§ç‡
                { costPrice: 50, inputTaxRate: 6, outputTaxRate: 13, salesTaxRate: 13, platformRate: 8, shippingCost: 3, shippingInsurance: 2, otherCost: 3, returnRate: 40, finalPrice: 120 },
                // æµ‹è¯•ç”¨ä¾‹3ï¼šä½æˆæœ¬é«˜å”®ä»·
                { costPrice: 20, inputTaxRate: 3, outputTaxRate: 9, salesTaxRate: 13, platformRate: 3, shippingCost: 1, shippingInsurance: 1, otherCost: 1, returnRate: 15, finalPrice: 100 },
                // æµ‹è¯•ç”¨ä¾‹4ï¼šè¾¹ç•Œæƒ…å†µ
                { costPrice: 80, inputTaxRate: 10, outputTaxRate: 13, salesTaxRate: 13, platformRate: 10, shippingCost: 5, shippingInsurance: 3, otherCost: 4, returnRate: 30, finalPrice: 100 }
            ];

            let passedTests = 0;
            let totalTests = testCases.length;
            let resultsHtml = '<h4>æ‰¹é‡æµ‹è¯•ç»“æœ</h4>';

            testCases.forEach((testCase, index) => {
                // è½¬æ¢å‚æ•°ä¸ºå°æ•°å½¢å¼
                const params = {
                    costPrice: testCase.costPrice,
                    inputTaxRate: testCase.inputTaxRate / 100,
                    outputTaxRate: testCase.outputTaxRate / 100,
                    salesTaxRate: testCase.salesTaxRate / 100,
                    platformRate: testCase.platformRate / 100,
                    shippingCost: testCase.shippingCost,
                    shippingInsurance: testCase.shippingInsurance,
                    otherCost: testCase.otherCost,
                    returnRate: testCase.returnRate / 100,
                    finalPrice: testCase.finalPrice
                };

                const priceHtmlResult = calculateBreakevenROI_PriceHtml(params);
                const calculatorResult = calculateBreakevenROI(params);

                const adRateMatch = Math.abs((priceHtmlResult.breakevenAdRate || 0) - (calculatorResult.breakevenAdRate || 0)) < 0.00001;
                const roiMatch = Math.abs((priceHtmlResult.breakevenROI || 0) - (calculatorResult.breakevenROI || 0)) < 0.01;
                const testPassed = adRateMatch && roiMatch;

                if (testPassed) passedTests++;

                resultsHtml += `
                    <div class="result-row">
                        <span>æµ‹è¯•ç”¨ä¾‹ ${index + 1}:</span>
                        <span class="${testPassed ? 'match' : 'mismatch'}">
                            ${testPassed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                        </span>
                    </div>
                `;
            });

            resultsHtml += `
                <div class="result-row">
                    <span><strong>æ€»ä½“ç»“æœ:</strong></span>
                    <span class="${passedTests === totalTests ? 'match' : 'mismatch'}">
                        ${passedTests}/${totalTests} é€šè¿‡ ${passedTests === totalTests ? 'ğŸ‰' : 'âš ï¸'}
                    </span>
                </div>
            `;

            document.getElementById('comparisonContent').innerHTML = resultsHtml;
            document.getElementById('comparisonResults').style.display = 'block';
        }

        function loadDefaultParams() {
            // åŠ è½½é»˜è®¤æµ‹è¯•å‚æ•°
            document.getElementById('costPrice').value = '38';
            document.getElementById('inputTaxRate').value = '6';
            document.getElementById('outputTaxRate').value = '13';
            document.getElementById('salesTaxRate').value = '13';
            document.getElementById('platformRate').value = '5.5';
            document.getElementById('shippingCost').value = '2.8';
            document.getElementById('shippingInsurance').value = '1.5';
            document.getElementById('otherCost').value = '2.5';
            document.getElementById('returnRate').value = '20';
            document.getElementById('finalPrice').value = '79';
        }
    </script>
</body>
</html>