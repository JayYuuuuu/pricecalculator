# 毛利润与加价倍率口径统一修复说明

## 问题描述

原系统中"毛利润"与"加价倍率"的比较基准不一致，这会让使用者误解毛利水平：

### 修复前的问题
- **毛利润**：(含税售价 − 不含税进价) / 含税售价
- **加价倍率**：含税售价 / 不含税进价

两者基准一个含税、一个不含税，计算口径不统一。

## 修复方案

统一为**含税口径**，使用"进货实际成本"作为基准：

### 修复后的计算方式
- **加价倍率**：P / (C + C×α) = 含税售价 ÷ 进货实际成本
- **毛利润**：(P − (C + C×α)) / P = (含税售价 - 进货实际成本) ÷ 含税售价

其中：
- P = 含税售价
- C = 不含税进价
- α = 开票成本率
- C + C×α = 进货实际成本（含税）

## 修复范围

### 1. 主要计算器 (js/calculator.js)

#### 修复位置：利润计算函数
```javascript
// 修复前
const metricMultiple = (actualPrice / costPrice).toFixed(2); // 进货倍率 = 售价 ÷ 进货价
const metricGrossMargin = (((actualPrice - costPrice) / actualPrice) * 100).toFixed(2) + '%'; // 毛利率

// 修复后
// 计算进货实际成本（含税）
const effectiveCost = costPrice + invoiceCost; // 进货价 + 开票费用

// 加价倍率：含税售价 ÷ 进货实际成本（含税）
const metricMultiple = (actualPrice / effectiveCost).toFixed(2); // 加价倍率 = 含税售价 ÷ 进货实际成本

// 毛利率：(含税售价 - 进货实际成本) ÷ 含税售价
const metricGrossMargin = (((actualPrice - effectiveCost) / actualPrice) * 100).toFixed(2) + '%'; // 毛利率（基于含税口径）
```

#### 修复位置：批量推演矩阵
```javascript
// 修复前
const markup = (base.costPrice > 0 && base.actualPrice > 0) ? (base.actualPrice / base.costPrice) : NaN;
const grossMargin = (base.actualPrice > 0 && base.costPrice > 0) ? ((base.actualPrice - base.costPrice) / base.actualPrice) : NaN;

// 修复后
// 计算进货实际成本（含税）
const baseCost = base.costPrice + (base.costPrice * base.inputTaxRate / 100); // 进货价 + 开票费用

const markup = (baseCost > 0 && base.actualPrice > 0) ? (base.actualPrice / baseCost) : NaN;
const grossMargin = (baseCost > 0 && base.actualPrice > 0) ? ((base.actualPrice - baseCost) / base.actualPrice) : NaN;
```

### 2. 简化版计算器 (simple-profit-calculator.html)

#### 修复位置：主计算函数
```javascript
// 修复前
const markupRatio = (sellingPrice / costPrice).toFixed(2); // 加价倍率（基于不含税进价）
const grossMargin = (((sellingPrice - costPrice) / sellingPrice) * 100).toFixed(2); // 毛利率（基于不含税进价）

// 修复后
// 计算基础指标（基于含税口径）
// 计算进货实际成本（含税）
const baseCost = costPrice + actualInvoiceCost; // 进货价 + 开票费用

// 加价倍率：含税售价 ÷ 进货实际成本（含税）
const markupRatio = (sellingPrice / baseCost).toFixed(2); // 加价倍率 = 含税售价 ÷ 进货实际成本

// 毛利率：(含税售价 - 进货实际成本) ÷ 含税售价
const grossMargin = (((sellingPrice - baseCost) / sellingPrice) * 100).toFixed(2); // 毛利率（基于含税口径）
```

### 3. 价格计算器 (price.html)

#### 修复位置：基础指标计算
```javascript
// 修复前
const markupRatio = (sellingPrice / costPrice).toFixed(2); // 加价倍率（基于不含税进价）
const grossMargin = (((sellingPrice - costPrice) / sellingPrice) * 100).toFixed(2); // 毛利率（基于不含税进价）

// 修复后
// 计算基础指标（基于含税口径）
// 计算进货实际成本（含税）
const baseCost = costPrice + actualInvoiceCost; // 进货价 + 开票费用

// 加价倍率：含税售价 ÷ 进货实际成本（含税）
const markupRatio = (sellingPrice / baseCost).toFixed(2); // 加价倍率 = 含税售价 ÷ 进货实际成本

// 毛利率：(含税售价 - 进货实际成本) ÷ 含税售价
const grossMargin = (((sellingPrice - baseCost) / sellingPrice) * 100).toFixed(2); // 毛利率（基于含税口径）
```

### 4. 界面提示信息更新

#### 修复位置：index.html
```html
<!-- 修复前 -->
<h3>价格指标（基于进货价与含税售价）</h3>
<div style="color:#999; font-size:0.8rem; margin-top:2px;">售价÷进货价</div>
<div style="color:#999; font-size:0.8rem; margin-top:2px;">(售价-进货价)÷售价</div>

<!-- 修复后 -->
<h3>价格指标（基于含税口径）</h3>
<div style="color:#999; font-size:0.8rem; margin-top:2px;">售价÷进货实际成本</div>
<div style="color:#999; font-size:0.8rem; margin-top:2px;">(售价-进货实际成本)÷售价</div>
```

#### 修复位置：js/calculator.js
```javascript
// 修复前
title="毛利率 = (实际售价 − 进货价) ÷ 实际售价"

// 修复后
title="毛利率 = (实际售价 − 进货实际成本) ÷ 实际售价"
```

## 修复影响

### 1. 计算准确性提升
- **加价倍率**：将略微变小（因为分母从不含税进价变为含税进货实际成本）
- **毛利率**：将略微变小（因为分子从"售价-不含税进价"变为"售价-含税进货实际成本"）
- **计算逻辑**：更加合理和一致

### 2. 业务价值
- **口径统一**：毛利润和加价倍率都基于含税基准，避免误解
- **更直观**：使用"进货实际成本"作为基准，更符合实际业务场景
- **税务合规**：考虑了开票成本，计算更加准确

### 3. 用户体验
- **提示信息**：更新了界面提示，明确计算基准
- **一致性**：所有相关计算都使用相同的口径
- **透明度**：用户可以清楚了解计算逻辑

## 技术说明

### 修复原理
统一使用含税口径，确保所有价格指标的计算基准一致：

```
进货实际成本 = 不含税进价 + 开票费用
加价倍率 = 含税售价 ÷ 进货实际成本
毛利率 = (含税售价 - 进货实际成本) ÷ 含税售价
```

### 修复范围
- ✅ 主要计算器 (js/calculator.js)
- ✅ 简化版计算器 (simple-profit-calculator.html)
- ✅ 价格计算器 (price.html)
- ✅ 界面提示信息 (index.html)

## 验证建议

1. **功能测试**：验证修复后的计算器功能正常
2. **数值验证**：对比修复前后的计算结果差异
3. **口径一致性**：确认毛利润和加价倍率使用相同基准
4. **用户体验**：确保界面提示信息清晰准确

## 总结

本次修复解决了系统中毛利润与加价倍率计算基准不一致的问题，统一为含税口径，使用"进货实际成本"作为基准。修复涉及多个文件，确保了系统的一致性和完整性。修复后的系统将提供更准确、更一致的价格指标计算，有助于用户正确理解和使用这些指标。
